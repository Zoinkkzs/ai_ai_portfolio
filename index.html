<!DOCTYPE html>
<html lang="en" class="dark scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh Huy - Portfolio</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />

    <!-- React Dependencies (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Three.js Dependencies -->
    <script crossorigin src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script crossorigin src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#06bcf9", // Neon Blue
                        "secondary": "#a855f7", // Neon Purple
                        "background-light": "#f5f8f8",
                        "background-dark": "#0a1116", // Deep navy/midnight start
                        "void": "#020204", // Deep space black
                        "surface-dark": "#111820",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "sans": ["Space Grotesk", "sans-serif"],
                    },
                    backgroundImage: {
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                    },
                    boxShadow: {
                        "neon": "0 0 15px rgba(6, 188, 249, 0.3)",
                        "neon-hover": "0 0 25px rgba(6, 188, 249, 0.5)",
                        "neon-purple": "0 0 15px rgba(168, 85, 247, 0.3)",
                        "neon-purple-hover": "0 0 25px rgba(168, 85, 247, 0.6)",
                    }
                },
            },
        }
    </script>
    <style>
        .range-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
        }
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #06bcf9;
            cursor: pointer;
            box-shadow: 0 0 10px #06bcf9;
            transition: all 0.2s;
        }
        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #fff;
            box-shadow: 0 0 15px #fff, 0 0 30px #06bcf9;
        }
        
        .molecule-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .molecule-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .molecule-scroll::-webkit-scrollbar-thumb {
            background: #06bcf9;
            border-radius: 3px;
        }
        
        .particle-input {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            color: #06bcf9;
            font-family: monospace;
            padding: 4px 8px;
            width: 80px;
            font-size: 0.8rem;
            transition: all 0.2s;
            text-align: center;
        }
        .particle-input:focus {
            outline: none;
            border-color: #06bcf9;
            background: rgba(6, 188, 249, 0.1);
        }
        .equation-input {
            background: transparent;
            border-bottom: 2px solid #334155;
            color: white;
            text-align: center;
            font-family: 'Space Grotesk', monospace;
            transition: border-color 0.2s;
        }
        .equation-input:focus {
            outline: none;
            border-color: #06bcf9;
        }
        /* Custom Checkbox */
        .checkbox-wrapper input:checked + div {
            background-color: #06bcf9;
            border-color: #06bcf9;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }
        
        /* Utility for horizontal scroll hiding */
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #0a1116; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155; 
            border-radius: 3px;
        }
    </style>
  </head>
  <body class="bg-background-light dark:bg-background-dark text-[#101e23] dark:text-white antialiased selection:bg-secondary selection:text-white font-display">
    <div id="root"></div>

    <!-- Main Application Logic -->
    <script type="text/babel">
      const { useState, useEffect, useRef, useMemo, useCallback } = React;

      // --- Sound System Hook ---
      const useSound = () => {
          const audioCtxRef = useRef(null);
          const lastSlideTime = useRef(0);

          const initAudio = () => {
              if (!audioCtxRef.current) {
                  const AudioContext = window.AudioContext || window.webkitAudioContext;
                  audioCtxRef.current = new AudioContext();
              }
              if (audioCtxRef.current.state === 'suspended') {
                  audioCtxRef.current.resume();
              }
              return audioCtxRef.current;
          };

          const playClick = useCallback(() => {
              const ctx = initAudio();
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.connect(gain);
              gain.connect(ctx.destination);
              
              osc.type = 'sine';
              osc.frequency.setValueAtTime(800, ctx.currentTime);
              osc.frequency.exponentialRampToValueAtTime(1200, ctx.currentTime + 0.05);
              
              gain.gain.setValueAtTime(0.1, ctx.currentTime);
              gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.05);
              
              osc.start();
              osc.stop(ctx.currentTime + 0.05);
          }, []);

          const playSlide = useCallback(() => {
              const now = Date.now();
              if (now - lastSlideTime.current < 50) return; // Throttle
              lastSlideTime.current = now;

              const ctx = initAudio();
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.connect(gain);
              gain.connect(ctx.destination);
              
              osc.type = 'triangle';
              osc.frequency.setValueAtTime(200, ctx.currentTime);
              
              gain.gain.setValueAtTime(0.05, ctx.currentTime);
              gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.03);
              
              osc.start();
              osc.stop(ctx.currentTime + 0.03);
          }, []);

          const playDecay = useCallback(() => {
              const ctx = initAudio();
              const t = ctx.currentTime;
              
              // Low frequency rumble/explosion
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              const filter = ctx.createBiquadFilter();
              
              osc.type = 'sawtooth';
              osc.frequency.setValueAtTime(100, t);
              osc.frequency.exponentialRampToValueAtTime(20, t + 0.5);
              
              filter.type = 'lowpass';
              filter.frequency.setValueAtTime(1000, t);
              filter.frequency.exponentialRampToValueAtTime(100, t + 0.4);
              
              gain.gain.setValueAtTime(0.3, t);
              gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
              
              osc.connect(filter);
              filter.connect(gain);
              gain.connect(ctx.destination);
              
              osc.start();
              osc.stop(t + 0.5);

              // High frequency zap
              const osc2 = ctx.createOscillator();
              const gain2 = ctx.createGain();
              osc2.type = 'square';
              osc2.frequency.setValueAtTime(800, t);
              osc2.frequency.exponentialRampToValueAtTime(100, t + 0.2);
              gain2.gain.setValueAtTime(0.05, t);
              gain2.gain.exponentialRampToValueAtTime(0.001, t + 0.2);
              osc2.connect(gain2);
              gain2.connect(ctx.destination);
              osc2.start();
              osc2.stop(t + 0.2);
          }, []);

          const playEscape = useCallback(() => {
              const ctx = initAudio();
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              osc.connect(gain);
              gain.connect(ctx.destination);
              
              osc.type = 'sine';
              osc.frequency.setValueAtTime(300, ctx.currentTime);
              osc.frequency.exponentialRampToValueAtTime(50, ctx.currentTime + 0.2);
              
              gain.gain.setValueAtTime(0.1, ctx.currentTime);
              gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.2);
              
              osc.start();
              osc.stop(ctx.currentTime + 0.2);
          }, []);

          const playExcite = useCallback(() => {
              const ctx = initAudio();
              const t = ctx.currentTime;
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              
              osc.type = 'triangle';
              osc.frequency.setValueAtTime(200, t);
              osc.frequency.linearRampToValueAtTime(600, t + 0.3);
              
              gain.gain.setValueAtTime(0.1, t);
              gain.gain.linearRampToValueAtTime(0, t + 0.3);
              
              osc.connect(gain);
              gain.connect(ctx.destination);
              osc.start();
              osc.stop(t + 0.3);
          }, []);

          const playPhoton = useCallback((wavelength) => {
              const ctx = initAudio();
              const t = ctx.currentTime;
              const osc = ctx.createOscillator();
              const gain = ctx.createGain();
              
              // Map wavelength (approx 100nm to 7000nm) to audible frequency (high to low)
              // Lower wavelength (higher energy) = Higher pitch
              const freq = Math.max(100, Math.min(2000, 300000 / wavelength)); 
              
              osc.type = 'sine';
              osc.frequency.setValueAtTime(freq, t);
              osc.frequency.exponentialRampToValueAtTime(freq * 0.8, t + 0.5);
              
              gain.gain.setValueAtTime(0.15, t);
              gain.gain.exponentialRampToValueAtTime(0.001, t + 0.5);
              
              osc.connect(gain);
              gain.connect(ctx.destination);
              osc.start();
              osc.stop(t + 0.5);
          }, []);

          return { playClick, playSlide, playDecay, playEscape, playExcite, playPhoton };
      };

      // --- Constants & Types ---
      const PROFILE_AVATAR = `https://littleastronomy.com/wp-content/uploads/2023/01/what-are-pulsars-and-how-are-they-formed.jpg`;
      const NAV_ITEMS = [ { label: 'Home', href: '#home' }, { label: 'Work', href: '#projects' }, { label: 'About', href: '#about' }, { label: 'Contact', href: '#contact' } ];
      const PROJECTS = [ 
          { id: 'decay', title: 'Decay Challenge', category: 'Nuclear Physics', description: 'Interactive nuclear decay simulator. Balance equations and visualize alpha, beta, and gamma radiation in 3D.', image: 'https://images.unsplash.com/photo-1618557219587-5743b0ba4e06?q=80&w=1000&auto=format&fit=crop', tags: ['React', 'Three.js'], color: 'secondary' }, 
          { id: 'hydrogen', title: 'Hydrogen Spectrum', category: 'Quantum Mechanics', description: 'Bohr model simulation. Excite the electron and observe photon emission lines (Lyman, Balmer, Paschen, Brackett).', image: 'https://images.unsplash.com/photo-1532094349884-543bc11b234d?q=80&w=1000&auto=format&fit=crop', tags: ['Canvas', 'Physics'], color: 'primary' },
          { id: 'young', title: 'Young\'s Experiment', category: 'Quantum Optics', description: 'Double-slit wave interference simulation. Explore the duality of light with real-time fringe pattern calculations.', image: 'https://images.unsplash.com/photo-1506703719100-a0f3a48c0f86?q=80&w=1000&auto=format&fit=crop', tags: ['Canvas', 'Physics'], color: 'primary' },
          { id: 'molecular', title: 'Molecular Bonds', category: 'Chemistry', description: 'Educational platform featuring minimalist 3D structure and covalent bond visualizations.', image: 'https://images.unsplash.com/photo-1628595351029-c2bf17511435?q=80&w=1000&auto=format&fit=crop', tags: ['WebGL', 'D3.js'], color: 'primary' } 
      ];
      const TECH_STACK = [ { icon: 'terminal', title: 'Coding', desc: 'Lua, C++', color: 'text-primary' }, { icon: 'hexagon', title: 'Science', desc: 'Chem, Physics, Mathematics', color: 'text-secondary' }, { icon: 'database', title: 'Data', desc: 'Python, Java', color: 'text-secondary' }, { icon: 'palette', title: 'Other Skills', desc: 'Chess, Drawing', color: 'text-primary' } ];
      
      const ISOTOPES = [
        { name: "Carbon-14", symbol: "C", mass: 14, atomic: 6, type: "Beta Minus", product: { mass: 14, atomic: 7, symbol: "N" }, particles: ["β⁻", "ν̄"] },
        { name: "Tritium", symbol: "H", mass: 3, atomic: 1, type: "Beta Minus", product: { mass: 3, atomic: 2, symbol: "He" }, particles: ["β⁻", "ν̄"] },
        { name: "Potassium-40", symbol: "K", mass: 40, atomic: 19, type: "Beta Minus", product: { mass: 40, atomic: 20, symbol: "Ca" }, particles: ["β⁻", "ν̄"] },
        { name: "Uranium-238", symbol: "U", mass: 238, atomic: 92, type: "Alpha", product: { mass: 234, atomic: 90, symbol: "Th" }, particles: [] },
        { name: "Uranium-235", symbol: "U", mass: 235, atomic: 92, type: "Alpha", product: { mass: 231, atomic: 90, symbol: "Th" }, particles: [] },
        { name: "Thorium-232", symbol: "Th", mass: 232, atomic: 90, type: "Alpha", product: { mass: 228, atomic: 88, symbol: "Ra" }, particles: [] },
        { name: "Radium-226", symbol: "Ra", mass: 226, atomic: 88, type: "Alpha", product: { mass: 222, atomic: 86, symbol: "Rn" }, particles: [] },
        { name: "Radon-222", symbol: "Rn", mass: 222, atomic: 86, type: "Alpha", product: { mass: 218, atomic: 84, symbol: "Po" }, particles: [] },
        { name: "Polonium-210", symbol: "Po", mass: 210, atomic: 84, type: "Alpha", product: { mass: 206, atomic: 82, symbol: "Pb" }, particles: [] },
        { name: "Lead-210", symbol: "Pb", mass: 210, atomic: 82, type: "Beta Minus", product: { mass: 210, atomic: 83, symbol: "Bi" }, particles: ["β⁻", "ν̄"] },
        { name: "Iodine-131", symbol: "I", mass: 131, atomic: 53, type: "Beta Minus", product: { mass: 131, atomic: 54, symbol: "Xe" }, particles: ["β⁻", "ν̄"] },
        { name: "Technetium-99m", symbol: "Tc", mass: 99, atomic: 43, type: "Gamma", product: { mass: 99, atomic: 43, symbol: "Tc" }, particles: ["γ"] },
        { name: "Cobalt-60", symbol: "Co", mass: 60, atomic: 27, type: "Beta Minus", product: { mass: 60, atomic: 28, symbol: "Ni" }, particles: ["β⁻", "γ", "ν̄"] },
        { name: "Cesium-137", symbol: "Cs", mass: 137, atomic: 55, type: "Beta Minus", product: { mass: 137, atomic: 56, symbol: "Ba" }, particles: ["β⁻", "ν̄"] },
        { name: "Strontium-90", symbol: "Sr", mass: 90, atomic: 38, type: "Beta Minus", product: { mass: 90, atomic: 39, symbol: "Y" }, particles: ["β⁻", "ν̄"] },
        { name: "Americium-241", symbol: "Am", mass: 241, atomic: 95, type: "Alpha", product: { mass: 237, atomic: 93, symbol: "Np" }, particles: [] },
        { name: "Plutonium-239", symbol: "Pu", mass: 239, atomic: 94, type: "Alpha", product: { mass: 235, atomic: 92, symbol: "U" }, particles: [] },
        { name: "Neptunium-237", symbol: "Np", mass: 237, atomic: 93, type: "Alpha", product: { mass: 233, atomic: 91, symbol: "Pa" }, particles: [] },
        { name: "Krypton-85", symbol: "Kr", mass: 85, atomic: 36, type: "Beta Minus", product: { mass: 85, atomic: 37, symbol: "Rb" }, particles: ["β⁻", "ν̄"] },
        { name: "Sodium-24", symbol: "Na", mass: 24, atomic: 11, type: "Beta Minus", product: { mass: 24, atomic: 12, symbol: "Mg" }, particles: ["β⁻", "γ", "ν̄"] },
        { name: "Beryllium-7", symbol: "Be", mass: 7, atomic: 4, type: "Electron Capture", product: { mass: 7, atomic: 3, symbol: "Li" }, particles: ["ν"] },
        { name: "Rubidium-87", symbol: "Rb", mass: 87, atomic: 37, type: "Beta Minus", product: { mass: 87, atomic: 38, symbol: "Sr" }, particles: ["β⁻", "ν̄"] },
        { name: "Californium-252", symbol: "Cf", mass: 252, atomic: 98, type: "Alpha", product: { mass: 248, atomic: 96, symbol: "Cm" }, particles: [] },
        { name: "Oganesson-294", symbol: "Og", mass: 294, atomic: 118, type: "Alpha", product: { mass: 290, atomic: 116, symbol: "Lv" }, particles: [] }
      ];

      const SHELL_CONFIGS = {
        1: [1], 4: [2, 2], 6: [2, 4], 11: [2, 8, 1], 19: [2, 8, 8, 1], 
        27: [2, 8, 15, 2], 36: [2, 8, 18, 8], 37: [2, 8, 18, 8, 1], 
        38: [2, 8, 18, 8, 2], 43: [2, 8, 18, 13, 2], 53: [2, 8, 18, 18, 7], 
        55: [2, 8, 18, 18, 8, 1], 82: [2, 8, 18, 32, 18, 4], 84: [2, 8, 18, 32, 18, 6], 
        86: [2, 8, 18, 32, 18, 8], 88: [2, 8, 18, 32, 18, 8, 2], 90: [2, 8, 18, 32, 18, 10, 2], 
        92: [2, 8, 18, 32, 21, 9, 2], 93: [2, 8, 18, 32, 22, 9, 2], 94: [2, 8, 18, 32, 24, 8, 2], 
        95: [2, 8, 18, 32, 25, 8, 2], 98: [2, 8, 18, 32, 28, 8, 2], 118: [2, 8, 18, 32, 32, 18, 8]
      };

      const getElectronShells = (z) => {
          if (SHELL_CONFIGS[z]) return SHELL_CONFIGS[z];
          const shells = [];
          let remaining = z;
          const caps = [2, 8, 18, 32, 50, 72, 98];
          for(let cap of caps) {
              if (remaining <= 0) break;
              let take = Math.min(remaining, cap);
              shells.push(take);
              remaining -= take;
          }
          return shells;
      };

      const MOLECULES = {
        "Benzene": { atoms: [{id:0,el:"C",x:1.4,y:0,z:0},{id:1,el:"C",x:0.7,y:1.21,z:0},{id:2,el:"C",x:-0.7,y:1.21,z:0},{id:3,el:"C",x:-1.4,y:0,z:0},{id:4,el:"C",x:-0.7,y:-1.21,z:0},{id:5,el:"C",x:0.7,y:-1.21,z:0},{id:6,el:"H",x:2.4,y:0,z:0},{id:7,el:"H",x:1.2,y:2.1,z:0},{id:8,el:"H",x:-1.2,y:2.1,z:0},{id:9,el:"H",x:-2.4,y:0,z:0},{id:10,el:"H",x:-1.2,y:-2.1,z:0},{id:11,el:"H",x:1.2,y:-2.1,z:0}], bonds: [{source:0,target:1,type:"double"},{source:1,target:2,type:"single"},{source:2,target:3,type:"double"},{source:3,target:4,type:"single"},{source:4,target:5,type:"double"},{source:5,target:0,type:"single"},{source:0,target:6,type:"single"},{source:1,target:7,type:"single"},{source:2,target:8,type:"single"},{source:3,target:9,type:"single"},{source:4,target:10,type:"single"},{source:5,target:11,type:"single"}] },
        "Water": { atoms: [{id:0,el:"O",x:0,y:0,z:0.1},{id:1,el:"H",x:0.8,y:-0.6,z:0},{id:2,el:"H",x:-0.8,y:-0.6,z:0}], bonds: [{source:0,target:1,type:"single"},{source:0,target:2,type:"single"}] },
        "Methanol": { atoms: [{id:0,el:"C",x:-0.7,y:0,z:0},{id:1,el:"C",x:0.7,y:0,z:0},{id:2,el:"H",x:-1.0,y:1.0,z:0},{id:3,el:"H",x:-1.0,y:-0.5,z:0.9},{id:4,el:"H",x:-1.0,y:-0.5,z:-0.9},{id:5,el:"H",x:1.2,y:-0.8,z:0}], bonds: [{source:0,target:1,type:"single"},{source:0,target:2,type:"single"},{source:0,target:3,type:"single"},{source:0,target:4,type:"single"},{source:1,target:5,type:"single"}] },
        "Ethanol": { atoms: [{id:0,el:"C",x:-1.2,y:0,z:0},{id:1,el:"C",x:0,y:0.5,z:0},{id:2,el:"O",x:1.2,y:-0.2,z:0},{id:3,el:"H",x:1.8,y:0.5,z:0},{id:4,el:"H",x:-1.2,y:-1.1,z:0},{id:5,el:"H",x:-2.1,y:0.4,z:0},{id:6,el:"H",x:-1.2,y:0.4,z:1.0},{id:7,el:"H",x:0,y:1.6,z:0},{id:8,el:"H",x:0,y:0.1,z:-1.0}], bonds: [{source:0,target:1,type:"single"},{source:1,target:2,type:"single"},{source:2,target:3,type:"single"},{source:0,target:4,type:"single"},{source:0,target:5,type:"single"},{source:0,target:6,type:"single"},{source:1,target:7,type:"single"},{source:1,target:8,type:"single"}] },
        "Acetic Acid": { atoms: [{id:0,el:"C",x:-1.0,y:0,z:0},{id:1,el:"C",x:0.5,y:0,z:0},{id:2,el:"O",x:1.2,y:1.2,z:0},{id:3,el:"O",x:1.1,y:-1.2,z:0},{id:4,el:"H",x:0.5,y:-1.8,z:0},{id:5,el:"H",x:-1.4,y:1.0,z:0},{id:6,el:"H",x:-1.4,y:-0.5,z:0.9},{id:7,el:"H",x:-1.4,y:-0.5,z:-0.9}], bonds: [{source:0,target:1,type:"single"},{source:1,target:2,type:"double"},{source:1,target:3,type:"single"},{source:3,target:4,type:"single"},{source:0,target:5,type:"single"},{source:0,target:6,type:"single"},{source:0,target:7,type:"single"}] },
        "Butadiene": { atoms: [{id:0,el:"C",x:-2,y:-0.5,z:0},{id:1,el:"C",x:-0.7,y:0.5,z:0},{id:2,el:"C",x:0.7,y:-0.5,z:0},{id:3,el:"C",x:2,y:0.5,z:0},{id:4,el:"H",x:-2,y:-1.6,z:0},{id:5,el:"H",x:-2.9,y:0.05,z:0},{id:6,el:"H",x:-0.7,y:1.6,z:0},{id:7,el:"H",x:0.7,y:-1.6,z:0},{id:8,el:"H",x:2,y:1.6,z:0},{id:9,el:"H",x:2.9,y:-0.05,z:0}], bonds: [{source:0,target:1,type:"double"},{source:1,target:2,type:"single"},{source:2,target:3,type:"double"},{source:0,target:4,type:"single"},{source:0,target:5,type:"single"},{source:1,target:6,type:"single"},{source:2,target:7,type:"single"},{source:3,target:8,type:"single"},{source:3,target:9,type:"single"}] },
        "Cyclohexane": { atoms: [{id:0,el:"C",x:1.4,y:0.5,z:-0.2},{id:1,el:"C",x:0.7,y:-0.7,z:0.2},{id:2,el:"C",x:-0.7,y:-0.7,z:-0.2},{id:3,el:"C",x:-1.4,y:0.5,z:0.2},{id:4,el:"C",x:-0.7,y:1.7,z:-0.2},{id:5,el:"C",x:0.7,y:1.7,z:0.2},{id:6,el:"H",x:1.4,y:0.5,z:-1.3},{id:7,el:"H",x:2.4,y:0.5,z:0.2},{id:8,el:"H",x:0.7,y:-0.7,z:1.3},{id:9,el:"H",x:1.2,y:-1.6,z:-0.2},{id:10,el:"H",x:-0.7,y:-0.7,z:-1.3},{id:11,el:"H",x:-1.2,y:-1.6,z:0.2},{id:12,el:"H",x:-1.4,y:0.5,z:1.3},{id:13,el:"H",x:-2.4,y:0.5,z:-0.2},{id:14,el:"H",x:-0.7,y:1.7,z:-1.3},{id:15,el:"H",x:-1.2,y:2.6,z:0.2},{id:16,el:"H",x:0.7,y:1.7,z:1.3},{id:17,el:"H",x:1.2,y:2.6,z:-0.2}], bonds: [{source:0,target:1,type:"single"},{source:1,target:2,type:"single"},{source:2,target:3,type:"single"},{source:3,target:4,type:"single"},{source:4,target:5,type:"single"},{source:5,target:0,type:"single"},{source:0,target:6,type:"single"},{source:0,target:7,type:"single"},{source:1,target:8,type:"single"},{source:1,target:9,type:"single"},{source:2,target:10,type:"single"},{source:2,target:11,type:"single"},{source:3,target:12,type:"single"},{source:3,target:13,type:"single"},{source:4,target:14,type:"single"},{source:4,target:15,type:"single"},{source:5,target:16,type:"single"},{source:5,target:17,type:"single"}] },
        "Xenon": { atoms: [{id:0,el:"Xe",x:-2.0,y:0,z:0},{id:1,el:"Xe",x:2.0,y:0,z:0}], bonds: [{source:0,target:1,type:"vdw"}] },
        "Benzaldehyde": { atoms: [{id:0,el:"C",x:1.4,y:0,z:0},{id:1,el:"C",x:0.7,y:1.21,z:0},{id:2,el:"C",x:-0.7,y:1.21,z:0},{id:3,el:"C",x:-1.4,y:0,z:0},{id:4,el:"C",x:-0.7,y:-1.21,z:0},{id:5,el:"C",x:0.7,y:-1.21,z:0},{id:6,el:"C",x:-2.8,y:0,z:0},{id:7,el:"O",x:-3.5,y:1.2,z:0},{id:8,el:"H",x:-3.3,y:-1.0,z:0}], bonds: [{source:0,target:1,type:"double"},{source:1,target:2,type:"single"},{source:2,target:3,type:"double"},{source:3,target:4,type:"single"},{source:4,target:5,type:"double"},{source:5,target:0,type:"single"},{source:3,target:6,type:"single"},{source:6,target:7,type:"double"},{source:6,target:8,type:"single"}] },
        "Sodium Acetate": { atoms: [{id:0,el:"C",x:-1.0,y:0,z:0},{id:1,el:"C",x:0.5,y:0,z:0},{id:2,el:"O",x:1.2,y:1.2,z:0},{id:3,el:"O",x:1.1,y:-1.2,z:0,role:"anion"},{id:4,el:"Na",x:3.5,y:-1.5,z:0,role:"cation"},{id:5,el:"H",x:-1.4,y:1.0,z:0},{id:6,el:"H",x:-1.4,y:-0.5,z:0.9},{id:7,el:"H",x:-1.4,y:-0.5,z:-0.9}], bonds: [{source:0,target:1,type:"single"},{source:1,target:2,type:"double"},{source:1,target:3,type:"single"},{source:3,target:4,type:"ionic"},{source:0,target:5,type:"single"},{source:0,target:6,type:"single"},{source:0,target:7,type:"single"}] },
        "Tollen's Reagent": { atoms: [{id:0,el:"Ag",x:0,y:0,z:0,role:"cation"},{id:1,el:"N",x:-2.1,y:0,z:0},{id:2,el:"N",x:2.1,y:0,z:0},{id:3,el:"H",x:-2.5,y:0.8,z:0},{id:4,el:"H",x:-2.5,y:-0.4,z:0.7},{id:5,el:"H",x:-2.5,y:-0.4,z:-0.7},{id:6,el:"H",x:2.5,y:0.8,z:0},{id:7,el:"H",x:2.5,y:-0.4,z:0.7},{id:8,el:"H",x:2.5,y:-0.4,z:-0.7}], bonds: [{source:0,target:1,type:"single"},{source:0,target:2,type:"single"},{source:1,target:3,type:"single"},{source:1,target:4,type:"single"},{source:1,target:5,type:"single"},{source:2,target:6,type:"single"},{source:2,target:7,type:"single"},{source:2,target:8,type:"single"}] },
        "Dextrose": { atoms: [{id:0,el:"C",x:0,y:3,z:0},{id:1,el:"O",x:1.2,y:3.5,z:0},{id:2,el:"C",x:0,y:1.5,z:0},{id:3,el:"O",x:-1.4,y:1.5,z:0},{id:4,el:"C",x:0,y:0,z:0},{id:5,el:"O",x:1.4,y:0,z:0},{id:6,el:"C",x:0,y:-1.5,z:0},{id:7,el:"O",x:-1.4,y:-1.5,z:0},{id:8,el:"C",x:0,y:-3,z:0},{id:9,el:"O",x:1.4,y:-3,z:0},{id:10,el:"C",x:0,y:-4.5,z:0},{id:11,el:"O",x:0,y:-5.5,z:0},{id:12,el:"H",x:-1.0,y:3.2,z:0},{id:13,el:"H",x:1.0,y:1.5,z:0},{id:14,el:"H",x:-2.0,y:2.0,z:0},{id:15,el:"H",x:-1.0,y:0,z:0},{id:16,el:"H",x:2.0,y:0.5,z:0},{id:17,el:"H",x:1.0,y:-1.5,z:0},{id:18,el:"H",x:-2.0,y:-1.0,z:0},{id:19,el:"H",x:-1.0,y:-3,z:0},{id:20,el:"H",x:2.0,y:-2.5,z:0},{id:21,el:"H",x:-1.0,y:-4.5,z:0.5},{id:22,el:"H",x:1.0,y:-4.5,z:-0.5},{id:23,el:"H",x:0.5,y:-6.0,z:0}], bonds: [{source:0,target:1,type:"double"},{source:0,target:2,type:"single"},{source:0,target:12,type:"single"},{source:2,target:3,type:"single"},{source:2,target:4,type:"single"},{source:2,target:13,type:"single"},{source:3,target:14,type:"single"},{source:4,target:5,type:"single"},{source:4,target:6,type:"single"},{source:4,target:15,type:"single"},{source:5,target:16,type:"single"},{source:6,target:7,type:"single"},{source:6,target:8,type:"single"},{source:6,target:17,type:"single"},{source:7,target:18,type:"single"},{source:8,target:9,type:"single"},{source:8,target:10,type:"single"},{source:8,target:19,type:"single"},{source:9,target:20,type:"single"},{source:10,target:11,type:"single"},{source:10,target:21,type:"single"},{source:10,target:22,type:"single"},{source:11,target:23,type:"single"}] },
        "Glucopyranose": { atoms: [{id:0,el:"O",x:1.2,y:0.7,z:0},{id:1,el:"C",x:1.2,y:-0.7,z:0},{id:2,el:"C",x:0,y:-1.4,z:0},{id:3,el:"C",x:-1.2,y:-0.7,z:0},{id:4,el:"C",x:-1.2,y:0.7,z:0},{id:5,el:"C",x:0,y:1.4,z:0},{id:6,el:"C",x:0,y:2.8,z:0},{id:7,el:"O",x:1.2,y:2.8,z:0},{id:8,el:"O",x:2.3,y:-1.0,z:0},{id:9,el:"O",x:0,y:-2.6,z:0},{id:10,el:"O",x:-2.3,y:-1.0,z:0},{id:11,el:"O",x:-2.3,y:1.0,z:0},{id:12,el:"H",x:2.8,y:-0.5,z:0},{id:13,el:"H",x:0.5,y:-3.0,z:0},{id:14,el:"H",x:-2.8,y:-0.5,z:0},{id:15,el:"H",x:-2.8,y:1.5,z:0},{id:16,el:"H",x:1.8,y:3.2,z:0},{id:17,el:"H",x:0.5,y:-0.5,z:1.0},{id:18,el:"H",x:-0.5,y:-1.0,z:1.0},{id:19,el:"H",x:-0.8,y:-0.5,z:1.0},{id:20,el:"H",x:-0.8,y:0.5,z:1.0},{id:21,el:"H",x:0,y:1.2,z:1.2},{id:22,el:"H",x:-0.8,y:2.8,z:0.5},{id:23,el:"H",x:0.5,y:2.8,z:-0.8}], bonds: [{source:0,target:1,type:"single"},{source:1,target:2,type:"single"},{source:2,target:3,type:"single"},{source:3,target:4,type:"single"},{source:4,target:5,type:"single"},{source:5,target:0,type:"single"},{source:5,target:6,type:"single"},{source:6,target:7,type:"single"},{source:1,target:8,type:"single"},{source:8,target:12,type:"single"},{source:2,target:9,type:"single"},{source:9,target:13,type:"single"},{source:3,target:10,type:"single"},{source:10,target:14,type:"single"},{source:4,target:11,type:"single"},{source:11,target:15,type:"single"},{source:7,target:16,type:"single"},{source:1,target:17,type:"single"},{source:2,target:18,type:"single"},{source:3,target:19,type:"single"},{source:4,target:20,type:"single"},{source:5,target:21,type:"single"},{source:6,target:22,type:"single"},{source:6,target:23,type:"single"}] }
      };

      const ATOMIC_MASSES = { "H": 1.008, "C": 12.011, "N": 14.007, "O": 15.999, "Na": 22.990, "Ag": 107.868, "Xe": 131.293 };
      const ELEMENT_COLORS = { "C": 0x333333, "H": 0xFFFFFF, "O": 0xFF0000, "N": 0x0000FF, "Ag": 0xC0C0C0, "Na": 0x800080, "Xe": 0x00FFFF };
      const ELEMENT_NAMES = { "C": "Carbon", "H": "Hydrogen", "O": "Oxygen", "N": "Nitrogen", "Ag": "Silver", "Na": "Sodium", "Xe": "Xenon" };
      const ELEMENT_RADII = { "C": 0.4, "H": 0.25, "O": 0.35, "N": 0.38, "Ag": 0.5, "Na": 0.5, "Xe": 0.5 };

      const GradientText = ({ children }) => (<span className="text-transparent bg-clip-text bg-gradient-to-r from-primary via-cyan-300 to-secondary font-bold">{children}</span>);

      // --- Star Background ---
      const StarField = () => {
        const canvasRef = useRef(null);
        useEffect(() => {
          const canvas = canvasRef.current;
          if (!canvas) return;
          const ctx = canvas.getContext('2d');
          
          let width, height;
          let stars = [];

          const resize = () => {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            stars = Array.from({ length: 400 }, () => ({
              x: Math.random() * width,
              y: Math.random() * height,
              size: Math.random() * 1.5,
              opacity: Math.random() * 0.5 + 0.1
            }));
          };

          resize();
          window.addEventListener('resize', resize);

          const animate = () => {
            ctx.clearRect(0, 0, width, height);
            stars.forEach(star => {
              ctx.fillStyle = `rgba(255, 255, 255, ${star.opacity})`;
              ctx.beginPath();
              ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
              ctx.fill();
            });
            requestAnimationFrame(animate);
          };
          animate();

          return () => window.removeEventListener('resize', resize);
        }, []);
        return <canvas ref={canvasRef} className="fixed inset-0 pointer-events-none z-0 opacity-40" />;
      };

      const ShootingStars = () => {
        const canvasRef = useRef(null);
        useEffect(() => {
          const canvas = canvasRef.current; const ctx = canvas.getContext('2d'); let width, height; let stars = []; let shootingStars = [];
          const resize = () => { width = canvas.width = canvas.offsetWidth; height = canvas.height = canvas.offsetHeight; stars = Array.from({ length: 200 }, () => ({ x: Math.random() * width, y: Math.random() * height, size: Math.random() * 2, alpha: Math.random() })); };
          window.addEventListener('resize', resize); resize();
          const createShootingStar = () => { const startX = Math.random() * width; const startY = Math.random() * height * 0.5; const length = Math.random() * 100 + 50; const angle = Math.PI / 4; const speed = Math.random() * 10 + 5; return { x: startX, y: startY, length, angle, speed, life: 1, opacity: 1 }; };
          const animate = () => {
              ctx.clearRect(0, 0, width, height);
              stars.forEach(star => { ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`; ctx.beginPath(); ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2); ctx.fill(); });
              if (Math.random() < 0.02) shootingStars.push(createShootingStar());
              shootingStars.forEach((star, index) => { star.x -= star.speed; star.y += star.speed; star.life -= 0.02; if (star.life <= 0) { shootingStars.splice(index, 1); } else { const tailX = star.x + Math.cos(star.angle) * star.length; const tailY = star.y - Math.sin(star.angle) * star.length; const grad = ctx.createLinearGradient(star.x, star.y, tailX, tailY); grad.addColorStop(0, `rgba(255, 255, 255, ${star.life})`); grad.addColorStop(1, 'rgba(255, 255, 255, 0)'); ctx.strokeStyle = grad; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(star.x, star.y); ctx.lineTo(tailX, tailY); ctx.stroke(); } });
              requestAnimationFrame(animate);
          };
          const animId = requestAnimationFrame(animate); return () => { window.removeEventListener('resize', resize); cancelAnimationFrame(animId); };
        }, []);
        return <canvas ref={canvasRef} className="absolute inset-0 w-full h-full" />;
      };

      const DecayChallenge = ({ onClose }) => {
        const mountRef = useRef(null);
        const [selectedIsotope, setSelectedIsotope] = useState(ISOTOPES[0]);
        const [searchTerm, setSearchTerm] = useState("");
        const filteredIsotopes = useMemo(() => ISOTOPES.filter(iso => iso.name.toLowerCase().includes(searchTerm.toLowerCase()) || iso.symbol.toLowerCase().includes(searchTerm.toLowerCase())), [searchTerm]);
        const [productMain, setProductMain] = useState({ mass: "", atomic: "", symbol: "" });
        const [productSec, setProductSec] = useState({ mass: "", atomic: "", symbol: "" });
        const [particleInputLeft, setParticleInputLeft] = useState("");
        const [particleInputRight, setParticleInputRight] = useState("");
        const [status, setStatus] = useState("idle"); 
        const [animProgress, setAnimProgress] = useState(0); 
        const [isPlaying, setIsPlaying] = useState(false);
        const simState = useRef({ progress: 0, isPlaying: false, hasPlayedSound: false });
        
        // Sound Hook integration
        const { playClick, playSlide, playDecay, playEscape } = useSound();

        // Materials cache
        const materialsRef = useRef({
            proton: new THREE.MeshPhongMaterial({ color: 0xff3333, shininess: 80 }),
            neutron: new THREE.MeshPhongMaterial({ color: 0xcccccc, shininess: 50 })
        });

        useEffect(() => { 
            simState.current.isPlaying = isPlaying; 
            simState.current.progress = animProgress;
            // Reset sound flag if we rewind
            if (animProgress < 10) simState.current.hasPlayedSound = false;
        }, [isPlaying, animProgress]);

        const parseParticles = (input) => input.trim().split(/[\s,]+/).map(t => { const val = t.toLowerCase(); if (val === 'b-' || val === 'beta') return 'β⁻'; if (val === 'y' || val === 'gamma') return 'γ'; if (val === 'v' || val === 'nu') return 'ν'; if (val === 'v-' || val === 'nu-') return 'ν̄'; if (val === 'a' || val === 'alpha') return 'α'; if (val === 'e' || val === 'e-') return 'e⁻'; return ''; }).filter(t => t);
        
        const checkAnswer = () => {
            playClick();
            const correctProd = selectedIsotope.product; const type = selectedIsotope.type;
            const isMainCorrect = parseInt(productMain.mass) === correctProd.mass && parseInt(productMain.atomic) === correctProd.atomic && productMain.symbol.toLowerCase().trim() === correctProd.symbol.toLowerCase();
            let isSecProdCorrect = false; if (type === "Alpha") { const sym = productSec.symbol.toLowerCase().trim(); const validAlphaSyms = ['he', 'he++', 'he2+', 'α']; isSecProdCorrect = productSec.mass === "4" && productSec.atomic === "2" && validAlphaSyms.includes(sym); } else { isSecProdCorrect = productSec.mass === "" && productSec.atomic === "" && productSec.symbol === ""; }
            const leftTokens = parseParticles(particleInputLeft); let isLeftCorrect = type === "Electron Capture" ? leftTokens.includes('e⁻') : leftTokens.length === 0;
            const rightTokens = parseParticles(particleInputRight); const expectedRight = [...selectedIsotope.particles]; const normalize = (list) => list.map(p => p === 'e⁻' ? 'β⁻' : p).sort();
            const isRightCorrect = JSON.stringify(normalize(rightTokens)) === JSON.stringify(normalize(expectedRight));
            if (isMainCorrect && isLeftCorrect && isSecProdCorrect && isRightCorrect) { setStatus("correct"); setIsPlaying(true); } else { setStatus("wrong"); }
        };
        
        useEffect(() => { 
            setProductMain({ mass: "", atomic: "", symbol: "" }); setProductSec({ mass: "", atomic: "", symbol: "" }); setParticleInputLeft(""); setParticleInputRight(""); setStatus("idle"); setAnimProgress(0); setIsPlaying(false); simState.current.progress = 0; 
            simState.current.hasPlayedSound = false;
        }, [selectedIsotope]);
        
        useEffect(() => {
            if (!mountRef.current || !window.THREE) return;
            const width = mountRef.current.clientWidth; const height = mountRef.current.clientHeight;
            const scene = new THREE.Scene();
            const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 100); camera.position.set(0, 5, 12);
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); renderer.setSize(width, height); mountRef.current.appendChild(renderer.domElement);
            const controls = new THREE.OrbitControls(camera, renderer.domElement); controls.enableDamping = true; controls.dampingFactor = 0.05; controls.enablePan = true;
            const ambient = new THREE.AmbientLight(0x404040, 2); scene.add(ambient);
            const light = new THREE.DirectionalLight(0xffffff, 2); light.position.set(5, 5, 5); scene.add(light);
            
            const nucleusGroup = new THREE.Group(); scene.add(nucleusGroup);
            const electronGroup = new THREE.Group(); scene.add(electronGroup);
            const ejectionGroup = new THREE.Group(); scene.add(ejectionGroup);
            
            const { proton, neutron } = materialsRef.current;
            const particleRadius = 0.2;
            let capturedElectron = null;
            let targetNucleon = null;

            // Generate Nucleus
            while(nucleusGroup.children.length > 0) nucleusGroup.remove(nucleusGroup.children[0]);
            while(ejectionGroup.children.length > 0) ejectionGroup.remove(ejectionGroup.children[0]);
            
            const visualProtons = selectedIsotope.atomic; 
            const visualNeutrons = selectedIsotope.mass - selectedIsotope.atomic;
            const totalParticles = visualProtons + visualNeutrons;
            const clusterRadius = Math.pow(totalParticles, 1/3) * particleRadius * 1.1; // Dense packing
            const geometry = new THREE.SphereGeometry(particleRadius, 16, 16);

            const particles = [];
            for(let i=0; i<visualProtons; i++) particles.push({ type: 'proton', mat: proton });
            for(let i=0; i<visualNeutrons; i++) particles.push({ type: 'neutron', mat: neutron });
            // Shuffle but ensure we can pick a target
            particles.sort(() => Math.random() - 0.5);

            // Separate Alpha Cluster if needed
            let alphaCluster = [];
            if (selectedIsotope.type === "Alpha") {
                let pFound = 0, nFound = 0;
                for(let i = particles.length - 1; i >= 0; i--) {
                    if (particles[i].type === 'proton' && pFound < 2) { alphaCluster.push(particles.splice(i, 1)[0]); pFound++; } 
                    else if (particles[i].type === 'neutron' && nFound < 2) { alphaCluster.push(particles.splice(i, 1)[0]); nFound++; }
                    if (pFound >= 2 && nFound >= 2) break;
                }
            }

            particles.forEach(p => {
                const mesh = new THREE.Mesh(geometry, p.mat);
                const r = Math.pow(Math.random(), 1/3) * clusterRadius;
                const theta = Math.random() * Math.PI * 2; const phi = Math.acos(2 * Math.random() - 1);
                mesh.position.set(r * Math.sin(phi) * Math.cos(theta), r * Math.sin(phi) * Math.sin(theta), r * Math.cos(phi));
                mesh.userData = { type: p.type, originalMat: p.mat };
                // Identify target nucleon for specific decays
                if (selectedIsotope.type === "Beta Minus" && p.type === 'neutron' && !targetNucleon) { targetNucleon = mesh; }
                if (selectedIsotope.type === "Electron Capture" && p.type === 'proton' && !targetNucleon) { targetNucleon = mesh; }
                nucleusGroup.add(mesh);
            });

            // Ejection Setup
            if (selectedIsotope.type === "Alpha") {
                const alphaObj = new THREE.Group();
                const alphaPositions = [
                    new THREE.Vector3(1, 1, 1).normalize().multiplyScalar(particleRadius),
                    new THREE.Vector3(1, -1, -1).normalize().multiplyScalar(particleRadius),
                    new THREE.Vector3(-1, 1, -1).normalize().multiplyScalar(particleRadius),
                    new THREE.Vector3(-1, -1, 1).normalize().multiplyScalar(particleRadius)
                ];
                alphaCluster.forEach((p, i) => { const mesh = new THREE.Mesh(geometry, p.mat); if (i < 4) mesh.position.copy(alphaPositions[i]); alphaObj.add(mesh); });
                alphaObj.userData = { type: 'alpha', dir: new THREE.Vector3(1, 0.5, 0.2).normalize() };
                ejectionGroup.add(alphaObj);
            } else if (selectedIsotope.type === "Beta Minus") {
                const eGeo = new THREE.SphereGeometry(0.1, 12, 12);
                const eMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
                const electron = new THREE.Mesh(eGeo, eMat);
                electron.userData = { type: 'beta', dir: new THREE.Vector3(-1, 0.2, 0).normalize() };
                ejectionGroup.add(electron);
            } else if (selectedIsotope.type === "Electron Capture") {
                // Neutrino emission
                const vGeo = new THREE.SphereGeometry(0.05, 8, 8);
                const vMat = new THREE.MeshBasicMaterial({ color: 0xaaaaaa, transparent: true, opacity: 0.7 });
                const neutrino = new THREE.Mesh(vGeo, vMat);
                neutrino.userData = { type: 'neutrino', dir: new THREE.Vector3(1, 0.5, -0.5).normalize() };
                ejectionGroup.add(neutrino);
            } else if (selectedIsotope.type === "Gamma") {
                const waveLength = 4;
                const points = [];
                for(let i=0; i<=50; i++) { const t = i/50; points.push(new THREE.Vector3(t*waveLength - 2, Math.sin(t*20)*0.25, 0)); }
                const waveGeo = new THREE.BufferGeometry().setFromPoints(points);
                const waveMat = new THREE.LineBasicMaterial({ color: 0xffff00, linewidth: 2 });
                const wave = new THREE.Line(waveGeo, waveMat);
                const coneGeo = new THREE.ConeGeometry(0.15, 0.4, 8);
                const coneMat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
                const arrow = new THREE.Mesh(coneGeo, coneMat);
                arrow.rotation.z = -Math.PI / 2;
                arrow.position.set(waveLength - 2, 0, 0);
                const gammaObj = new THREE.Group();
                gammaObj.add(wave); gammaObj.add(arrow);
                gammaObj.userData = { type: 'gamma', dir: new THREE.Vector3(1, 0, 0) };
                ejectionGroup.add(gammaObj);
            }

            // Generate Electrons
            while(electronGroup.children.length > 0) electronGroup.remove(electronGroup.children[0]);
            const shells = getElectronShells(selectedIsotope.atomic);
            shells.forEach((count, index) => {
                if (count <= 0) return; const radius = 3 + index * 1.5;
                const ring = new THREE.Mesh(new THREE.TorusGeometry(radius, 0.02, 8, 64), new THREE.MeshBasicMaterial({ color: 0x444444, opacity: 0.3, transparent: true }));
                ring.rotation.x = Math.PI / 2 + (Math.random() - 0.5) * 0.5; ring.rotation.y += (Math.random() - 0.5) * 0.5; electronGroup.add(ring);
                for(let i=0; i<count; i++) {
                    const angle = (i / count) * Math.PI * 2;
                    const el = new THREE.Mesh(new THREE.SphereGeometry(0.12, 8, 8), new THREE.MeshBasicMaterial({ color: 0x00ffff }));
                    // For Electron Capture, grab the first electron in the inner shell (index 0)
                    if (selectedIsotope.type === "Electron Capture" && index === 0 && i === 0) {
                        capturedElectron = el;
                        el.userData = { isCaptured: true, initialPos: new THREE.Vector3(Math.cos(angle) * radius, Math.sin(angle) * radius, 0), pivotRot: ring.rotation.clone() };
                    }
                    el.position.set(Math.cos(angle) * radius, Math.sin(angle) * radius, 0);
                    const pivot = new THREE.Group(); pivot.rotation.copy(ring.rotation); pivot.add(el);
                    pivot.userData = { speed: (Math.random() * 0.05 + 0.02) * (index % 2 === 0 ? 1 : -1) }; 
                    if (el !== capturedElectron) electronGroup.add(pivot); // Add normal electrons to group
                    else scene.add(el); // Captured electron added directly to scene for easier lerping
                }
            });

            let animId;
            const animate = () => {
                animId = requestAnimationFrame(animate); 
                
                // Update time state
                if (simState.current.isPlaying) {
                    if (simState.current.progress < 100) {
                        simState.current.progress += 0.5;
                        setAnimProgress(simState.current.progress);
                    } else {
                        setIsPlaying(false);
                    }
                }
                
                const t = simState.current.progress / 100; // 0 to 1

                // Trigger Sound Effect for Decay
                let triggerSound = false;
                if (selectedIsotope.type === "Electron Capture") { if (t >= 0.5 && !simState.current.hasPlayedSound) triggerSound = true; } 
                else if (selectedIsotope.type === "Beta Minus") { if (t >= 0.1 && !simState.current.hasPlayedSound) triggerSound = true; } 
                else if (selectedIsotope.type === "Alpha" || selectedIsotope.type === "Gamma") { if (t >= 0.05 && !simState.current.hasPlayedSound) triggerSound = true; }

                if (triggerSound) {
                    playDecay();
                    simState.current.hasPlayedSound = true;
                }

                // 1. Electron Orbit Animation (Background)
                electronGroup.children.forEach(pivot => { if (pivot.userData.speed) pivot.rotation.z += pivot.userData.speed; });

                // 2. Specific Decay Animations based on 't'
                
                // --- Electron Capture ---
                if (selectedIsotope.type === "Electron Capture") {
                    if (capturedElectron && targetNucleon) {
                        const collisionTime = 0.5; // Event happens at 50%
                        if (t < collisionTime) {
                            // Phase 1: Spiral In
                            const lerpFactor = t / collisionTime; // 0 to 1
                            const start = capturedElectron.userData.initialPos.clone().applyEuler(capturedElectron.userData.pivotRot);
                            const end = targetNucleon.position.clone();
                            
                            // Spiral effect
                            const mid = start.clone().lerp(end, 0.5).add(new THREE.Vector3(Math.sin(t*20), Math.cos(t*20), 0).multiplyScalar(1 - lerpFactor));
                            
                            const curve = new THREE.QuadraticBezierCurve3(start, mid, end);
                            capturedElectron.position.copy(curve.getPoint(lerpFactor));
                            capturedElectron.visible = true;
                            
                            // Reset nucleon
                            targetNucleon.material = materialsRef.current.proton;
                        } else {
                            // Phase 2: Impact & Transmutation
                            capturedElectron.visible = false;
                            targetNucleon.material = materialsRef.current.neutron; // Proton -> Neutron
                        }
                    }
                }

                // --- Beta Decay ---
                if (selectedIsotope.type === "Beta Minus") {
                    const decayTime = 0.1;
                    if (targetNucleon) {
                        if (t > decayTime) targetNucleon.material = materialsRef.current.proton; // Neutron -> Proton
                        else targetNucleon.material = materialsRef.current.neutron;
                    }
                }

                // --- Ejecta Movement (Alpha, Beta, Gamma, Neutrino) ---
                ejectionGroup.children.forEach(obj => {
                    const dir = obj.userData.dir;
                    let speed = 0;
                    let startTime = 0;

                    if (obj.userData.type === 'alpha') { speed = 8; startTime = 0; }
                    else if (obj.userData.type === 'beta') { speed = 15; startTime = 0.1; }
                    else if (obj.userData.type === 'gamma') { speed = 12; startTime = 0; }
                    else if (obj.userData.type === 'neutrino') { speed = 15; startTime = 0.5; } // Ejected after capture

                    if (t > startTime) {
                        const localT = (t - startTime) / (1 - startTime); // Normalize time after start
                        obj.position.copy(dir).multiplyScalar(localT * speed);
                        obj.visible = true;
                        
                        // Rotations/Scaling
                        if (obj.userData.type === 'alpha') obj.rotation.z += 0.1;
                        obj.scale.setScalar(1);
                    } else {
                        obj.visible = false;
                        obj.position.set(0,0,0);
                    }
                });

                // Nucleus Jiggle
                if (t > 0 && t < 0.2) {
                     nucleusGroup.position.x = (Math.random() - 0.5) * 0.05;
                     nucleusGroup.position.y = (Math.random() - 0.5) * 0.05;
                } else {
                     nucleusGroup.position.set(0,0,0);
                }

                renderer.render(scene, camera);
            };
            animate();
            return () => { cancelAnimationFrame(animId); if (mountRef.current && renderer) mountRef.current.removeChild(renderer.domElement); renderer.dispose(); };
        }, [selectedIsotope]);

        const updateState = (setter, field, value) => { setter(prev => ({ ...prev, [field]: value })); };

        return (
            <div className="fixed inset-0 z-[100] flex bg-[#0a1116] animate-in fade-in duration-300">
                <div className="w-72 border-r border-white/10 flex flex-col bg-surface-dark/95 backdrop-blur-md">
                    <div className="p-4 border-b border-white/10">
                        <button onClick={() => { playEscape(); onClose(); }} className="text-slate-400 hover:text-white flex items-center gap-2 text-sm mb-4"><span className="material-symbols-outlined text-sm">arrow_back</span> Back</button>
                        <h2 className="text-xl font-bold text-white"><span className="text-secondary">Decay</span> Challenge</h2>
                        <div className="relative mt-4"><span className="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-xs">search</span><input type="text" placeholder="Search isotope..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full bg-black/20 border border-white/10 rounded-md py-1.5 pl-8 pr-2 text-xs text-white focus:outline-none focus:border-secondary transition-colors"/></div>
                    </div>
                    <div className="flex-1 overflow-y-auto molecule-scroll p-2 space-y-1">
                        {filteredIsotopes.map((iso, idx) => (<button key={idx} onClick={() => { playClick(); setSelectedIsotope(iso); }} className={`w-full text-left px-3 py-2 rounded text-sm flex justify-between items-center transition-colors ${selectedIsotope.name === iso.name ? 'bg-secondary/20 text-secondary border border-secondary/50' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`}>{iso.name}<span className="text-[10px] font-mono opacity-50">{iso.type}</span></button>))}
                    </div>
                </div>
                <div className="flex-1 flex flex-col relative">
                    <div className="absolute top-0 left-0 w-full p-6 flex justify-between items-start pointer-events-none z-10"><div><h1 className="text-3xl font-bold text-white mb-1">{selectedIsotope.name}</h1><div className="flex items-center gap-2"><span className="px-2 py-1 bg-white/10 rounded text-xs font-mono text-white">Mass: {selectedIsotope.mass}</span><span className="px-2 py-1 bg-white/10 rounded text-xs font-mono text-white">Atomic: {selectedIsotope.atomic}</span></div></div><div className="bg-black/50 backdrop-blur px-4 py-2 rounded-lg border border-white/10 text-center"><span className="text-xs text-slate-400 uppercase tracking-widest">Decay Type</span><div className="text-xl font-bold text-primary">{selectedIsotope.type}</div></div></div>
                    
                    <div className="flex-1 w-full relative bg-gradient-radial from-[#1a232e] to-[#020204]">
                         <div ref={mountRef} className="absolute inset-0" />
                         
                         <div className="absolute bottom-4 left-4 bg-black/60 backdrop-blur p-3 rounded-lg border border-white/10 flex flex-col gap-2 pointer-events-none">
                             <div className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">Atom Legend</div>
                             <div className="flex items-center gap-2 text-xs text-slate-300"><div className="w-3 h-3 rounded-full bg-[#ff3333]"></div>Proton</div>
                             <div className="flex items-center gap-2 text-xs text-slate-300"><div className="w-3 h-3 rounded-full bg-[#cccccc]"></div>Neutron</div>
                             <div className="flex items-center gap-2 text-xs text-slate-300"><div className="w-3 h-3 rounded-full bg-[#00ffff]"></div>Electron</div>
                         </div>

                         <div className="absolute bottom-4 left-1/2 -translate-x-1/2 w-80 bg-black/60 backdrop-blur px-6 py-3 rounded-full border border-white/10 flex items-center gap-4 z-20">
                             <button onClick={() => { playClick(); setIsPlaying(!isPlaying); }} className="text-primary hover:text-white transition-colors"><span className="material-symbols-outlined text-2xl">{isPlaying ? 'pause' : 'play_arrow'}</span></button>
                             <div className="flex-1 relative h-4 flex items-center">
                                <input type="range" min="0" max="100" step="0.1" value={animProgress} onChange={(e) => { playSlide(); setIsPlaying(false); setAnimProgress(parseFloat(e.target.value)); }} className="range-slider absolute inset-0 z-10 opacity-0 cursor-pointer" />
                                <div className="w-full h-1 bg-white/10 rounded-full overflow-hidden">
                                    <div className="h-full bg-primary transition-all duration-75" style={{ width: `${animProgress}%` }}></div>
                                </div>
                                <div className="absolute h-4 w-4 bg-white rounded-full shadow-[0_0_10px_#06bcf9] pointer-events-none transition-all duration-75" style={{ left: `${animProgress}%`, transform: 'translateX(-50%)' }}></div>
                             </div>
                             <span className="text-xs font-mono text-slate-400 w-10 text-right">{Math.round(animProgress)}%</span>
                         </div>
                    </div>

                    <div className="h-56 bg-surface-dark border-t border-white/10 p-4 flex flex-col gap-4 overflow-x-auto">
                        <div className="flex items-center justify-center gap-2 sm:gap-4 text-white font-display flex-nowrap min-w-max px-4">
                            <div className="flex flex-col items-center leading-none"><span className="text-xs text-slate-400 border-b border-transparent">{selectedIsotope.mass}</span><span className="text-2xl font-bold">{selectedIsotope.symbol}</span><span className="text-xs text-slate-400">{selectedIsotope.atomic}</span></div>
                            <span className="text-slate-500">+</span><div className="flex flex-col items-center justify-center"><input className="particle-input" placeholder="e-" value={particleInputLeft} onChange={(e) => setParticleInputLeft(e.target.value)}/></div><span className="material-symbols-outlined text-slate-500 mx-2">arrow_forward</span>
                            <div className="flex flex-col items-center leading-none relative group"><input className="equation-input w-8 text-xs mb-1" placeholder="?" value={productMain.mass} onChange={(e) => updateState(setProductMain, 'mass', e.target.value)}/><input className="equation-input w-16 text-2xl font-bold mb-1" placeholder="?" value={productMain.symbol} onChange={(e) => updateState(setProductMain, 'symbol', e.target.value)}/><input className="equation-input w-8 text-xs" placeholder="?" value={productMain.atomic} onChange={(e) => updateState(setProductMain, 'atomic', e.target.value)}/></div>
                            <span className="text-slate-500">+</span><div className="flex flex-col items-center leading-none relative group"><input className="equation-input w-8 text-xs mb-1" placeholder="-" value={productSec.mass} onChange={(e) => updateState(setProductSec, 'mass', e.target.value)}/><input className="equation-input w-12 text-2xl font-bold mb-1" placeholder="?" value={productSec.symbol} onChange={(e) => updateState(setProductSec, 'symbol', e.target.value)}/><input className="equation-input w-8 text-xs" placeholder="-" value={productSec.atomic} onChange={(e) => updateState(setProductSec, 'atomic', e.target.value)}/></div>
                            <span className="text-slate-500">+</span><div className="flex flex-col items-center justify-center"><input className="particle-input" placeholder="B- v-" value={particleInputRight} onChange={(e) => setParticleInputRight(e.target.value)}/></div>
                            <button onClick={checkAnswer} className={`ml-4 px-4 py-2 rounded-full font-bold text-xs transition-all ${status === 'correct' ? 'bg-green-500 text-white' : 'bg-white text-black hover:bg-slate-200'}`}>{status === 'correct' ? 'SOLVED' : 'CHECK'}</button>
                        </div>
                        <div className="flex flex-col items-center gap-2"><div className={`text-sm font-bold h-5 ${status === 'correct' ? 'text-green-400' : status === 'wrong' ? 'text-red-400' : 'text-transparent'}`}>{status === 'correct' ? "Correct!" : "Try again."}</div></div>
                    </div>
                </div>
            </div>
        );
      };

      const HydrogenSpectrum = ({ onClose }) => {
          const canvasRef = useRef(null);
          const [level, setLevel] = useState(1);
          const [history, setHistory] = useState([]);
          const [activeTransition, setActiveTransition] = useState(null);
          const { playExcite, playPhoton, playEscape } = useSound();
          const electronAngleRef = useRef(0); // Track electron angle for emission source
          
          // Constants
          const R = 1.097373e7;
          
          useEffect(() => {
              const canvas = canvasRef.current;
              if (!canvas) return;
              const ctx = canvas.getContext('2d');
              let animationFrameId;
              let electronRadius = 30 * level; // Base radius scale
              let photons = []; // Array of active photons to animate

              const render = () => {
                  canvas.width = canvas.clientWidth;
                  canvas.height = canvas.clientHeight;
                  const w = canvas.width;
                  const h = canvas.height;
                  const cx = w / 2;
                  const cy = h / 2;

                  // Clear
                  ctx.fillStyle = '#020204';
                  ctx.fillRect(0, 0, w, h);

                  // Draw Proton
                  ctx.fillStyle = '#ff3333';
                  ctx.beginPath();
                  ctx.arc(cx, cy, 8, 0, Math.PI * 2);
                  ctx.fill();
                  ctx.shadowColor = '#ff3333';
                  ctx.shadowBlur = 15;
                  ctx.stroke();
                  ctx.shadowBlur = 0;

                  // Draw Orbits
                  ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                  ctx.lineWidth = 1;
                  for (let n = 1; n <= 6; n++) {
                      ctx.beginPath();
                      ctx.arc(cx, cy, 30 * n, 0, Math.PI * 2);
                      ctx.stroke();
                  }

                  // Animate Electron
                  electronAngleRef.current += 0.05 / level; // Slower at higher levels
                  
                  // Smooth transition for radius
                  const targetRadius = 30 * level;
                  electronRadius += (targetRadius - electronRadius) * 0.1;
                  
                  const ex = cx + Math.cos(electronAngleRef.current) * electronRadius;
                  const ey = cy + Math.sin(electronAngleRef.current) * electronRadius;

                  ctx.fillStyle = '#06bcf9';
                  ctx.beginPath();
                  ctx.arc(ex, ey, 5, 0, Math.PI * 2);
                  ctx.fill();
                  ctx.shadowColor = '#06bcf9';
                  ctx.shadowBlur = 10;
                  ctx.fill();
                  ctx.shadowBlur = 0;

                  // Animate Photons (Sine Wave Escape)
                  for (let i = photons.length - 1; i >= 0; i--) {
                      const p = photons[i];
                      p.dist += 4; // Move outward
                      p.opacity -= 0.01;
                      
                      if (p.opacity <= 0) {
                          photons.splice(i, 1);
                          continue;
                      }

                      ctx.save();
                      ctx.translate(cx, cy);
                      ctx.rotate(p.angle);
                      
                      ctx.beginPath();
                      ctx.strokeStyle = p.color;
                      ctx.lineWidth = 2;
                      ctx.globalAlpha = p.opacity;
                      
                      // Draw sine wave segment moving away
                      const waveLength = 60;
                      const freq = 0.3;
                      const amp = 5;
                      
                      // Draw points
                      for (let x = 0; x <= waveLength; x += 2) {
                          const dist = p.dist - x;
                          if (dist < 20) continue; // Don't draw inside nucleus
                          const y = Math.sin(x * freq) * amp;
                          if (x === 0) ctx.moveTo(dist, y);
                          else ctx.lineTo(dist, y);
                      }
                      
                      ctx.stroke();
                      ctx.restore();
                  }

                  animationFrameId = requestAnimationFrame(render);
              };
              render();

              // Logic for decay loop
              let decayTimeout;
              if (level > 1) {
                  // Random time between 0.5s and 3s
                  const delay = 500 + Math.random() * 2500;
                  decayTimeout = setTimeout(() => {
                      const nextLevel = Math.floor(Math.random() * (level - 1)) + 1;
                      
                      // Calculate Physics
                      const n1 = nextLevel; // Lower
                      const n2 = level;     // Upper
                      const invLambda = R * (1/(n1*n1) - 1/(n2*n2));
                      const wavelengthM = 1 / invLambda;
                      const wavelengthNm = wavelengthM * 1e9;
                      const wlStr = wavelengthNm.toFixed(1);
                      
                      // Determine Region and Color
                      let color = '#ffffff';
                      let region = 'Ultraviolet';
                      if (wavelengthNm > 700) { region = 'Infrared'; color = '#ff0000'; } // Visualize IR as Red
                      else if (wavelengthNm < 400) { region = 'Ultraviolet'; color = '#aa00ff'; } // Visualize UV as Purple
                      else {
                          region = 'Visible';
                          if (wavelengthNm < 440) color = '#8b00ff'; // Violet
                          else if (wavelengthNm < 490) color = '#0000ff'; // Blue
                          else if (wavelengthNm < 510) color = '#00ffff'; // Cyan
                          else if (wavelengthNm < 580) color = '#00ff00'; // Green
                          else if (wavelengthNm < 645) color = '#ffff00'; // Yellow
                          else color = '#ff0000'; // Red
                      }
                      
                      let series = '';
                      if (n1 === 1) series = 'Lyman';
                      else if (n1 === 2) series = 'Balmer';
                      else if (n1 === 3) series = 'Paschen';
                      else if (n1 === 4) series = 'Brackett';
                      else if (n1 === 5) series = 'Pfund';

                      // Emit Photon visually in Canvas (from electron position)
                      photons.push({
                          dist: 30 * level, // Start at excited radius
                          angle: electronAngleRef.current, // Use current electron angle
                          color: color,
                          opacity: 1
                      });
                      
                      playPhoton(wavelengthNm);

                      // Update history
                      setHistory(prev => [{ n2, n1, series, wavelength: wlStr, region, color }, ...prev].slice(0, 6));
                      
                      // Trigger Energy Level Animation
                      setActiveTransition({ nFrom: n2, nTo: n1, color, wavelength: wlStr });
                      setTimeout(() => setActiveTransition(null), 1200);

                      setLevel(nextLevel);
                  }, delay);
              }

              return () => {
                  cancelAnimationFrame(animationFrameId);
                  clearTimeout(decayTimeout);
              };
          }, [level]);

          const handleExcite = (n) => {
              if (n > level) {
                  playExcite();
                  setLevel(n);
                  setActiveTransition(null); 
              }
          };

          return (
            <div className="fixed inset-0 z-[100] flex bg-[#0a1116] animate-in fade-in duration-300">
                {/* Left Sidebar (Controls) */}
                <div className="w-72 border-r border-white/10 flex flex-col bg-surface-dark/95 backdrop-blur-md z-20 shrink-0">
                    <div className="p-6 border-b border-white/10">
                        <button onClick={() => { playEscape(); onClose(); }} className="text-slate-400 hover:text-white flex items-center gap-2 text-sm mb-4"><span className="material-symbols-outlined text-sm">arrow_back</span> Back</button>
                        <h2 className="text-xl font-bold text-white"><span className="text-primary">Hydrogen</span> Line Spectrum</h2>
                        <p className="text-[10px] text-slate-500 font-mono mt-1">BOHR MODEL SIMULATION</p>
                    </div>
                    
                    <div className="p-6 space-y-4">
                        <div className="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Excite Electron To:</div>
                        <div className="grid grid-cols-1 gap-2">
                            {[2, 3, 4, 5, 6].map(n => (
                                <button 
                                    key={n}
                                    disabled={n <= level}
                                    onClick={() => handleExcite(n)}
                                    className={`w-full py-3 px-4 rounded font-mono text-xs flex justify-between items-center transition-all
                                        ${n <= level 
                                            ? 'bg-white/5 text-slate-600 cursor-not-allowed border border-transparent' 
                                            : 'bg-primary/10 text-primary border border-primary/30 hover:bg-primary/20 hover:border-primary'
                                        }`}
                                >
                                    <span>Energy Level n={n}</span>
                                    {n > level && <span className="material-symbols-outlined text-xs">bolt</span>}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>

                {/* Main View (Canvas) */}
                <div className="flex-1 relative bg-void overflow-hidden flex flex-col items-center justify-center border-r border-white/10">
                    <canvas ref={canvasRef} className="absolute inset-0 w-full h-full" />
                    <div className="absolute top-6 left-6 pointer-events-none">
                        <div className="text-[10px] text-slate-500 uppercase tracking-widest">Current State</div>
                        <div className="text-4xl font-bold text-white font-mono">n = {level}</div>
                    </div>
                    <div className="absolute bottom-8 text-center pointer-events-none">
                        <p className="text-slate-500 text-xs font-mono">1/λ = R (1/n₁² − 1/n₂²)</p>
                    </div>
                </div>

                {/* Right Sidebar (Energy Levels & Transitions) */}
                <div className="w-96 flex flex-col bg-surface-dark/95 backdrop-blur-md z-20 shrink-0">
                    {/* Energy Diagram */}
                    <div className="flex-1 border-b border-white/10 relative p-4 flex flex-col">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-sm font-bold text-white flex items-center gap-2"><span className="w-2 h-2 bg-red-500 rounded-sm"></span> Electron Energy Level</h3>
                        </div>
                        <div className="flex-1 relative border-l border-white/20 ml-8 mb-4">
                            {/* Axis Label */}
                            <div className="absolute -left-8 top-1/2 -translate-y-1/2 -rotate-90 text-xs text-slate-400 font-mono tracking-widest">Energy</div>
                            <div className="absolute -left-[5px] -top-2 w-0 h-0 border-l-[5px] border-l-transparent border-r-[5px] border-r-transparent border-b-[8px] border-b-white/50"></div>

                            {/* Levels */}
                            {[6, 5, 4, 3, 2, 1].map((n) => {
                                const pos = { 6: 10, 5: 18, 4: 28, 3: 40, 2: 55, 1: 90 };
                                return (
                                    <div key={n} className="absolute w-full border-t border-white/30 flex items-center" style={{ top: `${pos[n]}%` }}>
                                        <span className="ml-2 text-xs font-mono text-white">n = {n}</span>
                                    </div>
                                )
                            })}

                            {/* Transition Animation */}
                            {activeTransition && (
                                <div className="absolute inset-0 pointer-events-none overflow-hidden">
                                    <svg className="w-full h-full" viewBox="0 0 100 100" preserveAspectRatio="none">
                                        <defs>
                                            <marker id="arrow" markerWidth="4" markerHeight="4" refX="0" refY="2" orient="auto" markerUnits="strokeWidth">
                                                <path d="M0,0 L0,4 L4,2 z" fill={activeTransition.color} />
                                            </marker>
                                        </defs>
                                        {(() => {
                                            const pos = { 6: 10, 5: 18, 4: 28, 3: 40, 2: 55, 1: 90 };
                                            const y1 = pos[activeTransition.nFrom];
                                            const y2 = pos[activeTransition.nTo];
                                            // Draw a sine wave path downwards
                                            const cycles = 4;
                                            const amplitude = 2; 
                                            let pathD = `M 10 ${y1} `;
                                            const dist = y2 - y1;
                                            for(let i=0; i<=20; i++) {
                                                const t = i/20;
                                                const x = 10 + Math.sin(t * Math.PI * 2 * cycles) * amplitude;
                                                const y = y1 + t * dist;
                                                pathD += `L ${x} ${y} `;
                                            }
                                            return <path d={pathD} fill="none" stroke={activeTransition.color} strokeWidth="0.5" markerEnd="url(#arrow)" className="animate-pulse" />;
                                        })()}
                                    </svg>
                                    
                                    {/* Label Arrow and Text */}
                                    {(() => {
                                        const pos = { 6: 10, 5: 18, 4: 28, 3: 40, 2: 55, 1: 90 };
                                        const top = pos[activeTransition.nFrom];
                                        const bottom = pos[activeTransition.nTo];
                                        const midY = (top + bottom) / 2;
                                        return (
                                            <div className="absolute left-14 flex items-center gap-2" style={{ top: `${midY}%`, transform: 'translateY(-50%)', color: activeTransition.color }}>
                                                <span className="material-symbols-outlined text-sm rotate-180">arrow_right_alt</span>
                                                <span className="text-sm font-bold font-mono shadow-black drop-shadow-md">{activeTransition.wavelength} nm</span>
                                            </div>
                                        )
                                    })()}
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Transition Log */}
                    <div className="h-2/5 border-t border-white/10 p-4 flex flex-col">
                        <div className="flex justify-between items-center mb-2">
                            <h3 className="text-sm font-bold text-white">Transitions</h3>
                            <div className="flex gap-4 text-[10px] text-slate-500 font-bold uppercase">
                                <span>wavelength (nm)</span>
                                <span>n transition</span>
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto molecule-scroll space-y-1">
                            {history.map((h, i) => (
                                <div key={i} className="flex items-center justify-between py-2 border-b border-white/5 last:border-0 hover:bg-white/5 px-2 rounded transition-colors">
                                    <div className="flex items-center gap-3">
                                        <div className="w-3 h-3 rounded-full shadow-[0_0_8px]" style={{ backgroundColor: h.color, boxShadow: `0 0 8px ${h.color}` }}></div>
                                        <span className="font-mono text-sm font-bold bg-white/10 px-2 py-0.5 rounded text-white min-w-[4rem] text-center">{parseFloat(h.wavelength).toFixed(0)}</span>
                                    </div>
                                    <div className="font-mono text-xs text-slate-300">
                                        {h.n1} <span className="mx-1 text-slate-500">↔</span> {h.n2}
                                    </div>
                                </div>
                            ))}
                            {history.length === 0 && <div className="text-center text-slate-600 text-xs py-8 italic">No transitions recorded yet.</div>}
                        </div>
                    </div>
                </div>
            </div>
          );
      };

      const YoungsExperiment = ({ onClose }) => {
        const [lambda, setLambda] = useState(500); // nm
        const [distanceD, setDistanceD] = useState(2.0); // meters
        const [slitA, setSlitA] = useState(0.2); // mm
        const [intensity, setIntensity] = useState(1.0); // 0-1
        const [isFocused, setIsFocused] = useState(false);
        const [showFringeCalc, setShowFringeCalc] = useState(false);
        const [showBright, setShowBright] = useState(false);
        const [showDark, setShowDark] = useState(false);
        
        const canvasRef = useRef(null);
        const { playClick, playSlide, playEscape } = useSound();
        
        // Convert Wavelength to RGB
        const getWaveColor = (nm) => {
            if (nm < 380 || nm > 750) return { r: 255, g: 255, b: 255, hex: '#ffffff' };
            let r=0, g=0, b=0;
            if (nm >= 380 && nm < 440) { r = -(nm - 440) / (440 - 380); b = 1; }
            else if (nm >= 440 && nm < 490) { g = (nm - 440) / (490 - 440); b = 1; }
            else if (nm >= 490 && nm < 510) { g = 1; b = -(nm - 510) / (510 - 490); }
            else if (nm >= 510 && nm < 580) { r = (nm - 510) / (580 - 510); g = 1; }
            else if (nm >= 580 && nm < 645) { r = 1; g = -(nm - 645) / (645 - 580); }
            else if (nm >= 645 && nm <= 750) { r = 1; }
            
            let factor = 1.0;
            if (nm < 420) factor = 0.3 + 0.7 * (nm - 380) / (420 - 380);
            else if (nm > 700) factor = 0.3 + 0.7 * (750 - nm) / (750 - 700);
            
            const rgb = (v) => Math.round(v * factor * 255);
            return { r: rgb(r), g: rgb(g), b: rgb(b), hex: `rgb(${rgb(r)},${rgb(g)},${rgb(b)})` };
        };

        const waveColor = useMemo(() => getWaveColor(lambda), [lambda]);
        
        // Calculate Fringe Spacing (i) in mm
        // i = (lambda * D) / a
        // lambda in m (1e-9), D in m, a in m (1e-3)
        // result in meters * 1000 -> mm
        const fringeSpacingMM = useMemo(() => {
            return (lambda * 1e-9 * distanceD) / (slitA * 1e-3) * 1000;
        }, [lambda, distanceD, slitA]);

        useEffect(() => {
            const canvas = canvasRef.current;
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.clientWidth;
            const h = canvas.height = canvas.clientHeight;
            
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, w, h);
            
            // Draw Interference Pattern
            // Map pixels to mm.
            const screenPhysicalWidthMM = isFocused ? 20 : 60; // Field of view in mm
            const mmPerPixel = screenPhysicalWidthMM / w;
            
            const center = w / 2;
            const idata = ctx.createImageData(w, h);
            const data = idata.data;
            
            for(let x = 0; x < w; x++) {
                const posMM = (x - center) * mmPerPixel; // distance from center in mm
                
                // Phase difference = (pi * a * x) / (lambda * D)
                const phase = (Math.PI * (slitA * 1e-3) * (posMM * 1e-3)) / (lambda * 1e-9 * distanceD);
                const I = Math.pow(Math.cos(phase), 2) * intensity;
                
                // Color mixing
                const r = waveColor.r * I;
                const g = waveColor.g * I;
                const b = waveColor.b * I;
                
                for(let y = 0; y < h; y++) {
                    const idx = (y * w + x) * 4;
                    data[idx] = r;
                    data[idx+1] = g;
                    data[idx+2] = b;
                    data[idx+3] = 255;
                }
            }
            ctx.putImageData(idata, 0, 0);
            
            // Draw Overlays in Focused Mode
            if (isFocused) {
                // Determine max K to render based on screen width
                const maxK = Math.ceil((screenPhysicalWidthMM / 2) / fringeSpacingMM) + 1;

                const drawMarker = (k, type) => {
                    // type: 0=bright, 1=dark
                    // Standard Young's: Bright at k*i, Dark at (k+0.5)*i
                    const factor = type === 0 ? k : (k + 0.5);
                    const xMM = factor * fringeSpacingMM;
                    const xPx = center + (xMM / mmPerPixel);
                    
                    if (xPx >= -20 && xPx <= w + 20) {
                        ctx.save();
                        
                        if (type === 0) { // Bright
                            // Solid thin line, full height
                            ctx.beginPath();
                            ctx.strokeStyle = 'rgba(0, 255, 0, 0.4)';
                            ctx.lineWidth = 1;
                            ctx.setLineDash([]); // Solid
                            ctx.moveTo(xPx, 0);
                            ctx.lineTo(xPx, h);
                            ctx.stroke();
                            
                            // Label at Top
                            ctx.fillStyle = '#00ff00';
                            ctx.font = 'bold 12px monospace';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'top';
                            ctx.shadowColor = 'black';
                            ctx.shadowBlur = 4;
                            ctx.fillText(`k=${k}`, xPx, 10);
                        } else { // Dark
                            // Dashed thin line, full height
                            ctx.beginPath();
                            ctx.strokeStyle = 'rgba(255, 50, 50, 0.5)';
                            ctx.lineWidth = 1;
                            ctx.setLineDash([4, 4]);
                            ctx.moveTo(xPx, 0);
                            ctx.lineTo(xPx, h);
                            ctx.stroke();
                            
                            // Label at Bottom
                            ctx.fillStyle = '#ff5555';
                            ctx.font = 'bold 10px monospace';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';
                            ctx.shadowColor = 'black';
                            ctx.shadowBlur = 4;
                            const labelK = k >= 0 ? `${k}.5` : `${k}.5`.replace('-.', '-0.'); // fix formatting for -0.5
                            ctx.fillText(`k=${labelK}`, xPx, h - 10);
                        }
                        ctx.restore();
                    }
                };

                // Draw Center Line (White dashed) mostly for reference
                ctx.save();
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.setLineDash([8, 8]);
                ctx.beginPath(); 
                ctx.moveTo(center, 0); 
                ctx.lineTo(center, h); 
                ctx.stroke();
                ctx.restore();

                if (showBright) {
                    for(let k = -maxK; k <= maxK; k++) drawMarker(k, 0);
                }
                if (showDark) {
                    // For dark fringes, logic is (k + 0.5)i.
                    // k=0 -> 0.5i, k=-1 -> -0.5i.
                    for(let k = -maxK; k <= maxK; k++) drawMarker(k, 1);
                }
            }
            
        }, [lambda, distanceD, slitA, intensity, waveColor, isFocused, showBright, showDark, fringeSpacingMM]);

        return (
            <div className="fixed inset-0 z-[100] flex bg-[#0a1116] animate-in fade-in duration-300">
                {/* Controls Sidebar */}
                <div className="w-80 border-r border-white/10 flex flex-col bg-surface-dark/95 backdrop-blur-md p-6 overflow-y-auto shrink-0 z-20">
                    <button onClick={() => { playEscape(); onClose(); }} className="text-slate-400 hover:text-white flex items-center gap-2 text-sm mb-6"><span className="material-symbols-outlined text-sm">arrow_back</span> Back</button>
                    <h2 className="text-2xl font-bold text-white mb-1">Young's<br/><span className="text-primary">Experiment</span></h2>
                    <p className="text-xs text-slate-500 mb-8 font-mono">2D Interference Pattern</p>
                    
                    <div className="space-y-6">
                        {/* Wavelength Control */}
                        <div>
                            <div className="flex justify-between text-xs mb-2"><span className="text-slate-300">Wavelength (λ)</span><span className="font-mono text-primary">{lambda} nm</span></div>
                            <input type="range" min="350" max="800" step="1" value={lambda} onChange={(e) => { playSlide(); setLambda(Number(e.target.value)); }} className="w-full range-slider" style={{background: `linear-gradient(to right, #400080, #0000ff, #00ff00, #ffff00, #ff7f00, #ff0000)`}} />
                            <div className="w-full h-2 mt-2 rounded-full transition-colors duration-300" style={{backgroundColor: waveColor.hex}}></div>
                        </div>

                        {/* Slit Distance a */}
                        <div>
                            <div className="flex justify-between text-xs mb-2"><span className="text-slate-300">Slit Separation (a)</span><span className="font-mono text-primary">{slitA.toFixed(2)} mm</span></div>
                            <input type="range" min="0.05" max="1.0" step="0.01" value={slitA} onChange={(e) => { playSlide(); setSlitA(Number(e.target.value)); }} className="w-full range-slider" />
                        </div>

                        {/* Screen Distance D */}
                        <div>
                            <div className="flex justify-between text-xs mb-2"><span className="text-slate-300">Screen Dist (D)</span><span className="font-mono text-primary">{distanceD.toFixed(1)} m</span></div>
                            <input type="range" min="0.5" max="5.0" step="0.1" value={distanceD} onChange={(e) => { playSlide(); setDistanceD(Number(e.target.value)); }} className="w-full range-slider" />
                        </div>

                        {/* Intensity */}
                        <div>
                            <div className="flex justify-between text-xs mb-2"><span className="text-slate-300">Source Intensity</span><span className="font-mono text-primary">{(intensity*100).toFixed(0)}%</span></div>
                            <input type="range" min="0" max="1" step="0.01" value={intensity} onChange={(e) => { playSlide(); setIntensity(Number(e.target.value)); }} className="w-full range-slider" />
                        </div>
                    </div>

                    <div className="mt-8 pt-6 border-t border-white/10">
                        <div className="text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-4">Calculated Fringe Width</div>
                        <div className="bg-black/40 p-4 rounded-lg border border-white/5 text-center">
                            <div className="text-3xl font-mono font-bold text-white mb-1">{fringeSpacingMM.toFixed(2)}<span className="text-sm text-slate-400 font-normal ml-1">mm</span></div>
                            <div className="text-[10px] text-slate-500 font-mono">i = λD / a</div>
                        </div>
                    </div>
                </div>

                {/* Main View */}
                <div className="flex-1 flex flex-col relative bg-black overflow-hidden">
                    {/* Schematic View (Top Half) - Only visible if not focused */}
                    <div className={`transition-all duration-500 ease-in-out relative border-b border-white/10 overflow-hidden bg-[#050505] flex items-center ${isFocused ? 'h-0 opacity-0' : 'h-1/2 opacity-100'}`}>
                        {/* Scrollable Container for Dynamic Diagram */}
                        <div className="w-full h-full overflow-x-auto overflow-y-hidden custom-scrollbar">
                            <div className="h-full flex items-center justify-start px-12 min-w-max relative">
                                
                                {/* Source */}
                                <div className="flex flex-col items-center gap-2 relative z-10 shrink-0 mr-8">
                                    <div className="w-16 h-16 rounded-full blur-xl absolute transition-opacity duration-300" style={{backgroundColor: waveColor.hex, opacity: intensity * 0.8}}></div>
                                    <div className="w-4 h-4 bg-white rounded-full shadow-[0_0_20px_white] z-10 relative transition-opacity duration-300" style={{opacity: 0.3 + intensity * 0.7}}></div>
                                    <span className="text-[10px] text-slate-500 uppercase tracking-widest mt-4">Source</span>
                                </div>

                                {/* Beam 1 */}
                                <div className="w-24 h-[1px] relative shrink-0">
                                    <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/50 to-transparent opacity-50"></div>
                                </div>

                                {/* Single Slit */}
                                <div className="h-40 w-px bg-slate-700 relative group shrink-0 mx-4 flex flex-col justify-center items-center">
                                    <div className="w-1 h-32 bg-slate-900 border border-slate-700 absolute"></div>
                                    <div className="w-2 h-4 bg-black relative z-10 border-y border-slate-800"></div>
                                    <span className="absolute -bottom-8 text-[10px] text-slate-500 whitespace-nowrap">Single Slit</span>
                                </div>

                                {/* Beam 2 (Diverging) */}
                                <div className="w-32 h-32 relative shrink-0 opacity-30 flex items-center">
                                     <div className="w-full h-full" style={{background: `linear-gradient(to right, ${waveColor.hex}22, transparent)`}}>
                                         <div className="w-full h-[1px] bg-white/20 absolute top-1/2 transform -translate-y-1/2"></div>
                                     </div>
                                </div>

                                {/* Double Slit (Dynamic) */}
                                <div className="h-48 w-4 bg-slate-800 relative border border-white/10 shrink-0 rounded flex flex-col justify-center items-center overflow-hidden">
                                    {/* The slit blocks move to create the gap 'a' */}
                                    {/* Base height 50%, subtract half of scaled gap. Scaled visually by 40 for impact */}
                                    <div className="w-full bg-black absolute top-0 border-b border-white/20 transition-all duration-300" style={{ height: `calc(50% - ${Math.min(48, slitA * 40)}px)` }}></div>
                                    <div className="w-full bg-black absolute bottom-0 border-t border-white/20 transition-all duration-300" style={{ height: `calc(50% - ${Math.min(48, slitA * 40)}px)` }}></div>
                                    <span className="absolute -bottom-10 text-[10px] text-slate-500 whitespace-nowrap">Double Slit</span>
                                </div>

                                {/* Interference Area (Dynamic Width D) */}
                                {/* Map 0.5m -> 100px, 5.0m -> 800px linearly */}
                                <div className="relative h-full transition-all duration-500 ease-out flex items-center" 
                                     style={{ width: `${100 + (distanceD - 0.5) * 150}px` }}>
                                     
                                     {/* Dynamic Beams */}
                                     <div className="absolute inset-0 overflow-hidden transition-opacity duration-300" style={{opacity: intensity * 0.6}}>
                                         {/* Upper Ray */}
                                         <div className="absolute top-1/2 left-0 w-full h-[1px] bg-gradient-to-r from-white/50 to-transparent origin-left" 
                                              style={{transform: `rotate(-${3 + distanceD}deg)`}}></div>
                                         {/* Lower Ray */}
                                         <div className="absolute top-1/2 left-0 w-full h-[1px] bg-gradient-to-r from-white/50 to-transparent origin-left" 
                                              style={{transform: `rotate(${3 + distanceD}deg)`}}></div>
                                         
                                         {/* Interference Gradient */}
                                         <div className="absolute right-0 top-0 bottom-0 w-1/2 bg-gradient-to-l from-current to-transparent" style={{color: waveColor.hex}}></div>
                                     </div>
                                </div>

                                {/* Screen */}
                                <div className="h-3/4 w-2 bg-white/80 relative shrink-0 shadow-[0_0_30px_rgba(255,255,255,0.3)] rounded-sm">
                                    <span className="absolute -bottom-8 left-1/2 -translate-x-1/2 text-[10px] text-slate-500 whitespace-nowrap font-bold">Screen</span>
                                </div>
                                
                                {/* Padding right */}
                                <div className="w-24 shrink-0"></div>
                            </div>
                        </div>
                        
                        <button onClick={() => { playClick(); setIsFocused(true); }} className="absolute bottom-4 right-4 bg-white/10 hover:bg-white/20 text-white px-4 py-2 rounded-full text-xs font-bold backdrop-blur-md flex items-center gap-2 transition-all border border-white/10 hover:border-primary/50 shadow-lg z-30"><span className="material-symbols-outlined text-sm">center_focus_strong</span> Focus Screen</button>
                    </div>

                    {/* Pattern Screen (Bottom Half / Full) */}
                    <div className={`flex-1 relative transition-all duration-500 bg-black overflow-hidden flex flex-col`}>
                        <canvas ref={canvasRef} className="w-full h-full object-cover block" />
                        
                        {isFocused && (
                            <div className="absolute top-4 left-4 z-10 flex flex-col gap-2 pointer-events-auto">
                                <button onClick={() => { playClick(); setIsFocused(false); }} className="bg-black/50 hover:bg-black/80 text-white px-4 py-2 rounded-full text-xs font-bold backdrop-blur-md border border-white/20 self-start flex items-center gap-2 shadow-lg"><span className="material-symbols-outlined text-sm">fullscreen_exit</span> Exit Focus</button>
                                
                                <div className="bg-black/80 backdrop-blur-md p-4 rounded-lg border border-white/10 mt-2 w-72 space-y-3 shadow-2xl">
                                    <div className="flex items-center justify-between">
                                        <span className="text-xs text-slate-300">Fringe Spacing Formula</span>
                                        <input type="checkbox" checked={showFringeCalc} onChange={(e) => { playClick(); setShowFringeCalc(e.target.checked); }} className="accent-primary h-4 w-4"/>
                                    </div>
                                    {showFringeCalc && (
                                        <div className="text-xs font-mono text-primary border-t border-white/10 pt-2 mt-1">
                                            i = {lambda}e-9 * {distanceD} / {slitA}e-3
                                            <br/>
                                            = <span className="font-bold text-white">{fringeSpacingMM.toFixed(3)} mm</span>
                                        </div>
                                    )}
                                    <div className="flex items-center justify-between">
                                        <span className="text-xs text-green-400 font-bold">Bright Fringes (Top)</span>
                                        <input type="checkbox" checked={showBright} onChange={(e) => { playClick(); setShowBright(e.target.checked); }} className="accent-green-500 h-4 w-4"/>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <span className="text-xs text-red-400 font-bold">Dark Fringes (Bottom)</span>
                                        <input type="checkbox" checked={showDark} onChange={(e) => { playClick(); setShowDark(e.target.checked); }} className="accent-red-500 h-4 w-4"/>
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {!isFocused && <div className="absolute top-4 left-4 text-[10px] text-slate-500 uppercase tracking-widest font-bold bg-black/50 px-2 py-1 rounded backdrop-blur">Interference Pattern Output</div>}
                    </div>
                </div>
            </div>
        );
      };

      const Toggle = ({ label, checked, onChange }) => {
          const { playClick } = useSound();
          return (
              <label className="flex items-center gap-2 cursor-pointer group checkbox-wrapper mb-2 select-none" onClick={playClick}> 
                  <div className="relative"> 
                      <input type="checkbox" className="sr-only" checked={checked} onChange={(e) => onChange(e.target.checked)} /> 
                      <div className="block bg-slate-800 w-10 h-6 rounded-full border border-slate-600 transition-colors"></div> 
                      <div className={`dot absolute left-1 top-1 bg-white w-4 h-4 rounded-full transition-transform ${checked ? 'translate-x-4 bg-white' : ''}`}></div> 
                  </div> 
                  <span className={`text-sm ${checked ? 'text-white' : 'text-slate-500'} group-hover:text-white transition-colors`}>{label}</span> 
              </label> 
          );
      };

      const MolecularViewer = ({ onClose }) => {
        const mountRef = useRef(null); 
        const [selectedMoleculeName, setSelectedMoleculeName] = useState("Benzene"); 
        const [searchQuery, setSearchQuery] = useState(""); 
        const [showPi, setShowPi] = useState(false); 
        const [showTau, setShowTau] = useState(false); 
        const [showIonic, setShowIonic] = useState(false); 
        const [showVDW, setShowVDW] = useState(false); 
        const [error, setError] = useState(null); 
        
        const labelsRef = useRef([]); 
        const moleculeList = useMemo(() => Object.keys(MOLECULES).filter(name => name.toLowerCase().includes(searchQuery.toLowerCase())), [searchQuery]); 
        
        const { playClick, playSlide, playEscape } = useSound();

        const moleculeInfo = useMemo(() => {
            const data = MOLECULES[selectedMoleculeName];
            if (!data) return { formula: [], mass: 0, elements: [] };
            const counts = {}; data.atoms.forEach(a => counts[a.el] = (counts[a.el] || 0) + 1);
            let keys = Object.keys(counts).sort();
            if (keys.includes('C')) { keys = keys.filter(k => k !== 'C' && k !== 'H'); keys.unshift('C'); if (counts['H']) keys.splice(1, 0, 'H'); } else { keys.sort(); }
            const formula = keys.map(k => ({ el: k, count: counts[k] }));
            const mass = data.atoms.reduce((sum, atom) => sum + (ATOMIC_MASSES[atom.el] || 0), 0);
            return { formula, mass, elements: keys };
        }, [selectedMoleculeName]);

        const createLabel = (text) => {
            const canvas = document.createElement('canvas'); canvas.width = 64; canvas.height = 64; const ctx = canvas.getContext('2d');
            ctx.font = 'bold 24px Arial'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.strokeStyle = 'rgba(0,0,0,0.8)'; ctx.lineWidth = 2; ctx.strokeText(text, 32, 32);
            const gradient = ctx.createLinearGradient(0, 10, 0, 54); gradient.addColorStop(0, '#ffffff'); gradient.addColorStop(1, '#999999'); ctx.fillStyle = gradient; ctx.fillText(text, 32, 32);
            const texture = new THREE.CanvasTexture(canvas); const material = new THREE.SpriteMaterial({ map: texture, depthTest: true, depthWrite: false }); const sprite = new THREE.Sprite(material); sprite.scale.set(0.5, 0.5, 0.5); return sprite;
        };

        const createChargeVisualization = (atom, role) => {
            const size = 1.0; const ext = 0.25; const color = role === 'cation' ? 0xff0000 : 0x0066ff; const group = new THREE.Group(); group.position.set(atom.x, atom.y, atom.z); const half = size / 2;
            const corners = [[1,1,1], [1,1,-1], [1,-1,1], [1,-1,-1], [-1,1,1], [-1,1,-1], [-1,-1,1], [-1,-1,-1]]; const points = [];
            corners.forEach(c => { const x = c[0]*half; const y = c[1]*half; const z = c[2]*half; points.push(new THREE.Vector3(x,y,z), new THREE.Vector3(x - c[0]*ext, y, z)); points.push(new THREE.Vector3(x,y,z), new THREE.Vector3(x, y - c[1]*ext, z)); points.push(new THREE.Vector3(x,y,z), new THREE.Vector3(x, y, z - c[2]*ext)); });
            const geo = new THREE.BufferGeometry().setFromPoints(points); const line = new THREE.LineSegments(geo, new THREE.LineBasicMaterial({ color })); group.add(line); return group;
        };

        useEffect(() => {
            if (!window.THREE) { setError("Three.js not loaded"); return; }
            if (!mountRef.current) return;
            const width = mountRef.current.clientWidth; const height = mountRef.current.clientHeight; 
            const scene = new THREE.Scene(); scene.fog = new THREE.Fog(0x111111, 5, 25); 
            const camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 100); camera.position.z = 8; camera.position.y = 2; 
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true }); renderer.setSize(width, height); mountRef.current.appendChild(renderer.domElement); 
            const controls = new THREE.OrbitControls(camera, renderer.domElement); 
            const ambientLight = new THREE.AmbientLight(0x404040, 2); scene.add(ambientLight); 
            const pointLight = new THREE.PointLight(0xffffff, 1, 100); pointLight.position.set(10, 10, 10); scene.add(pointLight); 
            const moleculeGroup = new THREE.Group(); scene.add(moleculeGroup);
            
            const renderMolecule = () => {
                while(moleculeGroup.children.length > 0) moleculeGroup.remove(moleculeGroup.children[0]); labelsRef.current = []; const data = MOLECULES[selectedMoleculeName]; if(!data) return;
                data.atoms.forEach(atom => { 
                    const radius = ELEMENT_RADII[atom.el] || 0.3; const color = ELEMENT_COLORS[atom.el] || 0xffffff; 
                    const sphere = new THREE.Mesh(new THREE.SphereGeometry(radius, 32, 32), new THREE.MeshPhysicalMaterial({ color: color, roughness: 0.3, metalness: 0.2 })); sphere.position.set(atom.x, atom.y, atom.z); moleculeGroup.add(sphere); 
                    const label = createLabel(atom.el); moleculeGroup.add(label); labelsRef.current.push({ sprite: label, atomPos: new THREE.Vector3(atom.x, atom.y, atom.z), radius });
                    if (showIonic && atom.role) { const chargeVis = createChargeVisualization(atom, atom.role); moleculeGroup.add(chargeVis); }
                    if (showPi && atom.el === 'C') { const hasDouble = data.bonds.some(b => (b.source === atom.id || b.target === atom.id) && b.type === 'double'); if (hasDouble) { const lobeGeo = new THREE.SphereGeometry(0.25, 16, 16); lobeGeo.scale(1, 1, 1.8); const topLobe = new THREE.Mesh(lobeGeo, new THREE.MeshBasicMaterial({ color: 0x00ff00, transparent: true, opacity: 0.4, side: THREE.DoubleSide })); const botLobe = new THREE.Mesh(lobeGeo, new THREE.MeshBasicMaterial({ color: 0xff00ff, transparent: true, opacity: 0.4, side: THREE.DoubleSide })); topLobe.position.set(atom.x, atom.y, atom.z + 0.4); botLobe.position.set(atom.x, atom.y, atom.z - 0.4); moleculeGroup.add(topLobe); moleculeGroup.add(botLobe); } }
                });
                data.bonds.forEach(bond => { 
                    const s = data.atoms[bond.source], t = data.atoms[bond.target]; const start = new THREE.Vector3(s.x, s.y, s.z), end = new THREE.Vector3(t.x, t.y, t.z); const dist = start.distanceTo(end), mid = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5); const orient = new THREE.Matrix4().lookAt(start, end, new THREE.Object3D().up).multiply(new THREE.Matrix4().makeRotationX(Math.PI/2));
                    if (bond.type === 'ionic' && showIonic) { const lineGeo = new THREE.BufferGeometry().setFromPoints([start, end]); const getColor = (atom) => { if (atom.role === 'cation') return [1, 0, 0]; if (atom.role === 'anion') return [0, 0, 1]; return [1, 1, 1]; }; const c1 = getColor(s); const c2 = getColor(t); const colors = new Float32Array([...c1, ...c2]); lineGeo.setAttribute('color', new THREE.BufferAttribute(colors, 3)); const line = new THREE.Line(lineGeo, new THREE.LineDashedMaterial({ vertexColors: true, dashSize: 0.1, gapSize: 0.1, opacity: 0.8, transparent: true, scale: 1 })); line.computeLineDistances(); moleculeGroup.add(line); return; }
                    if (bond.type === 'vdw' && showVDW) { const lineGeo = new THREE.BufferGeometry().setFromPoints([start, end]); const line = new THREE.Line(lineGeo, new THREE.LineDashedMaterial({ color: 0xffffff, dashSize: 0.1, gapSize: 0.1, opacity: 0.5, transparent: true })); line.computeLineDistances(); moleculeGroup.add(line); return; }
                    if (bond.type === 'double' && showTau) { const curveHeight = 0.3; const direction = new THREE.Vector3().subVectors(end, start).normalize(); const up = new THREE.Vector3(0,0,1); let perp = new THREE.Vector3().crossVectors(direction, up).normalize().multiplyScalar(curveHeight); if (perp.lengthSq() < 0.001) perp = new THREE.Vector3(curveHeight,0,0); const c1 = new THREE.QuadraticBezierCurve3(start, mid.clone().add(perp), end); const c2 = new THREE.QuadraticBezierCurve3(start, mid.clone().sub(perp), end); [c1, c2].forEach(curve => { const tube = new THREE.Mesh(new THREE.TubeGeometry(curve, 10, 0.06, 8, false), new THREE.MeshStandardMaterial({ color: 0x888888 })); moleculeGroup.add(tube); }); } else { const radius = bond.type === 'double' ? 0.08 : 0.05; const cyl = new THREE.Mesh(new THREE.CylinderGeometry(radius, radius, dist, 12), new THREE.MeshStandardMaterial({ color: 0x888888 })); cyl.applyMatrix4(orient); cyl.position.copy(mid); moleculeGroup.add(cyl); }
                });
            };
            renderMolecule();
            const animate = () => { requestAnimationFrame(animate); controls.update(); if (labelsRef.current && camera) { labelsRef.current.forEach(item => { const dir = new THREE.Vector3().subVectors(camera.position, item.atomPos).normalize(); item.sprite.position.copy(item.atomPos).add(dir.multiplyScalar(item.radius + 0.35)); }); } renderer.render(scene, camera); }; 
            animate();
            return () => { if (mountRef.current && renderer) mountRef.current.removeChild(renderer.domElement); renderer.dispose(); };
        }, [selectedMoleculeName, showPi, showTau, showIonic, showVDW]);

        return (
            <div className="fixed inset-0 z-[100] flex bg-black/95 backdrop-blur-xl animate-in fade-in duration-300">
                <div className="w-80 border-r border-white/10 bg-[#0a0f14] flex flex-col p-6 z-10 shrink-0">
                    <button onClick={() => { playEscape(); onClose(); }} className="mb-6 flex items-center gap-2 text-slate-400 hover:text-white transition-colors"><span className="material-symbols-outlined">arrow_back</span> Back</button>
                    <h2 className="text-2xl font-bold text-white mb-2">Molecular<br/><span className="text-primary">Viewer</span></h2>
                    <div className="mb-6 space-y-2 border-b border-white/10 pb-6"> <Toggle label="Pi Orbitals (π)" checked={showPi} onChange={setShowPi} /> <Toggle label="Tau Bonds (τ)" checked={showTau} onChange={setShowTau} /> <Toggle label="Van der Waals (Connection)" checked={showVDW} onChange={setShowVDW} /> <Toggle label="Charge Configs (Cube)" checked={showIonic} onChange={setShowIonic} /> </div>
                    <div className="relative mb-6"><span className="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-sm">search</span><input type="text" placeholder="Search..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full bg-black/50 border border-white/10 rounded-lg py-2 pl-9 pr-4 text-sm text-white"/></div>
                    <div className="flex-1 overflow-y-auto molecule-scroll pr-2 space-y-2 mb-6">{moleculeList.map(name => (<button key={name} onClick={() => { playClick(); setSelectedMoleculeName(name); }} className={`w-full text-left px-4 py-3 rounded-lg text-sm transition-all flex justify-between ${selectedMoleculeName === name ? 'bg-primary/20 text-primary border border-primary/50' : 'text-slate-400 hover:bg-white/5'}`}>{name}</button>))}</div>
                </div>
                <div className="flex-1 relative bg-gradient-to-br from-gray-900 to-black">
                    <div ref={mountRef} className="w-full h-full cursor-move" />
                    <div className="absolute top-0 left-0 w-full p-6 flex justify-center items-start pointer-events-none"> <div className="bg-black/50 backdrop-blur-md px-6 py-3 rounded-xl border border-white/10 text-center flex gap-8 shadow-2xl"> <div> <div className="text-[10px] text-slate-400 uppercase tracking-widest font-mono mb-1">Chemical Formula</div> <div className="text-2xl font-bold text-white font-mono tracking-tight"> {moleculeInfo.formula.map((f, i) => ( <span key={i}>{f.el}<sub className="text-sm text-slate-300">{f.count > 1 ? f.count : ''}</sub></span> ))} </div> </div> <div className="w-px bg-white/10"></div> <div> <div className="text-[10px] text-slate-400 uppercase tracking-widest font-mono mb-1">Molar Mass</div> <div className="text-2xl font-bold text-primary font-mono">{moleculeInfo.mass.toFixed(2)} <span className="text-xs text-slate-400 font-normal">g/mol</span></div> </div> </div> </div>
                    <div className="absolute bottom-6 right-6 bg-black/60 backdrop-blur p-4 rounded-xl border border-white/10 flex flex-col gap-3 pointer-events-none"> <div className="text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1 border-b border-white/10 pb-2">Element Legend</div> {moleculeInfo.elements.map(el => ( <div key={el} className="flex items-center gap-3 text-xs text-slate-300"> <div className="w-3 h-3 rounded-full border border-white/20" style={{ backgroundColor: '#' + ELEMENT_COLORS[el].toString(16).padStart(6, '0') }}></div> <span className="font-mono">{el}</span> <span className="opacity-50 text-[10px]">{ELEMENT_NAMES[el]}</span> </div> ))} </div>
                </div>
            </div>
        );
      };

      // --- Contact Component ---
      const Contact = () => {
        const { playClick } = useSound();
        return (
           <section id="contact" className="py-32 px-4 sm:px-6 relative overflow-hidden bg-void">
            <ShootingStars />
            <div className="absolute top-0 w-full h-px bg-gradient-to-r from-transparent via-secondary/50 to-transparent"></div>
            <div className="mx-auto max-w-2xl text-center relative z-10">
              <h2 className="text-4xl font-black text-white mb-6 sm:text-6xl tracking-tighter">Signal Received?</h2>
              <p className="text-lg text-slate-400 mb-12 font-light">Ready to collaborate on the next frontier of web design? <br className="hidden sm:block"/> My frequency is open for new opportunities.</p>
              <div className="flex flex-col sm:flex-row gap-6 justify-center">
                <a href="mailto:nguyennhathanhhuy@gmail.com" onClick={playClick} className="flex items-center justify-center gap-3 bg-[#0a0f14]/80 backdrop-blur border border-slate-800 hover:border-secondary text-white px-8 py-4 rounded-lg transition-all group shadow-lg hover:shadow-neon-purple"><span className="material-symbols-outlined text-secondary group-hover:animate-pulse">mail</span><span className="font-medium tracking-wide">nguyennhathanhhuy@gmail.com</span></a>
                <div className="flex gap-4 justify-center items-center">{['GitHub', 'LinkedIn'].map((platform) => (<a key={platform} href="#" onClick={playClick} className={`h-14 w-14 flex items-center justify-center rounded-lg bg-[#0a0f14]/80 backdrop-blur border border-slate-800 text-slate-400 hover:text-white hover:border-${platform === 'GitHub' ? 'primary' : 'secondary'} hover:shadow-${platform === 'GitHub' ? 'neon' : 'neon-purple'} transition-all`} aria-label={platform}><span className="material-symbols-outlined">{platform === 'GitHub' ? 'code_blocks' : 'person_search'}</span></a>))}</div>
              </div>
            </div>
          </section>
        );
      };

      // --- Black Hole Background ---
      const BlackHoleBackground = ({ progress }) => {
        const canvasRef = useRef(null); const angleRef = useRef(0);
        useEffect(() => {
          const canvas = canvasRef.current; const ctx = canvas.getContext('2d');
          const render = () => {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            const w = canvas.width; const h = canvas.height; const cx = w / 2; const cy = h / 2;
            ctx.fillStyle = '#020204'; ctx.fillRect(0, 0, w, h);
            for(let i=0; i<150; i++) {
                const x = (Math.sin(i * 123.456) * 9999) % w; const y = (Math.cos(i * 654.321) * 9999) % h;
                const size = (Math.sin(i) + 1.5) * 0.8; const opacity = (Math.cos(i) + 1) * 0.3 + 0.1;
                ctx.fillStyle = `rgba(255,255,255,${Math.abs(opacity)})`; ctx.beginPath(); ctx.arc(Math.abs(x), Math.abs(y), size, 0, Math.PI * 2); ctx.fill();
            }
            const p = progress; const merged = p > 0.98; const maxSep = Math.min(w, h) * 0.25;
            const currentOrbitRadius = merged ? 0 : (maxSep/2) * (1 - p);
            angleRef.current += 0.02 + (Math.pow(p, 3) * 0.15); const angle = angleRef.current;
            ctx.save(); ctx.translate(cx, cy);
            if (!merged) {
                ctx.save(); ctx.rotate(angle * 0.2); 
                for(let i=0; i<8; i++) {
                    const waveR = ((i/8 + Date.now()/10000 * (0.1+p*0.4)) % 1) * Math.max(w,h)*0.6;
                    ctx.strokeStyle = `rgba(100, 100, 255, ${(p * 0.6 + 0.1) * (1 - waveR/Math.max(w,h))})`;
                    ctx.lineWidth = 1 + p * 5; ctx.beginPath(); ctx.ellipse(0, 0, waveR, waveR * (1 - p * 0.1), -angle, 0, Math.PI * 2); ctx.stroke();
                }
                ctx.restore();
            }
            const drawBH = (x, y, r, c) => {
                const grad = ctx.createRadialGradient(x, y, r * 0.8, x, y, r * 3); grad.addColorStop(0, '#000'); grad.addColorStop(0.2, c); grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(x, y, r * 3, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(x, y, r * 0.95, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.shadowColor = c; ctx.shadowBlur = 15; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.stroke(); ctx.shadowBlur = 0;
            };
            if(merged) drawBH(0,0,32,'rgba(150, 200, 255, 0.9)');
            else {
                drawBH(Math.cos(angle)*currentOrbitRadius, Math.sin(angle)*currentOrbitRadius, 20, 'rgba(6, 188, 249, 0.8)');
                drawBH(Math.cos(angle+Math.PI)*currentOrbitRadius, Math.sin(angle+Math.PI)*currentOrbitRadius, 20, 'rgba(168, 85, 247, 0.8)');
            }
            ctx.restore();
          };
          const animId = requestAnimationFrame(function loop() { render(); requestAnimationFrame(loop); });
          return () => cancelAnimationFrame(animId);
        }, [progress]);
        return <canvas ref={canvasRef} className="absolute inset-0 z-0 h-full w-full object-cover" />;
      };

      const Navbar = () => {
        const [isOpen, setIsOpen] = useState(false);
        const [scrolled, setScrolled] = useState(false);
        const { playClick } = useSound();
        useEffect(() => { const h = () => setScrolled(window.scrollY > 20); window.addEventListener('scroll', h); return () => window.removeEventListener('scroll', h); }, []);
        return (
          <nav className={`fixed top-0 z-50 w-full border-b transition-colors duration-300 ${scrolled ? 'border-white/5 bg-background-dark/90 backdrop-blur-md' : 'border-transparent bg-transparent'}`}>
            <div className="mx-auto flex h-16 max-w-7xl items-center justify-between px-6 lg:px-8">
              <div className="flex items-center gap-4"><div className="h-10 w-10 rounded-full bg-cover bg-center ring-2 ring-primary/50 shadow-neon" style={{ backgroundImage: `url('${PROFILE_AVATAR}')` }}/><span className="text-lg font-bold tracking-tight text-white hidden sm:block">Thanh Huy</span></div>
              <div className="hidden md:flex items-center gap-8">{NAV_ITEMS.map((item) => (<a key={item.label} href={item.href} onClick={playClick} className="text-sm font-medium text-slate-300 hover:text-primary transition-colors">{item.label}</a>))}</div>
              <button onClick={() => { playClick(); setIsOpen(!isOpen); }} className="md:hidden p-2 text-slate-300 hover:text-white"><span className="material-symbols-outlined">{isOpen ? 'close' : 'menu'}</span></button>
            </div>
            {isOpen && (<div className="md:hidden absolute top-16 left-0 w-full bg-background-dark/95 border-b border-white/5 backdrop-blur-md py-4"><div className="flex flex-col items-center gap-4">{NAV_ITEMS.map((item) => (<a key={item.label} href={item.href} onClick={() => { playClick(); setIsOpen(false); }} className="text-base font-medium text-slate-300 hover:text-primary transition-colors">{item.label}</a>))}</div></div>)}
          </nav>
        );
      };

      const Hero = () => {
        const [timeData, setTimeData] = useState(100); const [isControlOpen, setIsControlOpen] = useState(true);
        const { playClick, playSlide } = useSound();
        return (
          <section id="home" className="relative flex min-h-[90vh] flex-col items-center justify-center overflow-hidden px-4 sm:px-6 bg-[#020204]">
            <BlackHoleBackground progress={timeData / 100} />
            <div className="absolute inset-0 z-0 bg-gradient-to-t from-background-dark via-transparent to-background-dark/50 pointer-events-none"></div>
            <div className="relative z-10 mx-auto max-w-5xl text-center mt-10 pointer-events-none">
              <p className="mb-4 text-xs font-bold uppercase tracking-[0.2em] text-primary/80">2026 Portfolio</p>
              <h1 className="mb-6 text-5xl font-black leading-tight tracking-tight text-white sm:text-7xl lg:text-8xl drop-shadow-2xl">Atomizing the <span className="text-transparent bg-clip-text bg-gradient-to-r from-primary via-cyan-300 to-white">Celestial</span> <br/><span className="text-transparent bg-clip-text bg-gradient-to-r from-secondary via-purple-400 to-white">Bodies</span></h1>
              <p className="mx-auto mb-10 max-w-2xl text-lg font-light leading-relaxed text-slate-300 sm:text-xl drop-shadow-md">I'm <span className="text-white font-medium">Thanh Huy</span>. I am a student who is dedicated to <GradientText>chemistry and astronomy</GradientText>. I use my coding skills to create digital experiences.</p>
            </div>
            <div className="relative z-20 flex flex-col sm:flex-row gap-4 justify-center items-center">
              <a href="#projects" onClick={playClick} className="group relative flex h-12 items-center justify-center overflow-hidden rounded-full bg-primary px-8 text-sm font-bold text-[#020204] transition-all hover:bg-cyan-300 hover:shadow-neon"><span className="relative z-10 mr-2">Explore Universe</span><span className="material-symbols-outlined relative z-10 text-[20px] transition-transform group-hover:translate-x-1">rocket_launch</span></a>
              <a href="#contact" onClick={playClick} className="flex h-12 items-center justify-center rounded-full border border-slate-700 px-8 text-sm font-bold text-white transition-colors hover:border-secondary hover:text-secondary hover:shadow-neon-purple bg-surface-dark/50 backdrop-blur-sm">Contact Me</a>
            </div>
            <div className="absolute bottom-10 left-0 right-0 mx-auto w-full max-w-md z-30 px-6 flex justify-center">
                {isControlOpen ? (<div className="w-full bg-surface-dark/60 backdrop-blur-md p-4 rounded-xl border border-white/10 shadow-2xl animate-in fade-in slide-in-from-bottom-4 duration-500"><div className="flex justify-between items-center mb-3"><div className="flex justify-between text-[10px] text-primary uppercase font-mono tracking-widest gap-4"><span>Binary System</span><span>Singularity</span></div><button onClick={() => { playClick(); setIsControlOpen(false); }} className="text-slate-400 hover:text-white transition-colors"><span className="material-symbols-outlined text-sm">remove</span></button></div><input type="range" min="0" max="100" value={timeData} onChange={(e) => { playSlide(); setTimeData(Number(e.target.value)); }} className="range-slider"/><div className="flex justify-between items-center mt-2"><span className="text-[10px] text-slate-400 font-mono">T-Minus: {(100 - timeData).toFixed(0)} units</span><span className={`text-[10px] font-mono transition-colors ${timeData > 95 ? 'text-red-500 animate-pulse font-bold' : 'text-slate-500'}`}>{timeData > 95 ? 'CRITICAL: MERGER IMMINENT' : 'STATUS: STABLE ORBIT'}</span></div></div>) : (<button onClick={() => { playClick(); setIsControlOpen(true); }} className="flex items-center gap-2 bg-surface-dark/40 backdrop-blur-sm border border-white/10 hover:border-primary/50 text-slate-300 hover:text-white px-4 py-2 rounded-full transition-all shadow-lg hover:shadow-neon"><span className="material-symbols-outlined text-sm">tune</span><span className="text-xs font-bold uppercase tracking-wider">Initialize Controls</span></button>)}
            </div>
          </section>
        );
      };

      const Projects = ({ onOpenProject }) => {
        const { playClick } = useSound();
        return (
          <section id="projects" className="py-24 px-4 sm:px-6 lg:px-8 relative bg-void overflow-hidden">
            <div className="absolute inset-0 z-0 bg-stars opacity-40"></div>
            <div className="absolute top-0 right-0 w-[600px] h-[600px] bg-secondary/20 blur-[130px] rounded-full pointer-events-none"></div>
            <div className="absolute bottom-0 left-0 w-[700px] h-[700px] bg-primary/10 blur-[130px] rounded-full pointer-events-none"></div>
            <div className="relative z-10 mx-auto max-w-6xl">
              <div className="flex items-end justify-between mb-16 border-b border-white/10 pb-6"><div><span className="text-secondary font-mono text-sm tracking-widest mb-2 block">SELECTED WORKS</span><h2 className="text-3xl font-bold text-white sm:text-4xl">Exploration Log</h2></div><a href="#" onClick={playClick} className="hidden sm:flex items-center gap-2 text-sm font-medium text-slate-400 hover:text-secondary transition-colors">Full Archive <span className="material-symbols-outlined text-[16px]">arrow_forward</span></a></div>
              <div className="grid grid-cols-1 gap-10 md:grid-cols-2 lg:grid-cols-3">
                {PROJECTS.map((project, idx) => (
                  <div key={idx} onClick={() => { playClick(); onOpenProject(project.id); }} className={`group relative cursor-pointer overflow-hidden rounded-xl bg-[#0a0f14] border border-white/5 transition-all duration-300 hover:-translate-y-2 hover:border-${project.color === 'primary' ? 'primary' : 'secondary'}/50 hover:shadow-neon${project.color !== 'primary' ? '-purple' : ''}`}>
                    <div className="aspect-[4/3] w-full overflow-hidden relative"><div className="h-full w-full bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style={{ backgroundImage: `url('${project.image}')`, filter: 'brightness(0.8) contrast(1.2)' }}><div className="absolute inset-0 bg-gradient-to-t from-[#0a0f14] via-transparent to-transparent opacity-90"></div></div><div className={`absolute top-4 right-4 bg-${project.color === 'primary' ? 'primary' : 'purple-500'}/20 backdrop-blur-md border border-${project.color === 'primary' ? 'primary' : 'purple-500'}/30 text-${project.color === 'primary' ? 'primary' : 'purple-300'} text-xs font-bold px-3 py-1 rounded-full`}>{project.category}</div></div>
                    <div className="absolute bottom-0 left-0 w-full p-6"><h3 className={`text-xl font-bold text-white group-hover:text-${project.color} transition-colors`}>{project.title}</h3><p className="mt-2 text-sm text-slate-400 line-clamp-2">{project.description}</p><div className="mt-4 flex gap-2">{project.tags.map(tag => (<span key={tag} className="text-[10px] uppercase tracking-wider text-slate-500 font-mono">{tag}</span>))}</div></div>
                  </div>
                ))}
              </div>
            </div>
          </section>
        );
      };

      const About = () => {
        return (
          <section id="about" className="py-24 px-4 sm:px-6 lg:px-8 bg-[#050505] relative overflow-hidden">
            <div className="absolute top-0 right-0 w-[400px] h-[400px] bg-primary/10 blur-[100px] rounded-full pointer-events-none"></div>
            <div className="absolute bottom-0 left-0 w-[400px] h-[400px] bg-secondary/10 blur-[100px] rounded-full pointer-events-none"></div>
            <div className="mx-auto max-w-4xl relative z-10">
              <div className="mb-16 text-center"><h2 className="text-3xl font-bold text-white sm:text-4xl"><span className="text-primary">Tech</span> & <span className="text-secondary">Science</span> Stack</h2></div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-16 items-center">
                <div className="space-y-6 order-2 md:order-1"><h3 className="text-xl font-bold text-white flex items-center gap-2"><span className="material-symbols-outlined text-secondary">science</span> Scientific Methodology</h3><p className="text-slate-400 leading-relaxed">My approach is akin to the meticulous observation of celestial phenomena—patient, precise, and deeply analytical. Driven by an unyielding curiosity to decode the underlying mechanisms of our digital universe, I treat every project as a unique stellar formation, ensuring that every line of code and pixel aligns with the gravitational pull of the user's needs. Just as the cosmos is built upon fundamental laws, I construct digital experiences grounded in robust logic and boundless creativity.</p><div className="pt-4"><a href="#" className="inline-flex items-center text-white border-b border-primary pb-1 hover:text-primary transition-colors font-medium">Analyze Resume <span className="material-symbols-outlined ml-2 text-lg">download</span></a></div></div>
                <div className="grid grid-cols-2 gap-4 order-1 md:order-2">{TECH_STACK.map((tech) => (<div key={tech.title} className={`bg-surface-dark/50 backdrop-blur-sm p-5 rounded-lg border border-slate-800 hover:border-${tech.color.includes('primary') ? 'primary' : 'secondary'} transition-all group`}><span className={`material-symbols-outlined ${tech.color} mb-3 text-3xl group-hover:scale-110 transition-transform`}>{tech.icon}</span><h4 className="text-white font-bold text-sm uppercase tracking-wider">{tech.title}</h4><p className="text-xs text-slate-500 mt-1 font-mono">{tech.desc}</p></div>))}</div>
              </div>
            </div>
          </section>
        );
      };

      const Footer = () => {
        return (
          <footer className="border-t border-white/5 bg-void py-10 px-6 text-center">
            <p className="text-slate-600 text-sm font-mono">&copy; 2024 Thanh Huy. <span className="text-slate-700 mx-2">|</span> Built in the void with <span className="text-secondary">♥</span> and Tailwind CSS.</p>
          </footer>
        );
      };

      const App = () => {
        const [activeProject, setActiveProject] = useState(null);

        return (
          <main className="relative flex min-h-screen w-full flex-col">
            <StarField />
            <Navbar />
            <Hero />
            <Projects onOpenProject={setActiveProject} />
            <About />
            <Contact />
            <Footer />

            {/* Overlays */}
            {activeProject === 'decay' && (
                <DecayChallenge onClose={() => setActiveProject(null)} />
            )}

            {activeProject === 'molecular' && (
                <MolecularViewer onClose={() => setActiveProject(null)} />
            )}

            {activeProject === 'young' && (
                <YoungsExperiment onClose={() => setActiveProject(null)} />
            )}

            {activeProject === 'hydrogen' && (
                <HydrogenSpectrum onClose={() => setActiveProject(null)} />
            )}
          </main>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>