<!DOCTYPE html>
<html lang="en" class="dark scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Thanh Huy - Portfolio</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet" />

    <!-- React Dependencies (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Three.js Dependencies (Using consistent unpkg versioning) -->
    <script crossorigin src="https://unpkg.com/three@0.128.0/build/three.min.js"></script>
    <script crossorigin src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#06bcf9", // Neon Blue
                        "secondary": "#a855f7", // Neon Purple
                        "background-light": "#f5f8f8",
                        "background-dark": "#0a1116", // Deep navy/midnight start
                        "void": "#020204", // Deep space black
                        "surface-dark": "#111820",
                    },
                    fontFamily: {
                        "display": ["Space Grotesk", "sans-serif"],
                        "sans": ["Space Grotesk", "sans-serif"],
                    },
                    backgroundImage: {
                        'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
                    },
                    boxShadow: {
                        "neon": "0 0 15px rgba(6, 188, 249, 0.3)",
                        "neon-hover": "0 0 25px rgba(6, 188, 249, 0.5)",
                        "neon-purple": "0 0 15px rgba(168, 85, 247, 0.3)",
                        "neon-purple-hover": "0 0 25px rgba(168, 85, 247, 0.6)",
                    }
                },
            },
        }
    </script>
    <style>
        .range-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
            outline: none;
        }
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #06bcf9;
            cursor: pointer;
            box-shadow: 0 0 10px #06bcf9;
            transition: all 0.2s;
        }
        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: #fff;
            box-shadow: 0 0 15px #fff, 0 0 30px #06bcf9;
        }
        /* Custom scrollbar for molecule list */
        .molecule-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .molecule-scroll::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .molecule-scroll::-webkit-scrollbar-thumb {
            background: #06bcf9;
            border-radius: 3px;
        }
        
        /* Sun Temp Slider Gradient - Realistic Stellar Evolution */
        .temp-slider {
            background: linear-gradient(to right, 
                #460000 0%,    /* Dark Red 2000K */
                #ff3300 25%,   /* Red 3000K */
                #ff8800 40%,   /* Orange 4000K */
                #ffdd00 60%,   /* Yellow 5800K */
                #ffffff 80%,   /* White 8000K */
                #64b4ff 100%   /* Blue 30000K+ */
            );
        }
        
        .equation-input {
            background: transparent;
            border-bottom: 2px solid #334155;
            color: white;
            text-align: center;
            font-family: 'Space Grotesk', monospace;
            transition: border-color 0.2s;
        }
        .equation-input:focus {
            outline: none;
            border-color: #06bcf9;
        }
        /* Hide number arrows */
        .equation-input::-webkit-outer-spin-button,
        .equation-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .particle-input {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            color: #06bcf9;
            font-family: monospace;
            padding: 4px 8px;
            width: 80px;
            font-size: 0.8rem;
            transition: all 0.2s;
            text-align: center;
        }
        .particle-input:focus {
            outline: none;
            border-color: #06bcf9;
            background: rgba(6, 188, 249, 0.1);
        }
    </style>
  </head>
  <body class="bg-background-light dark:bg-background-dark text-[#101e23] dark:text-white antialiased selection:bg-secondary selection:text-white font-display">
    <div id="root"></div>

    <!-- Main Application Logic -->
    <script type="text/babel">
      const { useState, useEffect, useRef, useMemo } = React;

      // --- Constants & Types ---

      const GITHUB_USERNAME = "Zoinkkzs"; 
      const PROFILE_AVATAR = `https://littleastronomy.com/wp-content/uploads/2023/01/what-are-pulsars-and-how-are-they-formed.jpg`;

      const NAV_ITEMS = [
        { label: 'Home', href: '#home' },
        { label: 'Work', href: '#projects' },
        { label: 'About', href: '#about' },
        { label: 'Contact', href: '#contact' },
      ];

      const PROJECTS = [
        {
          id: 'decay',
          title: 'Decay Challenge',
          category: 'Nuclear Physics',
          description: 'Interactive nuclear decay simulator. Balance equations and visualize alpha, beta, and gamma radiation in 3D.',
          image: 'https://images.unsplash.com/photo-1628151015968-3a44118d8d0f?q=80&w=1000&auto=format&fit=crop',
          tags: ['React', 'Three.js'],
          color: 'secondary',
          url: '#'
        },
        {
          id: 'molecular',
          title: 'Molecular Bonds',
          category: 'Chemistry',
          description: 'Educational platform featuring minimalist 3D structure and covalent bond visualizations.',
          image: 'https://images.unsplash.com/photo-1532094349884-543bc11b234d?q=80&w=1000&auto=format&fit=crop',
          tags: ['WebGL', 'D3.js'],
          color: 'primary',
          url: '#'
        },
        {
          id: 'eclipse',
          title: 'Solar Eclipse Simulation',
          category: 'Astrophysics',
          description: 'Real-time solar eclipse simulation with adjustable orbital mechanics, stellar temperature, and planetary alignment.',
          image: 'https://images.unsplash.com/photo-1532693322450-2cb5c511067d?q=80&w=1000&auto=format&fit=crop',
          tags: ['Astrophysics', 'Simulation'],
          color: 'secondary',
          url: '#'
        }
      ];

      const TECH_STACK = [
        { icon: 'terminal', title: 'Coding', desc: 'Lua, C++', color: 'text-primary' },
        { icon: 'hexagon', title: 'Science', desc: 'Chem, Physics, Mathematics', color: 'text-secondary' },
        { icon: 'database', title: 'Data', desc: 'Python, Java', color: 'text-secondary' },
        { icon: 'palette', title: 'Other Skills', desc: 'Chess, Drawing', color: 'text-primary' },
      ];

      // --- NUCLEAR DATA ---
      const ISOTOPES = [
        { name: "Carbon-14", symbol: "C", mass: 14, atomic: 6, type: "Beta Minus", product: { mass: 14, atomic: 7, symbol: "N" }, particles: ["β⁻", "ν̄"] },
        { name: "Tritium", symbol: "H", mass: 3, atomic: 1, type: "Beta Minus", product: { mass: 3, atomic: 2, symbol: "He" }, particles: ["β⁻", "ν̄"] },
        { name: "Potassium-40", symbol: "K", mass: 40, atomic: 19, type: "Beta Minus", product: { mass: 40, atomic: 20, symbol: "Ca" }, particles: ["β⁻", "ν̄"] },
        { name: "Uranium-238", symbol: "U", mass: 238, atomic: 92, type: "Alpha", product: { mass: 234, atomic: 90, symbol: "Th" }, particles: [] },
        { name: "Uranium-235", symbol: "U", mass: 235, atomic: 92, type: "Alpha", product: { mass: 231, atomic: 90, symbol: "Th" }, particles: [] },
        { name: "Thorium-232", symbol: "Th", mass: 232, atomic: 90, type: "Alpha", product: { mass: 228, atomic: 88, symbol: "Ra" }, particles: [] },
        { name: "Radium-226", symbol: "Ra", mass: 226, atomic: 88, type: "Alpha", product: { mass: 222, atomic: 86, symbol: "Rn" }, particles: [] },
        { name: "Radon-222", symbol: "Rn", mass: 222, atomic: 86, type: "Alpha", product: { mass: 218, atomic: 84, symbol: "Po" }, particles: [] },
        { name: "Polonium-210", symbol: "Po", mass: 210, atomic: 84, type: "Alpha", product: { mass: 206, atomic: 82, symbol: "Pb" }, particles: [] },
        { name: "Lead-210", symbol: "Pb", mass: 210, atomic: 82, type: "Beta Minus", product: { mass: 210, atomic: 83, symbol: "Bi" }, particles: ["β⁻", "ν̄"] },
        { name: "Iodine-131", symbol: "I", mass: 131, atomic: 53, type: "Beta Minus", product: { mass: 131, atomic: 54, symbol: "Xe" }, particles: ["β⁻", "ν̄"] },
        { name: "Technetium-99m", symbol: "Tc", mass: 99, atomic: 43, type: "Gamma", product: { mass: 99, atomic: 43, symbol: "Tc" }, particles: ["γ"] },
        { name: "Cobalt-60", symbol: "Co", mass: 60, atomic: 27, type: "Beta Minus", product: { mass: 60, atomic: 28, symbol: "Ni" }, particles: ["β⁻", "γ", "ν̄"] },
        { name: "Cesium-137", symbol: "Cs", mass: 137, atomic: 55, type: "Beta Minus", product: { mass: 137, atomic: 56, symbol: "Ba" }, particles: ["β⁻", "ν̄"] },
        { name: "Strontium-90", symbol: "Sr", mass: 90, atomic: 38, type: "Beta Minus", product: { mass: 90, atomic: 39, symbol: "Y" }, particles: ["β⁻", "ν̄"] },
        { name: "Americium-241", symbol: "Am", mass: 241, atomic: 95, type: "Alpha", product: { mass: 237, atomic: 93, symbol: "Np" }, particles: [] },
        { name: "Plutonium-239", symbol: "Pu", mass: 239, atomic: 94, type: "Alpha", product: { mass: 235, atomic: 92, symbol: "U" }, particles: [] },
        { name: "Neptunium-237", symbol: "Np", mass: 237, atomic: 93, type: "Alpha", product: { mass: 233, atomic: 91, symbol: "Pa" }, particles: [] },
        { name: "Krypton-85", symbol: "Kr", mass: 85, atomic: 36, type: "Beta Minus", product: { mass: 85, atomic: 37, symbol: "Rb" }, particles: ["β⁻", "ν̄"] },
        { name: "Sodium-24", symbol: "Na", mass: 24, atomic: 11, type: "Beta Minus", product: { mass: 24, atomic: 12, symbol: "Mg" }, particles: ["β⁻", "γ", "ν̄"] },
        { name: "Beryllium-7", symbol: "Be", mass: 7, atomic: 4, type: "Electron Capture", product: { mass: 7, atomic: 3, symbol: "Li" }, particles: ["ν"] },
        { name: "Rubidium-87", symbol: "Rb", mass: 87, atomic: 37, type: "Beta Minus", product: { mass: 87, atomic: 38, symbol: "Sr" }, particles: ["β⁻", "ν̄"] },
        { name: "Californium-252", symbol: "Cf", mass: 252, atomic: 98, type: "Alpha", product: { mass: 248, atomic: 96, symbol: "Cm" }, particles: [] },
        { name: "Oganesson-294", symbol: "Og", mass: 294, atomic: 118, type: "Alpha", product: { mass: 290, atomic: 116, symbol: "Lv" }, particles: [] }
      ];

      // --- ELECTRON CONFIGURATIONS ---
      const SHELL_CONFIGS = {
        1: [1], 4: [2, 2], 6: [2, 4], 11: [2, 8, 1], 19: [2, 8, 8, 1], 
        27: [2, 8, 15, 2], 36: [2, 8, 18, 8], 37: [2, 8, 18, 8, 1], 
        38: [2, 8, 18, 8, 2], 43: [2, 8, 18, 13, 2], 53: [2, 8, 18, 18, 7], 
        55: [2, 8, 18, 18, 8, 1], 82: [2, 8, 18, 32, 18, 4], 84: [2, 8, 18, 32, 18, 6], 
        86: [2, 8, 18, 32, 18, 8], 88: [2, 8, 18, 32, 18, 8, 2], 90: [2, 8, 18, 32, 18, 10, 2], 
        92: [2, 8, 18, 32, 21, 9, 2], 93: [2, 8, 18, 32, 22, 9, 2], 94: [2, 8, 18, 32, 24, 8, 2], 
        95: [2, 8, 18, 32, 25, 8, 2], 98: [2, 8, 18, 32, 28, 8, 2], 118: [2, 8, 18, 32, 32, 18, 8]
      };

      const getElectronShells = (z) => {
          if (SHELL_CONFIGS[z]) return SHELL_CONFIGS[z];
          const shells = [];
          let remaining = z;
          const caps = [2, 8, 18, 32, 50, 72, 98];
          for(let cap of caps) {
              if (remaining <= 0) break;
              let take = Math.min(remaining, cap);
              shells.push(take);
              remaining -= take;
          }
          return shells;
      };

      const PARTICLES = ["α", "β⁻", "γ", "ν", "ν̄", "e⁻"];

      // --- MOLECULAR DATA ---
      const MOLECULES = {
        "Benzene": { atoms: [{id:0,el:"C",x:1.4,y:0,z:0},{id:1,el:"C",x:0.7,y:1.21,z:0},{id:2,el:"C",x:-0.7,y:1.21,z:0},{id:3,el:"C",x:-1.4,y:0,z:0},{id:4,el:"C",x:-0.7,y:-1.21,z:0},{id:5,el:"C",x:0.7,y:-1.21,z:0},{id:6,el:"H",x:2.4,y:0,z:0},{id:7,el:"H",x:1.2,y:2.1,z:0},{id:8,el:"H",x:-1.2,y:2.1,z:0},{id:9,el:"H",x:-2.4,y:0,z:0},{id:10,el:"H",x:-1.2,y:-2.1,z:0},{id:11,el:"H",x:1.2,y:-2.1,z:0}], bonds: [{source:0,target:1,type:"double"},{source:1,target:2,type:"single"},{source:2,target:3,type:"double"},{source:3,target:4,type:"single"},{source:4,target:5,type:"double"},{source:5,target:0,type:"single"},{source:0,target:6,type:"single"},{source:1,target:7,type:"single"},{source:2,target:8,type:"single"},{source:3,target:9,type:"single"},{source:4,target:10,type:"single"},{source:5,target:11,type:"single"}] },
        "Water": { atoms: [{id:0,el:"O",x:0,y:0,z:0.1},{id:1,el:"H",x:0.8,y:-0.6,z:0},{id:2,el:"H",x:-0.8,y:-0.6,z:0}], bonds: [{source:0,target:1,type:"single"},{source:0,target:2,type:"single"}] },
        "Methanol": { atoms: [{id:0,el:"C",x:-0.7,y:0,z:0},{id:1,el:"O",x:0.7,y:0,z:0},{id:2,el:"H",x:-1.0,y:1.0,z:0},{id:3,el:"H",x:-1.0,y:-0.5,z:0.9},{id:4,el:"H",x:-1.0,y:-0.5,z:-0.9},{id:5,el:"H",x:1.2,y:-0.8,z:0}], bonds: [{source:0,target:1,type:"single"},{source:0,target:2,type:"single"},{source:0,target:3,type:"single"},{source:0,target:4,type:"single"},{source:1,target:5,type:"single"}] },
        "Ethanol": { atoms: [{id:0,el:"C",x:-1.2,y:0,z:0},{id:1,el:"C",x:0,y:0.5,z:0},{id:2,el:"O",x:1.2,y:-0.2,z:0},{id:3,el:"H",x:1.8,y:0.5,z:0},{id:4,el:"H",x:-1.2,y:-1.1,z:0},{id:5,el:"H",x:-2.1,y:0.4,z:0},{id:6,el:"H",x:-1.2,y:0.4,z:1.0},{id:7,el:"H",x:0,y:1.6,z:0},{id:8,el:"H",x:0,y:0.1,z:-1.0}], bonds: [{source:0,target:1,type:"single"},{source:1,target:2,type:"single"},{source:2,target:3,type:"single"},{source:0,target:4,type:"single"},{source:0,target:5,type:"single"},{source:0,target:6,type:"single"},{source:1,target:7,type:"single"},{source:1,target:8,type:"single"}] },
        "Acetic Acid": { atoms: [{id:0,el:"C",x:-1.0,y:0,z:0},{id:1,el:"C",x:0.5,y:0,z:0},{id:2,el:"O",x:1.2,y:1.2,z:0},{id:3,el:"O",x:1.1,y:-1.2,z:0},{id:4,el:"H",x:0.5,y:-1.8,z:0},{id:5,el:"H",x:-1.4,y:1.0,z:0},{id:6,el:"H",x:-1.4,y:-0.5,z:0.9},{id:7,el:"H",x:-1.4,y:-0.5,z:-0.9}], bonds: [{source:0,target:1,type:"single"},{source:1,target:2,type:"double"},{source:1,target:3,type:"single"},{source:3,target:4,type:"single"},{source:0,target:5,type:"single"},{source:0,target:6,type:"single"},{source:0,target:7,type:"single"}] },
        "Butadiene": { atoms: [{id:0,el:"C",x:-2,y:-0.5,z:0},{id:1,el:"C",x:-0.7,y:0.5,z:0},{id:2,el:"C",x:0.7,y:-0.5,z:0},{id:3,el:"C",x:2,y:0.5,z:0},{id:4,el:"H",x:-2,y:-1.6,z:0},{id:5,el:"H",x:-2.9,y:0.05,z:0},{id:6,el:"H",x:-0.7,y:1.6,z:0},{id:7,el:"H",x:0.7,y:-1.6,z:0},{id:8,el:"H",x:2,y:1.6,z:0},{id:9,el:"H",x:2.9,y:-0.05,z:0}], bonds: [{source:0,target:1,type:"double"},{source:1,target:2,type:"single"},{source:2,target:3,type:"double"},{source:0,target:4,type:"single"},{source:0,target:5,type:"single"},{source:1,target:6,type:"single"},{source:2,target:7,type:"single"},{source:3,target:8,type:"single"},{source:3,target:9,type:"single"}] },
        "Cyclohexane": { atoms: [{id:0,el:"C",x:1.4,y:0.5,z:-0.2},{id:1,el:"C",x:0.7,y:-0.7,z:0.2},{id:2,el:"C",x:-0.7,y:-0.7,z:-0.2},{id:3,el:"C",x:-1.4,y:0.5,z:0.2},{id:4,el:"C",x:-0.7,y:1.7,z:-0.2},{id:5,el:"C",x:0.7,y:1.7,z:0.2},{id:6,el:"H",x:1.4,y:0.5,z:-1.3},{id:7,el:"H",x:2.4,y:0.5,z:0.2},{id:8,el:"H",x:0.7,y:-0.7,z:1.3},{id:9,el:"H",x:1.2,y:-1.6,z:-0.2},{id:10,el:"H",x:-0.7,y:-0.7,z:-1.3},{id:11,el:"H",x:-1.2,y:-1.6,z:0.2},{id:12,el:"H",x:-1.4,y:0.5,z:1.3},{id:13,el:"H",x:-2.4,y:0.5,z:-0.2},{id:14,el:"H",x:-0.7,y:1.7,z:-1.3},{id:15,el:"H",x:-1.2,y:2.6,z:0.2},{id:16,el:"H",x:0.7,y:1.7,z:1.3},{id:17,el:"H",x:1.2,y:2.6,z:-0.2}], bonds: [{source:0,target:1,type:"single"},{source:1,target:2,type:"single"},{source:2,target:3,type:"single"},{source:3,target:4,type:"single"},{source:4,target:5,type:"single"},{source:5,target:0,type:"single"},{source:0,target:6,type:"single"},{source:0,target:7,type:"single"},{source:1,target:8,type:"single"},{source:1,target:9,type:"single"},{source:2,target:10,type:"single"},{source:2,target:11,type:"single"},{source:3,target:12,type:"single"},{source:3,target:13,type:"single"},{source:4,target:14,type:"single"},{source:4,target:15,type:"single"},{source:5,target:16,type:"single"},{source:5,target:17,type:"single"}] },
        "Xenon": { atoms: [{id:0,el:"Xe",x:-2.0,y:0,z:0},{id:1,el:"Xe",x:2.0,y:0,z:0}], bonds: [{source:0,target:1,type:"vdw"}] },
        "Benzaldehyde": { atoms: [{id:0,el:"C",x:1.4,y:0,z:0},{id:1,el:"C",x:0.7,y:1.21,z:0},{id:2,el:"C",x:-0.7,y:1.21,z:0},{id:3,el:"C",x:-1.4,y:0,z:0},{id:4,el:"C",x:-0.7,y:-1.21,z:0},{id:5,el:"C",x:0.7,y:-1.21,z:0},{id:6,el:"C",x:-2.8,y:0,z:0},{id:7,el:"O",x:-3.5,y:1.2,z:0},{id:8,el:"H",x:-3.3,y:-1.0,z:0}], bonds: [{source:0,target:1,type:"double"},{source:1,target:2,type:"single"},{source:2,target:3,type:"double"},{source:3,target:4,type:"single"},{source:4,target:5,type:"double"},{source:5,target:0,type:"single"},{source:3,target:6,type:"single"},{source:6,target:7,type:"double"},{source:6,target:8,type:"single"}] },
        "Sodium Acetate": { atoms: [{id:0,el:"C",x:-1.0,y:0,z:0},{id:1,el:"C",x:0.5,y:0,z:0},{id:2,el:"O",x:1.2,y:1.2,z:0},{id:3,el:"O",x:1.1,y:-1.2,z:0,role:"anion"},{id:4,el:"Na",x:3.5,y:-1.5,z:0,role:"cation"},{id:5,el:"H",x:-1.4,y:1.0,z:0},{id:6,el:"H",x:-1.4,y:-0.5,z:0.9},{id:7,el:"H",x:-1.4,y:-0.5,z:-0.9}], bonds: [{source:0,target:1,type:"single"},{source:1,target:2,type:"double"},{source:1,target:3,type:"single"},{source:0,target:5,type:"single"},{source:0,target:6,type:"single"},{source:0,target:7,type:"single"},{source:3,target:4,type:"ionic"}] },
        "Tollen's Reagent": { atoms: [{id:0,el:"Ag",x:0,y:0,z:0,role:"cation"},{id:1,el:"N",x:-2.1,y:0,z:0},{id:2,el:"N",x:2.1,y:0,z:0},{id:3,el:"H",x:-2.5,y:0.8,z:0},{id:4,el:"H",x:-2.5,y:-0.4,z:0.7},{id:5,el:"H",x:-2.5,y:-0.4,z:-0.7},{id:6,el:"H",x:2.5,y:0.8,z:0},{id:7,el:"H",x:2.5,y:-0.4,z:0.7},{id:8,el:"H",x:2.5,y:-0.4,z:-0.7}], bonds: [{source:0,target:1,type:"single"},{source:0,target:2,type:"single"},{source:1,target:3,type:"single"},{source:1,target:4,type:"single"},{source:1,target:5,type:"single"},{source:2,target:6,type:"single"},{source:2,target:7,type:"single"},{source:2,target:8,type:"single"}] },
        "Dextrose": { atoms: [{id:0,el:"C",x:0,y:3,z:0},{id:1,el:"O",x:1.2,y:3.5,z:0},{id:2,el:"C",x:0,y:1.5,z:0},{id:3,el:"O",x:-1.4,y:1.5,z:0},{id:4,el:"C",x:0,y:0,z:0},{id:5,el:"O",x:1.4,y:0,z:0},{id:6,el:"C",x:0,y:-1.5,z:0},{id:7,el:"O",x:-1.4,y:-1.5,z:0},{id:8,el:"C",x:0,y:-3,z:0},{id:9,el:"O",x:1.4,y:-3,z:0},{id:10,el:"C",x:0,y:-4.5,z:0},{id:11,el:"O",x:0,y:-5.5,z:0},{id:12,el:"H",x:-1.0,y:3.2,z:0},{id:13,el:"H",x:1.0,y:1.5,z:0},{id:14,el:"H",x:-2.0,y:2.0,z:0},{id:15,el:"H",x:-1.0,y:0,z:0},{id:16,el:"H",x:2.0,y:0.5,z:0},{id:17,el:"H",x:1.0,y:-1.5,z:0},{id:18,el:"H",x:-2.0,y:-1.0,z:0},{id:19,el:"H",x:-1.0,y:-3,z:0},{id:20,el:"H",x:2.0,y:-2.5,z:0},{id:21,el:"H",x:-1.0,y:-4.5,z:0.5},{id:22,el:"H",x:1.0,y:-4.5,z:-0.5},{id:23,el:"H",x:0.5,y:-6.0,z:0}], bonds: [{source:0,target:1,type:"double"},{source:0,target:2,type:"single"},{source:0,target:12,type:"single"},{source:2,target:3,type:"single"},{source:2,target:4,type:"single"},{source:2,target:13,type:"single"},{source:3,target:14,type:"single"},{source:4,target:5,type:"single"},{source:4,target:6,type:"single"},{source:4,target:15,type:"single"},{source:5,target:16,type:"single"},{source:6,target:7,type:"single"},{source:6,target:8,type:"single"},{source:6,target:17,type:"single"},{source:7,target:18,type:"single"},{source:8,target:9,type:"single"},{source:8,target:10,type:"single"},{source:8,target:19,type:"single"},{source:9,target:20,type:"single"},{source:10,target:11,type:"single"},{source:10,target:21,type:"single"},{source:10,target:22,type:"single"},{source:11,target:23,type:"single"}] },
        "Glucopyranose": { atoms: [{id:0,el:"O",x:1.2,y:0.7,z:0},{id:1,el:"C",x:1.2,y:-0.7,z:0},{id:2,el:"C",x:0,y:-1.4,z:0},{id:3,el:"C",x:-1.2,y:-0.7,z:0},{id:4,el:"C",x:-1.2,y:0.7,z:0},{id:5,el:"C",x:0,y:1.4,z:0},{id:6,el:"C",x:0,y:2.8,z:0},{id:7,el:"O",x:1.2,y:2.8,z:0},{id:8,el:"O",x:2.3,y:-1.0,z:0},{id:9,el:"O",x:0,y:-2.6,z:0},{id:10,el:"O",x:-2.3,y:-1.0,z:0},{id:11,el:"O",x:-2.3,y:1.0,z:0},{id:12,el:"H",x:2.8,y:-0.5,z:0},{id:13,el:"H",x:0.5,y:-3.0,z:0},{id:14,el:"H",x:-2.8,y:-0.5,z:0},{id:15,el:"H",x:-2.8,y:1.5,z:0},{id:16,el:"H",x:1.8,y:3.2,z:0},{id:17,el:"H",x:0.5,y:-0.5,z:1.0},{id:18,el:"H",x:-0.5,y:-1.0,z:1.0},{id:19,el:"H",x:-0.8,y:-0.5,z:1.0},{id:20,el:"H",x:-0.8,y:0.5,z:1.0},{id:21,el:"H",x:0,y:1.2,z:1.2},{id:22,el:"H",x:-0.8,y:2.8,z:0.5},{id:23,el:"H",x:0.5,y:2.8,z:-0.8}], bonds: [{source:0,target:1,type:"single"},{source:1,target:2,type:"single"},{source:2,target:3,type:"single"},{source:3,target:4,type:"single"},{source:4,target:5,type:"single"},{source:5,target:0,type:"single"},{source:5,target:6,type:"single"},{source:6,target:7,type:"single"},{source:1,target:8,type:"single"},{source:8,target:12,type:"single"},{source:2,target:9,type:"single"},{source:9,target:13,type:"single"},{source:3,target:10,type:"single"},{source:10,target:14,type:"single"},{source:4,target:11,type:"single"},{source:11,target:15,type:"single"},{source:7,target:16,type:"single"},{source:1,target:17,type:"single"},{source:2,target:18,type:"single"},{source:3,target:19,type:"single"},{source:4,target:20,type:"single"},{source:5,target:21,type:"single"},{source:6,target:22,type:"single"},{source:6,target:23,type:"single"}] }
      };

      const ATOMIC_MASSES = {
        "H": 1.008, "C": 12.011, "N": 14.007, "O": 15.999, "Na": 22.990, "Ag": 107.868, "Xe": 131.293
      };
      
      const ELEMENT_COLORS = {
        "C": 0x333333, "H": 0xFFFFFF, "O": 0xFF0000, "N": 0x0000FF, 
        "Ag": 0xC0C0C0, "Na": 0x800080, "Xe": 0x00FFFF
      };

      const ELEMENT_RADII = {
        "C": 0.4, "H": 0.25, "O": 0.35, "N": 0.38, "Ag": 0.5, "Na": 0.5, "Xe": 0.5
      };

      // --- Helper Components ---

      const GradientText = ({ children }) => (
        <span className="text-transparent bg-clip-text bg-gradient-to-r from-primary via-cyan-300 to-secondary font-bold">
            {children}
        </span>
      );

      const ShootingStars = () => {
        const canvasRef = useRef(null);
        useEffect(() => {
          const canvas = canvasRef.current;
          const ctx = canvas.getContext('2d');
          let width, height;
          let stars = [];
          let shootingStars = [];

          const resize = () => {
            width = canvas.width = canvas.offsetWidth;
            height = canvas.height = canvas.offsetHeight;
            stars = Array.from({ length: 200 }, () => ({
              x: Math.random() * width,
              y: Math.random() * height,
              size: Math.random() * 2,
              alpha: Math.random()
            }));
          };
          window.addEventListener('resize', resize);
          resize();

          const createShootingStar = () => {
            const startX = Math.random() * width;
            const startY = Math.random() * height * 0.5;
            const length = Math.random() * 100 + 50;
            const angle = Math.PI / 4; // 45 degrees
            const speed = Math.random() * 10 + 5;
            return { x: startX, y: startY, length, angle, speed, life: 1, opacity: 1 };
          };

          const animate = () => {
              ctx.clearRect(0, 0, width, height);
              
              // Static Stars
              stars.forEach(star => {
                  ctx.fillStyle = `rgba(255, 255, 255, ${star.alpha})`;
                  ctx.beginPath();
                  ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                  ctx.fill();
              });

              // Shooting Stars
              if (Math.random() < 0.02) shootingStars.push(createShootingStar());
              
              shootingStars.forEach((star, index) => {
                  star.x -= star.speed; // Move left
                  star.y += star.speed; // Move down
                  star.life -= 0.02;
                  
                  if (star.life <= 0) {
                      shootingStars.splice(index, 1);
                  } else {
                      const tailX = star.x + Math.cos(star.angle) * star.length;
                      const tailY = star.y - Math.sin(star.angle) * star.length;
                      
                      const grad = ctx.createLinearGradient(star.x, star.y, tailX, tailY);
                      grad.addColorStop(0, `rgba(255, 255, 255, ${star.life})`);
                      grad.addColorStop(1, 'rgba(255, 255, 255, 0)');
                      
                      ctx.strokeStyle = grad;
                      ctx.lineWidth = 2;
                      ctx.beginPath();
                      ctx.moveTo(star.x, star.y);
                      ctx.lineTo(tailX, tailY);
                      ctx.stroke();
                  }
              });

              requestAnimationFrame(animate);
          };
          const animId = requestAnimationFrame(animate);

          return () => {
              window.removeEventListener('resize', resize);
              cancelAnimationFrame(animId);
          };
        }, []);
        return <canvas ref={canvasRef} className="absolute inset-0 w-full h-full" />;
      };

      // --- Decay Challenge Component ---
      const DecayChallenge = ({ onClose }) => {
        const mountRef = useRef(null);
        const [selectedIsotope, setSelectedIsotope] = useState(ISOTOPES[0]);
        // Search State
        const [searchTerm, setSearchTerm] = useState("");
        
        // Filter logic
        const filteredIsotopes = useMemo(() => {
            return ISOTOPES.filter(iso => 
                iso.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                iso.symbol.toLowerCase().includes(searchTerm.toLowerCase())
            );
        }, [searchTerm]);

        // Equation State
        const [productMain, setProductMain] = useState({ mass: "", atomic: "", symbol: "" });
        const [productSec, setProductSec] = useState({ mass: "", atomic: "", symbol: "" });
        const [particleInputLeft, setParticleInputLeft] = useState("");
        const [particleInputRight, setParticleInputRight] = useState("");
        
        const [status, setStatus] = useState("idle"); // idle, correct, wrong
        const [animProgress, setAnimProgress] = useState(0); // 0 to 100
        const [isPlaying, setIsPlaying] = useState(false);
        
        // Sim State Ref for Animation Loop
        const simState = useRef({
            progress: 0,
            isPlaying: false,
            decayType: "Beta Minus"
        });

        // Update Ref when State changes
        useEffect(() => {
            simState.current.isPlaying = isPlaying;
            simState.current.decayType = selectedIsotope.type;
            if(!isPlaying) simState.current.progress = animProgress;
        }, [isPlaying, animProgress, selectedIsotope]);

        // Parsing Helper
        const parseParticles = (input) => {
            return input.trim().split(/[\s,]+/).map(t => {
                const val = t.toLowerCase();
                if (val === 'b-' || val === 'beta-' || val === 'beta') return 'β⁻';
                if (val === 'y' || val === 'gamma' || val === 'g') return 'γ';
                if (val === 'v' || val === 'nu') return 'ν';
                if (val === 'v-' || val === 'nu-' || val === 'v_') return 'ν̄';
                if (val === 'a' || val === 'alpha') return 'α';
                if (val === 'e' || val === 'e-') return 'e⁻';
                return ''; // invalid tokens are empty
            }).filter(t => t);
        }

        // Check Answer
        const checkAnswer = () => {
            const correctProd = selectedIsotope.product;
            const type = selectedIsotope.type;
            
            // 1. Check Main Product
            const isMainCorrect = 
                parseInt(productMain.mass) === correctProd.mass &&
                parseInt(productMain.atomic) === correctProd.atomic &&
                productMain.symbol.toLowerCase().trim() === correctProd.symbol.toLowerCase();
            
            // 2. Check Secondary Product (Nucleus like He-4)
            let isSecProdCorrect = false;
            if (type === "Alpha") {
                const sym = productSec.symbol.toLowerCase().trim();
                const validAlphaSyms = ['he', 'he++', 'he2+', 'α'];
                isSecProdCorrect = 
                    productSec.mass === "4" && 
                    productSec.atomic === "2" && 
                    validAlphaSyms.includes(sym);
            } else {
                isSecProdCorrect = productSec.mass === "" && productSec.atomic === "" && productSec.symbol === "";
            }

            // 3. Check Left Particle Input (Reactants)
            const leftTokens = parseParticles(particleInputLeft);
            let isLeftCorrect = false;
            if (type === "Electron Capture") {
                // Must contain electron
                isLeftCorrect = leftTokens.includes('e⁻');
            } else {
                // Must be empty
                isLeftCorrect = leftTokens.length === 0;
            }

            // 4. Check Right Particle Input (Product Radiation)
            const rightTokens = parseParticles(particleInputRight);
            const expectedRight = [...selectedIsotope.particles];
            
            // Normalize: In physics β⁻ and e⁻ are the same particle.
            const normalize = (list) => list.map(p => p === 'e⁻' ? 'β⁻' : p).sort();
            
            const normalizedUserRight = normalize(rightTokens);
            const normalizedExpectedRight = normalize(expectedRight);
            
            const isRightCorrect = JSON.stringify(normalizedUserRight) === JSON.stringify(normalizedExpectedRight);

            if (isMainCorrect && isLeftCorrect && isSecProdCorrect && isRightCorrect) {
                setStatus("correct");
                setIsPlaying(true); // Auto play
            } else {
                setStatus("wrong");
            }
        };
        
        // Reset when changing isotope
        useEffect(() => {
            setProductMain({ mass: "", atomic: "", symbol: "" });
            setProductSec({ mass: "", atomic: "", symbol: "" });
            setParticleInputLeft("");
            setParticleInputRight("");
            setStatus("idle");
            setAnimProgress(0);
            setIsPlaying(false);
            simState.current.progress = 0;
        }, [selectedIsotope]);
        
        // ... (Three.js Logic)
        useEffect(() => {
            if (!mountRef.current || !window.THREE) return;

            const width = mountRef.current.clientWidth;
            const height = mountRef.current.clientHeight;
            const scene = new THREE.Scene();
            
            const camera = new THREE.PerspectiveCamera(45, width / height, 0.1, 100);
            camera.position.set(0, 5, 10);
            
            const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(width, height);
            mountRef.current.appendChild(renderer.domElement);

            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enablePan = true;
            controls.screenSpacePanning = true; 
            controls.mouseButtons = {
                LEFT: THREE.MOUSE.ROTATE,
                MIDDLE: THREE.MOUSE.PAN,
                RIGHT: THREE.MOUSE.DOLLY
            };

            // Lights
            const ambient = new THREE.AmbientLight(0x404040, 2);
            scene.add(ambient);
            const light = new THREE.DirectionalLight(0xffffff, 2);
            light.position.set(5, 5, 5);
            scene.add(light);
            const light2 = new THREE.PointLight(0x06bcf9, 1);
            light2.position.set(-5, -5, -5);
            scene.add(light2);

            // Group for Nucleus
            const nucleusGroup = new THREE.Group();
            scene.add(nucleusGroup);

            // Group for Electrons (Orbitals)
            const electronGroup = new THREE.Group();
            scene.add(electronGroup);

            // Particles for Animation
            const particleGroup = new THREE.Group();
            scene.add(particleGroup);

            // Data Refs for Animation
            let protonMeshes = [];
            let capturedElectronMesh = null;
            let targetProton = null; // Specific proton to capture electron

            // Generate Nucleus
            const generateNucleus = () => {
                while(nucleusGroup.children.length > 0) nucleusGroup.remove(nucleusGroup.children[0]);
                protonMeshes = [];
                
                const protonCount = selectedIsotope.atomic;
                const neutronCount = selectedIsotope.mass - selectedIsotope.atomic;
                const total = selectedIsotope.mass;
                
                const scaleFactor = Math.min(1, 50 / total); 
                const visualProtons = Math.ceil(protonCount * scaleFactor);
                const visualNeutrons = Math.ceil(neutronCount * scaleFactor);
                
                // Pack spheres tighter (0.25 factor for very dense look)
                const geometry = new THREE.SphereGeometry(0.4, 16, 16);
                const pMat = new THREE.MeshPhongMaterial({ color: 0xff3333, shininess: 80 });
                const nMat = new THREE.MeshPhongMaterial({ color: 0xcccccc, shininess: 50 });

                // Cluster Algorithm
                const clusterRadius = Math.pow(visualProtons + visualNeutrons, 1/3) * 0.25;
                
                for(let i=0; i<visualProtons + visualNeutrons; i++) {
                    const isProton = i < visualProtons;
                    const mesh = new THREE.Mesh(geometry, isProton ? pMat : nMat);
                    
                    const r = Math.pow(Math.random(), 1/3) * clusterRadius;
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);
                    
                    mesh.position.x = r * Math.sin(phi) * Math.cos(theta);
                    mesh.position.y = r * Math.sin(phi) * Math.sin(theta);
                    mesh.position.z = r * Math.cos(phi);
                    
                    mesh.userData = { type: isProton ? 'proton' : 'neutron', originalPos: mesh.position.clone() };
                    nucleusGroup.add(mesh);
                    
                    if (isProton) protonMeshes.push(mesh);
                }
                
                // Set target proton for EC (just pick the last one, usually on outside due to random distribution)
                if (protonMeshes.length > 0) {
                    targetProton = protonMeshes[protonMeshes.length - 1];
                }
            };

            // Generate Electron Shells
            const generateElectrons = () => {
                while(electronGroup.children.length > 0) electronGroup.remove(electronGroup.children[0]);
                
                const z = selectedIsotope.atomic;
                // Use Realistic Shells
                const shells = getElectronShells(z);
                
                shells.forEach((count, index) => {
                    if (count <= 0) return;
                    const radius = 3 + index * 1.5;
                    
                    // Orbit Ring
                    const ringGeo = new THREE.TorusGeometry(radius, 0.02, 8, 64);
                    const ringMat = new THREE.MeshBasicMaterial({ color: 0x444444, opacity: 0.3, transparent: true });
                    const ring = new THREE.Mesh(ringGeo, ringMat);
                    ring.rotation.x = Math.PI / 2;
                    // Add some tilt variation per shell
                    ring.rotation.x += (Math.random() - 0.5) * 0.5;
                    ring.rotation.y += (Math.random() - 0.5) * 0.5;
                    electronGroup.add(ring);

                    // Electrons
                    for(let i=0; i<count; i++) {
                        const angle = (i / count) * Math.PI * 2;
                        const elGeo = new THREE.SphereGeometry(0.12, 8, 8);
                        const elMat = new THREE.MeshBasicMaterial({ color: 0x00ffff });
                        const el = new THREE.Mesh(elGeo, elMat);
                        
                        // Position on ring
                        el.position.set(Math.cos(angle) * radius, Math.sin(angle) * radius, 0);
                        
                        // Pivot group for rotation
                        const pivot = new THREE.Group();
                        pivot.rotation.copy(ring.rotation); // Match ring tilt
                        pivot.add(el);
                        
                        // Add animation data
                        pivot.userData = { speed: (Math.random() * 0.05 + 0.02) * (index % 2 === 0 ? 1 : -1) };
                        
                        electronGroup.add(pivot);

                        // If inner shell (index 0), mark one as potential capture candidate
                        if (index === 0 && i === 0) {
                            capturedElectronMesh = el; // Store reference to the sphere itself
                            // We need to know its parent pivot to animate properly, handled in loop
                        }
                    }
                });
            };

            generateNucleus();
            generateElectrons();

            // Setup Ejecta
            const setupEjecta = () => {
                // Clear group
                while(particleGroup.children.length > 0) particleGroup.remove(particleGroup.children[0]);

                // 1. Alpha Particle
                const alphaGroup = new THREE.Group();
                const ag = new THREE.SphereGeometry(0.4, 16, 16);
                const pMat = new THREE.MeshPhongMaterial({ color: 0xff3333 });
                const nMat = new THREE.MeshPhongMaterial({ color: 0xcccccc });
                const p1 = new THREE.Mesh(ag, pMat); p1.position.set(0.3, 0.3, 0);
                const p2 = new THREE.Mesh(ag, pMat); p2.position.set(-0.3, -0.3, 0);
                const n1 = new THREE.Mesh(ag, nMat); n1.position.set(-0.3, 0.3, 0);
                const n2 = new THREE.Mesh(ag, nMat); n2.position.set(0.3, -0.3, 0);
                alphaGroup.add(p1, p2, n1, n2);
                alphaGroup.visible = false;
                particleGroup.add(alphaGroup);

                // 2. Beta Electron
                const electron = new THREE.Mesh(new THREE.SphereGeometry(0.15, 16, 16), new THREE.MeshPhongMaterial({color: 0x00ffff, emissive: 0x00ffff}));
                electron.visible = false;
                particleGroup.add(electron);

                // 3. Neutrino
                const neutrino = new THREE.Mesh(new THREE.SphereGeometry(0.08, 8, 8), new THREE.MeshBasicMaterial({color: 0x888888}));
                neutrino.visible = false;
                particleGroup.add(neutrino);

                // 4. Gamma Wave
                const gammaGroup = new THREE.Group();
                const wavePoints = 50;
                const waveGeo = new THREE.BufferGeometry();
                const wavePos = new Float32Array(wavePoints * 3);
                waveGeo.setAttribute('position', new THREE.BufferAttribute(wavePos, 3));
                const waveLine = new THREE.Line(waveGeo, new THREE.LineBasicMaterial({ color: 0xffff00 }));
                gammaGroup.add(waveLine);
                const arrowHead = new THREE.Mesh(new THREE.ConeGeometry(0.15, 0.4, 8), new THREE.MeshBasicMaterial({ color: 0xffff00 }));
                // Default Cone points Y+, Rotate to point X+ initially
                arrowHead.rotation.z = -Math.PI / 2;
                gammaGroup.add(arrowHead);
                gammaGroup.visible = false;
                particleGroup.add(gammaGroup);
                
                return { alphaGroup, electron, neutrino, gammaGroup, waveLine, arrowHead };
            };

            const ejecta = setupEjecta();

            // Animation Loop
            let animId;
            const animate = () => {
                animId = requestAnimationFrame(animate);
                controls.update();

                // Rotate Electrons (Standard)
                electronGroup.children.forEach(pivot => {
                    // Stop rotation of captured electron only if captured
                    if (pivot.userData.speed) {
                        pivot.rotation.z += pivot.userData.speed;
                    }
                });

                // Logic
                const { isPlaying, progress, decayType } = simState.current;
                
                if (isPlaying && progress < 100) {
                    simState.current.progress += 0.5;
                    setAnimProgress(simState.current.progress);
                }

                const p = Math.max(0, simState.current.progress / 100); 
                
                // Reset Ejecta
                ejecta.alphaGroup.visible = false;
                ejecta.electron.visible = false;
                ejecta.neutrino.visible = false;
                ejecta.gammaGroup.visible = false;

                // Handle Animations
                if (decayType === "Alpha") {
                    ejecta.alphaGroup.visible = p > 0;
                    ejecta.alphaGroup.position.set(5 * p, 2 * p, 0);
                    ejecta.alphaGroup.rotation.z += 0.1;
                    
                    // Shrink 4 random nucleons
                    for(let i=0; i<4; i++) { if(nucleusGroup.children[i]) nucleusGroup.children[i].visible = p < 0.1; }

                } else if (decayType === "Beta Minus") {
                    ejecta.electron.visible = p > 0;
                    ejecta.neutrino.visible = p > 0;
                    ejecta.electron.position.set(6 * p, 2 * p, 0);
                    ejecta.neutrino.position.set(-6 * p, -2 * p, 0);

                    // Neutron -> Proton
                    const neutron = nucleusGroup.children.find(c => c.userData.type === 'neutron');
                    if (neutron) {
                        neutron.material = p > 0.1 ? new THREE.MeshPhongMaterial({ color: 0xff3333 }) : new THREE.MeshPhongMaterial({ color: 0xcccccc });
                    }

                } else if (decayType === "Gamma") {
                    ejecta.gammaGroup.visible = p > 0;
                    if (p > 0) {
                        const phase = simState.current.progress * 0.5;
                        ejecta.gammaGroup.position.set(8 * p, 0, 0);
                        const positions = ejecta.waveLine.geometry.attributes.position.array;
                        const tailLen = 4;
                        for(let i=0; i<50; i++) {
                            const x = - (i / 49) * tailLen; 
                            positions[i*3] = x;
                            positions[i*3+1] = 0.3 * Math.sin(x * 5 - phase); 
                            positions[i*3+2] = 0;
                        }
                        ejecta.waveLine.geometry.attributes.position.needsUpdate = true;

                        // Dynamic Arrow Direction
                        // Calculate slope of sine wave at x=0 (the head)
                        // y = A * sin(kx - phase) => y' = A*k * cos(kx - phase)
                        // At x=0: y' = 0.3 * 5 * cos(-phase) = 1.5 * cos(-phase)
                        const slope = 1.5 * Math.cos(-phase);
                        // Base rotation is -PI/2 (pointing Right). Add slope angle.
                        ejecta.arrowHead.rotation.z = -Math.PI / 2 + Math.atan(slope);
                    }
                    if (p > 0 && p < 0.5) {
                        nucleusGroup.position.x = (Math.random() - 0.5) * 0.2;
                        nucleusGroup.position.y = (Math.random() - 0.5) * 0.2;
                    } else { nucleusGroup.position.set(0,0,0); }

                } else if (decayType === "Electron Capture") {
                     // Phase 1: Electron spirals IN to specific proton (p 0 to 0.5)
                     if (p > 0 && p <= 0.5 && capturedElectronMesh && targetProton) {
                         capturedElectronMesh.visible = true;
                         
                         // We need the world position of the target proton
                         const targetPos = new THREE.Vector3();
                         targetProton.getWorldPosition(targetPos);
                         
                         // Cheat: stop rotation for capture visual
                         const pivot = capturedElectronMesh.parent;
                         pivot.userData.speed = 0; // Stop rotation
                         
                         // Lerp factor
                         const t = p * 2; // 0 to 1
                         
                         // Initial pos (approximate)
                         const startPos = new THREE.Vector3(3, 0, 0); 
                         capturedElectronMesh.position.lerpVectors(startPos, targetProton.position, t);
                         
                     } else if (p > 0.5 && targetProton) {
                         if (capturedElectronMesh) capturedElectronMesh.visible = false;
                         
                         // Phase 2: Proton turns to Neutron
                         targetProton.material = new THREE.MeshPhongMaterial({ color: 0xcccccc });
                         
                         // Phase 3: Neutrino Eject from Proton Position
                         ejecta.neutrino.visible = true;
                         const p2 = (p - 0.5) * 2; // 0 to 1
                         
                         // Move from proton pos outward
                         const start = targetProton.position.clone();
                         const dir = new THREE.Vector3(-1, 1, 0).normalize(); 
                         const end = start.clone().add(dir.multiplyScalar(10));
                         
                         ejecta.neutrino.position.lerpVectors(start, end, p2);
                     }
                }

                renderer.render(scene, camera);
            };
            animate();

            return () => {
                cancelAnimationFrame(animId);
                if (mountRef.current && renderer) {
                    mountRef.current.removeChild(renderer.domElement);
                }
                renderer.dispose();
            };
        }, [selectedIsotope]); 

        // Helper to update state properties
        const updateState = (setter, field, value) => {
            setter(prev => ({ ...prev, [field]: value }));
        };

        return (
            <div className="fixed inset-0 z-[100] flex bg-[#0a1116] animate-in fade-in duration-300">
                {/* Sidebar - Isotope Selector */}
                <div className="w-72 border-r border-white/10 flex flex-col bg-surface-dark/95 backdrop-blur-md">
                    <div className="p-4 border-b border-white/10">
                        <button onClick={onClose} className="text-slate-400 hover:text-white flex items-center gap-2 text-sm mb-4">
                            <span className="material-symbols-outlined text-sm">arrow_back</span> Back
                        </button>
                        <h2 className="text-xl font-bold text-white"><span className="text-secondary">Decay</span> Challenge</h2>
                        <p className="text-xs text-slate-500 mt-1">Select an isotope to begin</p>
                        
                        {/* Search Input */}
                        <div className="relative mt-4">
                            <span className="material-symbols-outlined absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-xs">search</span>
                            <input 
                                type="text" 
                                placeholder="Search isotope..." 
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="w-full bg-black/20 border border-white/10 rounded-md py-1.5 pl-8 pr-2 text-xs text-white focus:outline-none focus:border-secondary transition-colors"
                            />
                        </div>
                    </div>
                    <div className="flex-1 overflow-y-auto molecule-scroll p-2 space-y-1">
                        {filteredIsotopes.map((iso, idx) => (
                            <button 
                                key={idx}
                                onClick={() => setSelectedIsotope(iso)}
                                className={`w-full text-left px-3 py-2 rounded text-sm flex justify-between items-center transition-colors ${selectedIsotope.name === iso.name ? 'bg-secondary/20 text-secondary border border-secondary/50' : 'text-slate-400 hover:bg-white/5 hover:text-white'}`}
                            >
                                {iso.name}
                                <span className="text-[10px] font-mono opacity-50">{iso.type}</span>
                            </button>
                        ))}
                        {filteredIsotopes.length === 0 && (
                            <div className="text-center text-slate-500 text-xs py-4">No isotopes found</div>
                        )}
                    </div>
                </div>

                {/* Main Content */}
                <div className="flex-1 flex flex-col relative">
                    
                    {/* Header */}
                    <div className="absolute top-0 left-0 w-full p-6 flex justify-between items-start pointer-events-none z-10">
                        <div>
                             <h1 className="text-3xl font-bold text-white mb-1">{selectedIsotope.name}</h1>
                             <div className="flex items-center gap-2">
                                <span className="px-2 py-1 bg-white/10 rounded text-xs font-mono text-white">
                                    Mass: {selectedIsotope.mass}
                                </span>
                                <span className="px-2 py-1 bg-white/10 rounded text-xs font-mono text-white">
                                    Atomic: {selectedIsotope.atomic}
                                </span>
                             </div>
                        </div>
                        <div className="bg-black/50 backdrop-blur px-4 py-2 rounded-lg border border-white/10 text-center">
                            <span className="text-xs text-slate-400 uppercase tracking-widest">Decay Type</span>
                            <div className="text-xl font-bold text-primary">{selectedIsotope.type}</div>
                        </div>
                    </div>

                    {/* 3D Canvas */}
                    <div ref={mountRef} className="flex-1 w-full bg-gradient-radial from-[#1a232e] to-[#020204]" />

                    {/* Bottom Controls */}
                    <div className="h-56 bg-surface-dark border-t border-white/10 p-4 flex flex-col gap-4 overflow-x-auto">
                        
                        {/* Equation Solver */}
                        <div className="flex items-center justify-center gap-2 sm:gap-4 text-white font-display flex-nowrap min-w-max px-4">
                            
                            {/* Original Isotope (Fixed) */}
                            <div className="flex flex-col items-center leading-none">
                                <span className="text-xs text-slate-400 border-b border-transparent">{selectedIsotope.mass}</span>
                                <span className="text-2xl font-bold">{selectedIsotope.symbol}</span>
                                <span className="text-xs text-slate-400">{selectedIsotope.atomic}</span>
                            </div>

                            <span className="text-slate-500">+</span>

                            {/* Reactant Particle Input (Left Side) */}
                            <div className="flex flex-col items-center justify-center">
                                <input 
                                    className="particle-input" 
                                    placeholder="e-"
                                    value={particleInputLeft}
                                    onChange={(e) => setParticleInputLeft(e.target.value)}
                                />
                            </div>

                            <span className="material-symbols-outlined text-slate-500 mx-2">arrow_forward</span>

                            {/* Main Product Input */}
                            <div className="flex flex-col items-center leading-none relative group">
                                <input 
                                    className="equation-input w-8 text-xs mb-1" placeholder="?" type="text"
                                    value={productMain.mass} onChange={(e) => updateState(setProductMain, 'mass', e.target.value)}
                                />
                                <input 
                                    className="equation-input w-16 text-2xl font-bold mb-1" placeholder="?" type="text"
                                    value={productMain.symbol} onChange={(e) => updateState(setProductMain, 'symbol', e.target.value)}
                                />
                                <input 
                                    className="equation-input w-8 text-xs" placeholder="?" type="text"
                                    value={productMain.atomic} onChange={(e) => updateState(setProductMain, 'atomic', e.target.value)}
                                />
                            </div>

                            <span className="text-slate-500">+</span>

                            {/* Secondary Product Input */}
                            <div className="flex flex-col items-center leading-none relative group">
                                <input 
                                    className="equation-input w-8 text-xs mb-1" placeholder="-" type="text"
                                    value={productSec.mass} onChange={(e) => updateState(setProductSec, 'mass', e.target.value)}
                                />
                                <input 
                                    className="equation-input w-12 text-2xl font-bold mb-1" placeholder="?" type="text"
                                    value={productSec.symbol} onChange={(e) => updateState(setProductSec, 'symbol', e.target.value)}
                                />
                                <input 
                                    className="equation-input w-8 text-xs" placeholder="-" type="text"
                                    value={productSec.atomic} onChange={(e) => updateState(setProductSec, 'atomic', e.target.value)}
                                />
                            </div>

                            <span className="text-slate-500">+</span>

                            {/* Product Particle Input (Right Side) */}
                            <div className="flex flex-col items-center justify-center">
                                <input 
                                    className="particle-input" 
                                    placeholder="B- v-"
                                    value={particleInputRight}
                                    onChange={(e) => setParticleInputRight(e.target.value)}
                                />
                            </div>

                            {/* Check Button */}
                            <button 
                                onClick={checkAnswer}
                                className={`ml-4 px-4 py-2 rounded-full font-bold text-xs transition-all ${status === 'correct' ? 'bg-green-500 text-white' : 'bg-white text-black hover:bg-slate-200'}`}
                            >
                                {status === 'correct' ? 'SOLVED' : 'CHECK'}
                            </button>
                        </div>

                        {/* Feedback & Timeline */}
                        <div className="flex flex-col items-center gap-2">
                             <div className={`text-sm font-bold h-5 ${status === 'correct' ? 'text-green-400' : status === 'wrong' ? 'text-red-400' : 'text-transparent'}`}>
                                 {status === 'correct' ? "That's correct! Simulating decay..." : "That's wrong, please check your equation."}
                             </div>
                             
                             <div className="w-full max-w-xl flex items-center gap-4">
                                <button 
                                    onClick={() => setIsPlaying(!isPlaying)}
                                    className="text-primary hover:text-white"
                                >
                                    <span className="material-symbols-outlined">{isPlaying ? 'pause' : 'play_arrow'}</span>
                                </button>
                                <input 
                                    type="range" 
                                    min="0" max="100" step="0.1"
                                    value={animProgress}
                                    onChange={(e) => {
                                        setIsPlaying(false);
                                        setAnimProgress(parseFloat(e.target.value));
                                    }}
                                    className="range-slider"
                                />
                             </div>
                        </div>

                    </div>
                </div>
            </div>
        );
      };

      // --- Molecular Viewer Component ---
      const MolecularViewer = ({ onClose }) => {
        const mountRef = useRef(null);
        const [selectedMoleculeName, setSelectedMoleculeName] = useState("Benzene");
        const [searchQuery, setSearchQuery] = useState("");
        const [showPi, setShowPi] = useState(false);
        const [showTau, setShowTau] = useState(false);
        const [showIonic, setShowIonic] = useState(true);
        const [showVDW, setShowVDW] = useState(true);
        const [error, setError] = useState(null);
        
        const raycaster = useRef(new THREE.Raycaster());
        const atomWrappers = useRef([]); 
        const atomMeshes = useRef([]);

        const moleculeList = useMemo(() => {
            return Object.keys(MOLECULES).filter(name => 
                name.toLowerCase().includes(searchQuery.toLowerCase())
            );
        }, [searchQuery]);

        const moleculeInfo = useMemo(() => {
            const data = MOLECULES[selectedMoleculeName];
            if (!data) return { formula: "", mass: 0 };
            let mass = 0;
            const counts = {};
            data.atoms.forEach(a => {
                counts[a.el] = (counts[a.el] || 0) + 1;
                mass += (ATOMIC_MASSES[a.el] || 0);
            });
            const order = ["C", "H", "O", "N", "Na", "Ag", "Xe"];
            let formula = "";
            order.forEach(el => {
                if (counts[el]) formula += el + (counts[el] > 1 ? counts[el] : "");
            });
            Object.keys(counts).forEach(el => {
                if (!order.includes(el)) formula += el + (counts[el] > 1 ? counts[el] : "");
            });
            return { formula, mass: mass.toFixed(2) };
        }, [selectedMoleculeName]);

        useEffect(() => {
            if (!window.THREE) { setError("Three.js not loaded"); return; }
            if (!mountRef.current) return;

            let renderer, scene, camera, controls, animId;
            try {
                const width = mountRef.current.clientWidth;
                const height = mountRef.current.clientHeight;
                scene = new THREE.Scene();
                scene.fog = new THREE.Fog(0x111111, 5, 25);
                camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 100);
                camera.position.z = 8; camera.position.y = 2;
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(width, height);
                mountRef.current.appendChild(renderer.domElement);
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true; controls.enablePan = true;
                
                const ambientLight = new THREE.AmbientLight(0x404040, 2); scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0xffffff, 1, 100); pointLight.position.set(10, 10, 10); scene.add(pointLight);
                const pointLight2 = new THREE.PointLight(0x06bcf9, 0.5, 100); pointLight2.position.set(-10, -10, 5); scene.add(pointLight2);
                const moleculeGroup = new THREE.Group(); scene.add(moleculeGroup);

                const createTextSprite = (message, color) => {
                    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
                    canvas.width = 128; canvas.height = 128; ctx.font = "Bold 40px Arial";
                    ctx.fillStyle = "rgba(0,0,0,1)"; ctx.strokeStyle = color; ctx.lineWidth = 2;
                    ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.strokeText(message, 64, 64);
                    ctx.fillStyle = "white"; ctx.fillText(message, 64, 64);
                    const texture = new THREE.CanvasTexture(canvas);
                    const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture, depthTest: false }));
                    sprite.renderOrder = 999; sprite.scale.set(0.5, 0.5, 0.5); return sprite;
                };

                const createIonicCage = (radius, color) => {
                    const s = radius * 1.6, d = s * 0.4;
                    const geometry = new THREE.BufferGeometry(); const vertices = [];
                    const corners = [[s, s, s], [s, s, -s], [s, -s, s], [s, -s, -s], [-s, s, s], [-s, s, -s], [-s, -s, s], [-s, -s, -s]];
                    corners.forEach(([x, y, z]) => {
                        vertices.push(x, y, z); vertices.push(x > 0 ? x - d : x + d, y, z);
                        vertices.push(x, y, z); vertices.push(x, y, z > 0 ? z - d : z + d);
                    });
                    geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
                    const cage = new THREE.LineSegments(geometry, new THREE.LineBasicMaterial({ color: color, depthTest: false, transparent: true, opacity: 0.8 }));
                    cage.renderOrder = 998; return cage;
                };

                const renderMolecule = () => {
                    while(moleculeGroup.children.length > 0) moleculeGroup.remove(moleculeGroup.children[0]);
                    atomWrappers.current = []; atomMeshes.current = [];
                    const data = MOLECULES[selectedMoleculeName]; if(!data) return;

                    data.atoms.forEach(atom => {
                        const radius = ELEMENT_RADII[atom.el] || 0.3; const color = ELEMENT_COLORS[atom.el] || 0xffffff;
                        const sphere = new THREE.Mesh(new THREE.SphereGeometry(radius, 32, 32), new THREE.MeshPhysicalMaterial({ color: color, roughness: 0.3, metalness: 0.2 }));
                        sphere.position.set(atom.x, atom.y, atom.z); moleculeGroup.add(sphere);
                        let label = atom.el;
                        if (showIonic && atom.role) {
                            label += (atom.role === "cation" ? "+" : "-");
                            const cage = createIonicCage(radius, atom.role === "cation" ? 0x0088ff : 0xff0044);
                            cage.position.set(atom.x, atom.y, atom.z); moleculeGroup.add(cage);
                        }
                        const sprite = createTextSprite(label, '#' + new THREE.Color(color).getHexString());
                        sprite.position.set(atom.x, atom.y, atom.z); moleculeGroup.add(sprite);
                        atomWrappers.current.push({ mesh: sphere, sprite: sprite }); atomMeshes.current.push(sphere);
                    });

                    data.bonds.forEach(bond => {
                        const s = data.atoms[bond.source], t = data.atoms[bond.target];
                        const start = new THREE.Vector3(s.x, s.y, s.z), end = new THREE.Vector3(t.x, t.y, t.z);
                        const dist = start.distanceTo(end), mid = new THREE.Vector3().addVectors(start, end).multiplyScalar(0.5);
                        
                        if (bond.type === 'ionic') {
                            if (!showIonic) return;
                            const line = new THREE.Line(new THREE.BufferGeometry().setFromPoints([start, end]), new THREE.LineDashedMaterial({ color: 0xffff00, dashSize: 0.2, gapSize: 0.1, scale: 1 }));
                            line.computeLineDistances(); moleculeGroup.add(line);
                        } else if (bond.type === 'vdw') {
                            if (!showVDW) return;
                            const line = new THREE.Line(new THREE.BufferGeometry().setFromPoints([start, end]), new THREE.LineDashedMaterial({ color: 0x00ffff, dashSize: 0.05, gapSize: 0.1, scale: 1, opacity: 0.5, transparent: true }));
                            line.computeLineDistances(); moleculeGroup.add(line);
                        } else if (showTau && bond.type === 'double') {
                             const curve = (offset) => {
                                 const tube = new THREE.Mesh(new THREE.TubeGeometry(new THREE.QuadraticBezierCurve3(start, new THREE.Vector3(mid.x, mid.y + offset, mid.z + offset), end), 8, 0.08, 8, false), new THREE.MeshStandardMaterial({ color: 0xaaaaaa }));
                                 moleculeGroup.add(tube);
                             }; curve(0.3); curve(-0.3);
                        } else {
                            const orient = new THREE.Matrix4().lookAt(start, end, new THREE.Object3D().up).multiply(new THREE.Matrix4().makeRotationX(Math.PI/2));
                            const cyl = new THREE.Mesh(new THREE.CylinderGeometry(0.1, 0.1, dist, 12), new THREE.MeshStandardMaterial({ color: 0x888888 }));
                            cyl.applyMatrix4(orient); cyl.position.copy(mid); moleculeGroup.add(cyl);
                            if (bond.type === 'double' && !showTau) {
                                 const cyl2 = new THREE.Mesh(new THREE.CylinderGeometry(0.05, 0.05, dist, 12), new THREE.MeshStandardMaterial({ color: 0xffffff }));
                                 cyl2.applyMatrix4(orient); cyl2.position.copy(mid); cyl2.position.x += 0.15; moleculeGroup.add(cyl2);
                            }
                        }
                        if (showPi && bond.type === 'double') {
                            const lobe = (pos, up) => {
                                const m = new THREE.Mesh(new THREE.SphereGeometry(0.3, 16, 16).scale(0.5, 1, 0.5), new THREE.MeshPhongMaterial({ color: up ? 0x0000ff : 0xff0000, transparent: true, opacity: 0.4 }));
                                m.position.set(pos.x, pos.y + (up ? 0.5 : -0.5), pos.z); moleculeGroup.add(m);
                            }; lobe(s, true); lobe(s, false); lobe(t, true); lobe(t, false);
                        }
                    });
                };
                renderMolecule();

                const animate = () => {
                    animId = requestAnimationFrame(animate); controls.update();
                    if (atomWrappers.current.length) {
                        const camPos = camera.position; 
                        atomWrappers.current.forEach(({ mesh, sprite }) => {
                            raycaster.current.set(camPos, new THREE.Vector3().subVectors(mesh.position, camPos).normalize());
                            const intersects = raycaster.current.intersectObjects(atomMeshes.current);
                            sprite.visible = !intersects.length || intersects[0].object === mesh;
                        });
                    }
                    renderer.render(scene, camera);
                };
                animate();
            } catch (e) { setError(e.message); }
            return () => { if (mountRef.current && renderer) mountRef.current.removeChild(renderer.domElement); renderer && renderer.dispose(); if(animId) cancelAnimationFrame(animId); };
        }, [selectedMoleculeName, showPi, showTau, showIonic, showVDW]);

        if (error) return <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/95 text-white">{error} <button onClick={onClose} className="ml-4 px-2 py-1 bg-gray-700">Close</button></div>;

        return (
            <div className="fixed inset-0 z-[100] flex bg-black/95 backdrop-blur-xl animate-in fade-in duration-300">
                <div className="w-80 border-r border-white/10 bg-[#0a0f14] flex flex-col p-6 z-10 shrink-0">
                    <button onClick={onClose} className="mb-6 flex items-center gap-2 text-slate-400 hover:text-white transition-colors"><span className="material-symbols-outlined">arrow_back</span> Back</button>
                    <h2 className="text-2xl font-bold text-white mb-2">Molecular<br/><span className="text-primary">Viewer</span></h2>
                    <div className="relative mb-6"><span className="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-sm">search</span><input type="text" placeholder="Search..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} className="w-full bg-black/50 border border-white/10 rounded-lg py-2 pl-9 pr-4 text-sm text-white"/></div>
                    <div className="flex-1 overflow-y-auto molecule-scroll pr-2 space-y-2 mb-6">
                        {moleculeList.map(name => (
                            <button key={name} onClick={() => setSelectedMoleculeName(name)} className={`w-full text-left px-4 py-3 rounded-lg text-sm transition-all flex justify-between ${selectedMoleculeName === name ? 'bg-primary/20 text-primary border border-primary/50' : 'text-slate-400 hover:bg-white/5'}`}>{name} {selectedMoleculeName === name && <span className="material-symbols-outlined text-xs">hexagon</span>}</button>
                        ))}
                    </div>
                    <div className="border-t border-white/10 pt-6 space-y-4">
                        <label className="flex items-center justify-between cursor-pointer group"><span className="text-sm text-slate-300">Pi Orbitals</span><div onClick={() => setShowPi(!showPi)} className={`w-10 h-5 rounded-full relative transition-colors ${showPi ? 'bg-secondary' : 'bg-slate-700'}`}><div className={`absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-transform ${showPi ? 'translate-x-5' : ''}`}/></div></label>
                        <label className="flex items-center justify-between cursor-pointer group"><span className="text-sm text-slate-300">Tau / Bent Bonds</span><div onClick={() => setShowTau(!showTau)} className={`w-10 h-5 rounded-full relative transition-colors ${showTau ? 'bg-primary' : 'bg-slate-700'}`}><div className={`absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-transform ${showTau ? 'translate-x-5' : ''}`}/></div></label>
                        <label className="flex items-center justify-between cursor-pointer group"><span className="text-sm text-slate-300">Ionic Bonds</span><div onClick={() => setShowIonic(!showIonic)} className={`w-10 h-5 rounded-full relative transition-colors ${showIonic ? 'bg-yellow-500' : 'bg-slate-700'}`}><div className={`absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-transform ${showIonic ? 'translate-x-5' : ''}`}/></div></label>
                        <label className="flex items-center justify-between cursor-pointer group"><span className="text-sm text-slate-300">Van der Waals</span><div onClick={() => setShowVDW(!showVDW)} className={`w-10 h-5 rounded-full relative transition-colors ${showVDW ? 'bg-cyan-400' : 'bg-slate-700'}`}><div className={`absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-transform ${showVDW ? 'translate-x-5' : ''}`}/></div></label>
                    </div>
                </div>
                <div className="flex-1 relative bg-gradient-to-br from-gray-900 to-black">
                    <div ref={mountRef} className="w-full h-full cursor-move" />
                    <div className="absolute top-6 left-6 p-4 rounded-xl bg-black/40 backdrop-blur border border-white/10 pointer-events-none z-20">
                         <h2 className="text-2xl font-bold text-white mb-1">{selectedMoleculeName}</h2>
                         <div className="text-sm font-mono text-slate-300">Formula: <span className="text-primary">{moleculeInfo.formula}</span> | Mass: <span className="text-secondary">{moleculeInfo.mass} g/mol</span></div>
                    </div>
                    <div className="absolute bottom-6 right-6 bg-black/60 backdrop-blur p-4 rounded-xl border border-white/10 pointer-events-none">
                        <div className="flex gap-4 text-xs font-mono">
                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-[#333333] border border-white/20"></span> C</div>
                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-white"></span> H</div>
                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-red-600"></span> O</div>
                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-blue-600"></span> N</div>
                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-purple-600"></span> Na</div>
                            <div className="flex items-center gap-2"><span className="w-3 h-3 rounded-full bg-cyan-400"></span> Xe</div>
                        </div>
                    </div>
                </div>
            </div>
        );
      };

      // --- Eclipse Simulation Component (Enhanced with Full Solar System) ---
      const EclipseSimulation = ({ onClose }) => {
        const mountRef = useRef(null);
        
        // Simulation State
        const simRef = useRef({ 
            speed: 1, 
            mode: 'orbit', 
            offset: 0, 
            animId: null,
            sunTemp: 50,
            moonDist: 10,
            prevCoverage: 0
        });
        
        const planetsRef = useRef([]); // Store planet meshes

        const [timeSpeed, setTimeSpeed] = useState(1);
        const [viewMode, setViewMode] = useState('orbit'); 
        const [moonOffset, setMoonOffset] = useState(0); 
        const [sunTemp, setSunTemp] = useState(50);
        const [moonDist, setMoonDist] = useState(10);
        const [eclipseStatus, setEclipseStatus] = useState("Not Eclipsed");
        const [skyDarkness, setSkyDarkness] = useState(0);
        const [isControlsMinimized, setIsControlsMinimized] = useState(false);

        // Planet Data
        const PLANET_DATA = useMemo(() => [
            { name: "Mercury", r: 1.2, dist: 20, color: 0x95a5a6, speed: 2.5, offset: Math.random() * 10 },
            { name: "Venus", r: 1.6, dist: 32, color: 0xe67e22, speed: 1.8, offset: Math.random() * 10 },
            // Earth is at 45
            { name: "Mars", r: 1.4, dist: 60, color: 0xc0392b, speed: 0.8, offset: Math.random() * 10 },
            { name: "Jupiter", r: 4.5, dist: 90, color: 0xd35400, speed: 0.4, offset: Math.random() * 10 },
            { name: "Saturn", r: 3.8, dist: 130, color: 0xf1c40f, speed: 0.3, offset: Math.random() * 10, ring: { i: 4.8, o: 7, c: 0x7f8c8d } },
            { name: "Uranus", r: 2.8, dist: 170, color: 0x1abc9c, speed: 0.2, offset: Math.random() * 10 },
            { name: "Neptune", r: 2.7, dist: 200, color: 0x2980b9, speed: 0.1, offset: Math.random() * 10 }
        ], []);

        // Sync State to Ref
        useEffect(() => {
            if (simRef.current) {
                simRef.current.speed = timeSpeed;
                simRef.current.mode = viewMode;
                simRef.current.offset = moonOffset;
                simRef.current.sunTemp = sunTemp;
                simRef.current.moonDist = moonDist;
            }
        }, [timeSpeed, viewMode, moonOffset, sunTemp, moonDist]);

        // Helper: Sun Color Interpolation
        const getSunColor = (t) => {
            const stops = [
                { t: 0, r: 70, g: 0, b: 0 },       // Dark Red
                { t: 25, r: 255, g: 50, b: 0 },    // Red
                { t: 40, r: 255, g: 140, b: 0 },   // Orange
                { t: 60, r: 255, g: 220, b: 0 },   // Yellow
                { t: 80, r: 255, g: 255, b: 255 }, // White
                { t: 100, r: 100, g: 180, b: 255 } // Blue
            ];
            let s1 = stops[0], s2 = stops[stops.length-1];
            for(let i=0; i<stops.length-1; i++){
                if(t >= stops[i].t && t <= stops[i+1].t){
                    s1 = stops[i]; s2 = stops[i+1]; break;
                }
            }
            const factor = (t - s1.t) / (s2.t - s1.t);
            const r = s1.r + (s2.r - s1.r) * factor;
            const g = s1.g + (s2.g - s1.g) * factor;
            const b = s1.b + (s2.b - s1.b) * factor;
            return new THREE.Color(`rgb(${Math.round(r)},${Math.round(g)},${Math.round(b)})`);
        };

        useEffect(() => {
            if (!mountRef.current || !window.THREE) return;

            // Initial dimensions
            let width = mountRef.current.clientWidth;
            let height = mountRef.current.clientHeight;
            
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);
            
            // Camera
            const camera = new THREE.PerspectiveCamera(60, width / height, 0.1, 2000);
            camera.position.set(0, 60, 100);

            const renderer = new THREE.WebGLRenderer({ antialias: true, logarithmicDepthBuffer: true });
            renderer.setSize(width, height);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            mountRef.current.appendChild(renderer.domElement);

            // Robust Resize Observer
            const resizeObserver = new ResizeObserver(entries => {
                for (let entry of entries) {
                    const { width, height } = entry.contentRect;
                    // Only update if dimensions are valid and changed
                    if (width > 0 && height > 0) {
                        renderer.setSize(width, height);
                        camera.aspect = width / height;
                        camera.updateProjectionMatrix();
                    }
                }
            });
            resizeObserver.observe(mountRef.current);

            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enablePan = true;
            controls.enableDamping = true;
            controls.screenSpacePanning = true; // Better for navigating solar system plane
            controls.maxDistance = 800;

            // --- Starfield ---
            // Subtle stars for when eclipse happens
            const starGeo = new THREE.BufferGeometry();
            const starCount = 3000;
            const starPos = new Float32Array(starCount * 3);
            for(let i=0; i<starCount*3; i++) {
                const r = 900 + Math.random() * 400; // Push stars far back
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.acos(2 * Math.random() - 1);
                starPos[i] = r * Math.sin(phi) * Math.cos(theta);
                starPos[i+1] = r * Math.sin(phi) * Math.sin(theta);
                starPos[i+2] = r * Math.cos(phi);
            }
            starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
            const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color: 0xffffff, size: 1.5, transparent: true, opacity: 1}));
            scene.add(stars);

            // --- Solar System ---
            const sunGeo = new THREE.SphereGeometry(6, 64, 64);
            const sunMat = new THREE.MeshBasicMaterial({ color: 0xffdd00 });
            const sun = new THREE.Mesh(sunGeo, sunMat);
            scene.add(sun);

            const sunLight = new THREE.PointLight(0xffffff, 2, 800);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 2048;
            sunLight.shadow.mapSize.height = 2048;
            sunLight.shadow.camera.near = 0.1;
            sunLight.shadow.camera.far = 500;
            sunLight.shadow.bias = -0.0001; // Reduce shadow acne
            scene.add(sunLight);

            // Sun Glow
            const glowCanvas = document.createElement('canvas');
            glowCanvas.width = 128; glowCanvas.height = 128;
            const ctx = glowCanvas.getContext('2d');
            // Clear rect to ensure full transparency base
            ctx.clearRect(0,0,128,128);
            const grad = ctx.createRadialGradient(64,64,0,64,64,64);
            grad.addColorStop(0, 'rgba(255,255,255,1)');
            grad.addColorStop(0.4, 'rgba(255,255,255,0.2)');
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = grad; 
            ctx.fillRect(0,0,128,128);
            
            const sunGlow = new THREE.Sprite(new THREE.SpriteMaterial({ 
                map: new THREE.CanvasTexture(glowCanvas), 
                color: 0xffdd00, 
                blending: THREE.AdditiveBlending,
                transparent: true,
                depthWrite: false
            }));
            sunGlow.scale.set(30, 30, 1);
            sun.add(sunGlow);

            // Add Planets
            planetsRef.current = [];
            PLANET_DATA.forEach(data => {
                const geo = new THREE.SphereGeometry(data.r, 32, 32);
                const mat = new THREE.MeshPhongMaterial({ color: data.color, shininess: 10 });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.castShadow = true;
                mesh.receiveShadow = true;
                
                if (data.ring) {
                    const ringGeo = new THREE.RingGeometry(data.ring.i, data.ring.o, 64);
                    const ringMat = new THREE.MeshBasicMaterial({ 
                        color: data.ring.c, 
                        side: THREE.DoubleSide, 
                        transparent: true, 
                        opacity: 0.6 
                    });
                    const ring = new THREE.Mesh(ringGeo, ringMat);
                    ring.rotation.x = Math.PI / 2;
                    mesh.add(ring);
                }
                
                scene.add(mesh);
                planetsRef.current.push({ mesh, data });
            });

            // Earth
            const earthR = 1.8;
            const earthDist = 45;
            const earthGeo = new THREE.SphereGeometry(earthR, 64, 64);
            const earthMat = new THREE.MeshPhongMaterial({ 
                color: 0x2233ff,
                emissive: 0x000022,
                specular: 0x111111,
                shininess: 10
            });
            const earth = new THREE.Mesh(earthGeo, earthMat);
            earth.castShadow = true;
            earth.receiveShadow = true;
            
            const earthGroup = new THREE.Group();
            earthGroup.add(earth);
            scene.add(earthGroup);

            // Moon
            const moonPivot = new THREE.Group();
            earth.add(moonPivot);
            
            const moonGeo = new THREE.SphereGeometry(0.5, 64, 64);
            const moonMat = new THREE.MeshPhongMaterial({ color: 0x555555, shininess: 0 });
            const moon = new THREE.Mesh(moonGeo, moonMat);
            moon.castShadow = true;
            moon.receiveShadow = true;
            moonPivot.add(moon);

            // Atmosphere (The "Clear Sky" Background)
            const atmosGeo = new THREE.SphereGeometry(400, 32, 32);
            const atmosMat = new THREE.MeshBasicMaterial({ color: 0x87CEEB, side: THREE.BackSide, transparent: true, opacity: 0.8, depthWrite: false });
            const atmosphere = new THREE.Mesh(atmosGeo, atmosMat);
            scene.add(atmosphere);

            // --- Animation Loop ---
            let time = 0;
            const loop = () => {
                const animId = requestAnimationFrame(loop);
                if (!simRef.current) return;
                
                simRef.current.animId = animId;
                const speed = simRef.current.speed;
                const mode = simRef.current.mode;
                const offset = simRef.current.offset;
                const currentSunTemp = simRef.current.sunTemp;
                const currentMoonDist = simRef.current.moonDist;

                time += 0.005 * speed;

                // Update Sun Color
                const sunC = getSunColor(currentSunTemp);
                sunMat.color.copy(sunC);
                sunLight.color.copy(sunC);
                sunGlow.material.color.copy(sunC);

                // Update Planets
                planetsRef.current.forEach(p => {
                    const angle = time * p.data.speed + p.data.offset;
                    p.mesh.position.x = Math.cos(angle) * p.data.dist;
                    p.mesh.position.z = Math.sin(angle) * p.data.dist;
                    // Axial rotation depends on speed now
                    p.mesh.rotation.y += 0.01 * speed;
                });

                // Update Earth Orbit
                earthGroup.position.x = Math.cos(time) * earthDist;
                earthGroup.position.z = Math.sin(time) * earthDist;
                // Axial rotation depends on speed now
                earth.rotation.y += 0.01 * speed;

                // Update Moon
                // Moon orbital speed depends on time (which depends on speed)
                const moonSpeed = time * 12;
                moonPivot.rotation.y = moonSpeed;
                moon.position.set(currentMoonDist, Math.sin(moonSpeed) * offset, 0);

                // --- Eclipse Calculation (Ground View Logic) ---
                const earthPos = new THREE.Vector3();
                earth.getWorldPosition(earthPos);
                
                const sunPos = new THREE.Vector3(0,0,0);
                const moonPos = new THREE.Vector3();
                moon.getWorldPosition(moonPos);

                const earthToSun = new THREE.Vector3().subVectors(sunPos, earthPos).normalize();
                
                // Camera on surface facing sun
                const surfacePos = earthPos.clone().add(earthToSun.clone().multiplyScalar(earthR + 0.1));
                
                // Check eclipse coverage
                const viewToSun = new THREE.Vector3().subVectors(sunPos, surfacePos);
                const distToSun = viewToSun.length();
                viewToSun.normalize();

                const viewToMoon = new THREE.Vector3().subVectors(moonPos, surfacePos);
                const distToMoon = viewToMoon.length();
                viewToMoon.normalize();

                const sunAngRad = Math.atan(6 / distToSun);
                const moonAngRad = Math.atan(0.5 / distToMoon);
                const separationAngle = viewToSun.angleTo(viewToMoon);
                
                let coverage = 0;
                const totalRad = sunAngRad + moonAngRad;
                
                if (separationAngle < totalRad) {
                     if (separationAngle <= Math.abs(sunAngRad - moonAngRad)) {
                         coverage = moonAngRad >= sunAngRad ? 1.0 : (moonAngRad*moonAngRad)/(sunAngRad*sunAngRad);
                     } else {
                         coverage = 1.0 - (separationAngle / totalRad); 
                     }
                }
                
                // Status Logic
                let status = "Not Eclipsed";
                const prev = simRef.current.prevCoverage;
                if (coverage > 0) {
                    if (coverage >= 0.98) status = "TOTAL ECLIPSE";
                    else if (coverage > prev) status = "Approaching Eclipse";
                    else status = "Departing Eclipse";
                }
                simRef.current.prevCoverage = coverage;
                
                // Lighting & Atmosphere
                const darkness = Math.min(1, coverage * 1.5);
                
                if (mode === 'earth') {
                    camera.position.copy(surfacePos);
                    camera.lookAt(sunPos);
                    
                    atmosphere.position.copy(surfacePos);
                    
                    // Sky Color Logic
                    // Base sky is a mix of Sun color and Blue
                    // Sun Red -> Sky Pink/Orange
                    // Sun Blue -> Sky Deep Blue
                    const skyBase = sunC.clone().lerp(new THREE.Color(0x87CEEB), 0.6);
                    
                    // As eclipse happens, sky gets dark
                    const finalSky = skyBase.clone().multiplyScalar(1 - darkness);
                    atmosphere.material.color.copy(finalSky);
                    
                    // Opacity drops to reveal stars only when VERY dark
                    atmosphere.material.opacity = Math.max(0.1, 1 - darkness * 1.2);
                    
                    sunLight.intensity = 2 * (1 - darkness);
                    ambient.intensity = 0.5 * (1 - darkness);
                } else {
                    controls.update();
                    atmosphere.material.opacity = 0; // Hide atmosphere in orbit
                    sunLight.intensity = 2;
                    ambient.intensity = 0.5;
                }
                
                // React UI Updates
                if (Math.random() < 0.1) { 
                   setEclipseStatus(status);
                   setSkyDarkness(coverage);
                }
                
                renderer.render(scene, camera);
            };
            
            const ambient = new THREE.AmbientLight(0x404040, 0.5);
            scene.add(ambient);
            
            loop();

            return () => {
                cancelAnimationFrame(simRef.current.animId);
                resizeObserver.disconnect(); // Cleanup observer
                if (mountRef.current && renderer) {
                    mountRef.current.removeChild(renderer.domElement);
                }
                renderer.dispose();
            };
        }, [PLANET_DATA]); // Add PLANET_DATA to dependency

        return (
            <div className="fixed inset-0 z-[100] bg-black/95 animate-in fade-in duration-300 font-display">
                <div ref={mountRef} className="absolute inset-0 z-0 block w-full h-full" />
                
                {/* HUD */}
                <div className="absolute top-8 left-1/2 -translate-x-1/2 text-center pointer-events-none z-10 transition-opacity duration-300" style={{opacity: isControlsMinimized ? 0 : 1}}>
                    <h1 className={`text-4xl font-black tracking-tighter transition-colors duration-500 ${skyDarkness > 0.9 ? 'text-secondary animate-pulse' : 'text-white'}`}>
                        {eclipseStatus}
                    </h1>
                    <div className="text-sm font-mono text-slate-400 mt-2 bg-black/50 px-3 py-1 rounded">
                        Obscuration: {(skyDarkness * 100).toFixed(1)}%
                    </div>
                </div>

                {/* Minimized Toggle Button */}
                <button 
                    onClick={() => setIsControlsMinimized(!isControlsMinimized)}
                    className="absolute bottom-8 right-8 z-30 bg-surface-dark/90 backdrop-blur border border-white/10 p-3 rounded-full text-white hover:text-primary hover:border-primary transition-all shadow-lg hover:shadow-neon"
                >
                    <span className="material-symbols-outlined">{isControlsMinimized ? 'tune' : 'expand_more'}</span>
                </button>

                {/* Controls UI */}
                <div className={`absolute bottom-8 left-1/2 -translate-x-1/2 w-full max-w-3xl bg-surface-dark/90 backdrop-blur-xl rounded-2xl border border-white/10 z-20 flex flex-col shadow-2xl transition-all duration-300 overflow-hidden ${isControlsMinimized ? 'h-0 opacity-0 p-0 pointer-events-none' : 'p-6 opacity-100'}`}>
                    <div className="flex justify-between items-center border-b border-white/10 pb-4">
                        <div className="flex items-center gap-2">
                            <span className="material-symbols-outlined text-primary">solar_power</span>
                            <h2 className="text-xl font-bold text-white">System <span className="text-primary">Control</span></h2>
                        </div>
                        <button onClick={onClose} className="text-slate-400 hover:text-white flex items-center gap-2 text-sm px-3 py-1 rounded hover:bg-white/5 transition-colors">
                            <span className="material-symbols-outlined">close</span> Terminate
                        </button>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
                        {/* Column 1 */}
                        <div className="space-y-4">
                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest">Orbital Mechanics</h3>
                            
                            <div className="space-y-2">
                                <div className="flex justify-between text-xs text-slate-300">
                                    <span>Time Dilation (Speed)</span>
                                    <span className="font-mono text-primary">{timeSpeed.toFixed(1)}x</span>
                                </div>
                                <input type="range" min="0" max="5" step="0.1" value={timeSpeed} onChange={(e) => setTimeSpeed(parseFloat(e.target.value))} className="range-slider"/>
                            </div>

                            <div className="space-y-2">
                                <div className="flex justify-between text-xs text-slate-300">
                                    <span>Moon Distance</span>
                                    <span className="font-mono text-primary">{moonDist} units</span>
                                </div>
                                <input type="range" min="5" max="20" step="0.5" value={moonDist} onChange={(e) => setMoonDist(parseFloat(e.target.value))} className="range-slider"/>
                            </div>

                            <div className="space-y-2">
                                <div className="flex justify-between text-xs text-slate-300">
                                    <span>Orbital Inclination</span>
                                    <span className="font-mono text-primary">{moonOffset === 0 ? 'Aligned' : 'Offset'}</span>
                                </div>
                                <input type="range" min="-3" max="3" step="0.1" value={moonOffset} onChange={(e) => setMoonOffset(parseFloat(e.target.value))} className="range-slider"/>
                            </div>
                        </div>

                        {/* Column 2 */}
                        <div className="space-y-4">
                            <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest">Stellar Physics</h3>
                            
                            <div className="space-y-2">
                                <div className="flex justify-between text-xs text-slate-300">
                                    <span>Photosphere Temperature</span>
                                    <span className="font-mono text-primary">{Math.round(2000 + sunTemp * 100)}K</span>
                                </div>
                                <div className="h-1 w-full rounded-full temp-slider mb-2"></div>
                                <input type="range" min="0" max="100" value={sunTemp} onChange={(e) => setSunTemp(parseFloat(e.target.value))} className="range-slider"/>
                            </div>

                            <div className="bg-black/40 p-3 rounded-lg border border-white/5 mt-4">
                                <h4 className="text-[10px] font-bold text-slate-400 uppercase mb-2">Telemetry</h4>
                                <div className="grid grid-cols-2 gap-2 text-[10px] font-mono text-slate-300">
                                    <div>View: <span className="text-white">{viewMode === 'orbit' ? 'Heliospheric' : 'Surface'}</span></div>
                                    <div>Status: <span className={eclipseStatus === 'TOTAL ECLIPSE' ? 'text-red-500 animate-pulse' : 'text-green-500'}>{eclipseStatus}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="flex justify-center pt-2 border-t border-white/10 mt-2">
                        <div className="bg-black/40 p-1 rounded-lg flex gap-1">
                            <button onClick={() => setViewMode('orbit')} className={`px-6 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all ${viewMode === 'orbit' ? 'bg-primary text-black shadow-neon' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>
                                Orbit View
                            </button>
                            <button onClick={() => setViewMode('earth')} className={`px-6 py-2 rounded-md text-xs font-bold uppercase tracking-wider transition-all ${viewMode === 'earth' ? 'bg-primary text-black shadow-neon' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>
                                View from Ground
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        );
      };

      // --- Contact Component ---
      const Contact = () => {
        return (
           <section id="contact" className="py-32 px-4 sm:px-6 relative overflow-hidden bg-void">
            <ShootingStars />
            <div className="absolute top-0 w-full h-px bg-gradient-to-r from-transparent via-secondary/50 to-transparent"></div>
            <div className="mx-auto max-w-2xl text-center relative z-10">
              <h2 className="text-4xl font-black text-white mb-6 sm:text-6xl tracking-tighter">Signal Received?</h2>
              <p className="text-lg text-slate-400 mb-12 font-light">Ready to collaborate on the next frontier of web design? <br className="hidden sm:block"/> My frequency is open for new opportunities.</p>
              <div className="flex flex-col sm:flex-row gap-6 justify-center">
                <a href="mailto:nguyennhathanhhuy@gmail.com" className="flex items-center justify-center gap-3 bg-[#0a0f14]/80 backdrop-blur border border-slate-800 hover:border-secondary text-white px-8 py-4 rounded-lg transition-all group shadow-lg hover:shadow-neon-purple"><span className="material-symbols-outlined text-secondary group-hover:animate-pulse">mail</span><span className="font-medium tracking-wide">nguyennhathanhhuy@gmail.com</span></a>
                <div className="flex gap-4 justify-center items-center">{['GitHub', 'LinkedIn'].map((platform) => (<a key={platform} href="#" className={`h-14 w-14 flex items-center justify-center rounded-lg bg-[#0a0f14]/80 backdrop-blur border border-slate-800 text-slate-400 hover:text-white hover:border-${platform === 'GitHub' ? 'primary' : 'secondary'} hover:shadow-${platform === 'GitHub' ? 'neon' : 'neon-purple'} transition-all`} aria-label={platform}><span className="material-symbols-outlined">{platform === 'GitHub' ? 'code_blocks' : 'person_search'}</span></a>))}</div>
              </div>
            </div>
          </section>
        );
      };

      // --- Black Hole Background ---
      const BlackHoleBackground = ({ progress }) => {
        const canvasRef = useRef(null); const angleRef = useRef(0);
        useEffect(() => {
          const canvas = canvasRef.current; const ctx = canvas.getContext('2d');
          const render = () => {
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            const w = canvas.width; const h = canvas.height; const cx = w / 2; const cy = h / 2;
            ctx.fillStyle = '#020204'; ctx.fillRect(0, 0, w, h);
            for(let i=0; i<150; i++) {
                const x = (Math.sin(i * 123.456) * 9999) % w; const y = (Math.cos(i * 654.321) * 9999) % h;
                const size = (Math.sin(i) + 1.5) * 0.8; const opacity = (Math.cos(i) + 1) * 0.3 + 0.1;
                ctx.fillStyle = `rgba(255,255,255,${Math.abs(opacity)})`; ctx.beginPath(); ctx.arc(Math.abs(x), Math.abs(y), size, 0, Math.PI * 2); ctx.fill();
            }
            const p = progress; const merged = p > 0.98; const maxSep = Math.min(w, h) * 0.25;
            const currentOrbitRadius = merged ? 0 : (maxSep/2) * (1 - p);
            angleRef.current += 0.02 + (Math.pow(p, 3) * 0.15); const angle = angleRef.current;
            ctx.save(); ctx.translate(cx, cy);
            if (!merged) {
                ctx.save(); ctx.rotate(angle * 0.2); 
                for(let i=0; i<8; i++) {
                    const waveR = ((i/8 + Date.now()/10000 * (0.1+p*0.4)) % 1) * Math.max(w,h)*0.6;
                    ctx.strokeStyle = `rgba(100, 100, 255, ${(p * 0.6 + 0.1) * (1 - waveR/Math.max(w,h))})`;
                    ctx.lineWidth = 1 + p * 5; ctx.beginPath(); ctx.ellipse(0, 0, waveR, waveR * (1 - p * 0.1), -angle, 0, Math.PI * 2); ctx.stroke();
                }
                ctx.restore();
            }
            const drawBH = (x, y, r, c) => {
                const grad = ctx.createRadialGradient(x, y, r * 0.8, x, y, r * 3); grad.addColorStop(0, '#000'); grad.addColorStop(0.2, c); grad.addColorStop(1, 'transparent');
                ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(x, y, r * 3, 0, Math.PI * 2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(x, y, r * 0.95, 0, Math.PI * 2); ctx.fill();
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.shadowColor = c; ctx.shadowBlur = 15; ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.stroke(); ctx.shadowBlur = 0;
            };
            if(merged) drawBH(0,0,32,'rgba(150, 200, 255, 0.9)');
            else {
                drawBH(Math.cos(angle)*currentOrbitRadius, Math.sin(angle)*currentOrbitRadius, 20, 'rgba(6, 188, 249, 0.8)');
                drawBH(Math.cos(angle+Math.PI)*currentOrbitRadius, Math.sin(angle+Math.PI)*currentOrbitRadius, 20, 'rgba(168, 85, 247, 0.8)');
            }
            ctx.restore();
          };
          const animId = requestAnimationFrame(function loop() { render(); requestAnimationFrame(loop); });
          return () => cancelAnimationFrame(animId);
        }, [progress]);
        return <canvas ref={canvasRef} className="absolute inset-0 z-0 h-full w-full object-cover" />;
      };

      const Navbar = () => {
        const [isOpen, setIsOpen] = useState(false);
        const [scrolled, setScrolled] = useState(false);
        useEffect(() => { const h = () => setScrolled(window.scrollY > 20); window.addEventListener('scroll', h); return () => window.removeEventListener('scroll', h); }, []);
        return (
          <nav className={`fixed top-0 z-50 w-full border-b transition-colors duration-300 ${scrolled ? 'border-white/5 bg-background-dark/90 backdrop-blur-md' : 'border-transparent bg-transparent'}`}>
            <div className="mx-auto flex h-16 max-w-7xl items-center justify-between px-6 lg:px-8">
              <div className="flex items-center gap-4"><div className="h-10 w-10 rounded-full bg-cover bg-center ring-2 ring-primary/50 shadow-neon" style={{ backgroundImage: `url('${PROFILE_AVATAR}')` }}/><span className="text-lg font-bold tracking-tight text-white hidden sm:block">Thanh Huy</span></div>
              <div className="hidden md:flex items-center gap-8">{NAV_ITEMS.map((item) => (<a key={item.label} href={item.href} className="text-sm font-medium text-slate-300 hover:text-primary transition-colors">{item.label}</a>))}</div>
              <button onClick={() => setIsOpen(!isOpen)} className="md:hidden p-2 text-slate-300 hover:text-white"><span className="material-symbols-outlined">{isOpen ? 'close' : 'menu'}</span></button>
            </div>
            {isOpen && (<div className="md:hidden absolute top-16 left-0 w-full bg-background-dark/95 border-b border-white/5 backdrop-blur-md py-4"><div className="flex flex-col items-center gap-4">{NAV_ITEMS.map((item) => (<a key={item.label} href={item.href} onClick={() => setIsOpen(false)} className="text-base font-medium text-slate-300 hover:text-primary transition-colors">{item.label}</a>))}</div></div>)}
          </nav>
        );
      };

      const Hero = () => {
        const [timeData, setTimeData] = useState(100); const [isControlOpen, setIsControlOpen] = useState(true);
        return (
          <section id="home" className="relative flex min-h-[90vh] flex-col items-center justify-center overflow-hidden px-4 sm:px-6 bg-[#020204]">
            <BlackHoleBackground progress={timeData / 100} />
            <div className="absolute inset-0 z-0 bg-gradient-to-t from-background-dark via-transparent to-background-dark/50 pointer-events-none"></div>
            <div className="relative z-10 mx-auto max-w-5xl text-center mt-10 pointer-events-none">
              <p className="mb-4 text-xs font-bold uppercase tracking-[0.2em] text-primary/80">2026 Portfolio</p>
              <h1 className="mb-6 text-5xl font-black leading-tight tracking-tight text-white sm:text-7xl lg:text-8xl drop-shadow-2xl">Atomizing the <span className="text-transparent bg-clip-text bg-gradient-to-r from-primary via-cyan-300 to-white">Celestial</span> <br/><span className="text-transparent bg-clip-text bg-gradient-to-r from-secondary via-purple-400 to-white">Bodies</span></h1>
              <p className="mx-auto mb-10 max-w-2xl text-lg font-light leading-relaxed text-slate-300 sm:text-xl drop-shadow-md">I'm <span className="text-white font-medium">Thanh Huy</span>. I am a student who is dedicated to <GradientText>chemistry and astronomy</GradientText>. I use my coding skills to create digital experiences.</p>
            </div>
            <div className="relative z-20 flex flex-col sm:flex-row gap-4 justify-center items-center">
              <a href="#projects" className="group relative flex h-12 items-center justify-center overflow-hidden rounded-full bg-primary px-8 text-sm font-bold text-[#020204] transition-all hover:bg-cyan-300 hover:shadow-neon"><span className="relative z-10 mr-2">Explore Universe</span><span className="material-symbols-outlined relative z-10 text-[20px] transition-transform group-hover:translate-x-1">rocket_launch</span></a>
              <a href="#contact" className="flex h-12 items-center justify-center rounded-full border border-slate-700 px-8 text-sm font-bold text-white transition-colors hover:border-secondary hover:text-secondary hover:shadow-neon-purple bg-surface-dark/50 backdrop-blur-sm">Contact Me</a>
            </div>
            <div className="absolute bottom-10 left-0 right-0 mx-auto w-full max-w-md z-30 px-6 flex justify-center">
                {isControlOpen ? (<div className="w-full bg-surface-dark/60 backdrop-blur-md p-4 rounded-xl border border-white/10 shadow-2xl animate-in fade-in slide-in-from-bottom-4 duration-500"><div className="flex justify-between items-center mb-3"><div className="flex justify-between text-[10px] text-primary uppercase font-mono tracking-widest gap-4"><span>Binary System</span><span>Singularity</span></div><button onClick={() => setIsControlOpen(false)} className="text-slate-400 hover:text-white transition-colors"><span className="material-symbols-outlined text-sm">remove</span></button></div><input type="range" min="0" max="100" value={timeData} onChange={(e) => setTimeData(Number(e.target.value))} className="range-slider"/><div className="flex justify-between items-center mt-2"><span className="text-[10px] text-slate-400 font-mono">T-Minus: {(100 - timeData).toFixed(0)} units</span><span className={`text-[10px] font-mono transition-colors ${timeData > 95 ? 'text-red-500 animate-pulse font-bold' : 'text-slate-500'}`}>{timeData > 95 ? 'CRITICAL: MERGER IMMINENT' : 'STATUS: STABLE ORBIT'}</span></div></div>) : (<button onClick={() => setIsControlOpen(true)} className="flex items-center gap-2 bg-surface-dark/40 backdrop-blur-sm border border-white/10 hover:border-primary/50 text-slate-300 hover:text-white px-4 py-2 rounded-full transition-all shadow-lg hover:shadow-neon"><span className="material-symbols-outlined text-sm">tune</span><span className="text-xs font-bold uppercase tracking-wider">Initialize Controls</span></button>)}
            </div>
          </section>
        );
      };

      const Projects = ({ onOpenProject }) => {
        return (
          <section id="projects" className="py-24 px-4 sm:px-6 lg:px-8 relative bg-void overflow-hidden">
            <div className="absolute inset-0 z-0 bg-stars opacity-40"></div>
            <div className="absolute top-0 right-0 w-[600px] h-[600px] bg-secondary/20 blur-[130px] rounded-full pointer-events-none"></div>
            <div className="absolute bottom-0 left-0 w-[700px] h-[700px] bg-primary/10 blur-[130px] rounded-full pointer-events-none"></div>
            <div className="relative z-10 mx-auto max-w-6xl">
              <div className="flex items-end justify-between mb-16 border-b border-white/10 pb-6"><div><span className="text-secondary font-mono text-sm tracking-widest mb-2 block">SELECTED WORKS</span><h2 className="text-3xl font-bold text-white sm:text-4xl">Exploration Log</h2></div><a href="#" className="hidden sm:flex items-center gap-2 text-sm font-medium text-slate-400 hover:text-secondary transition-colors">Full Archive <span className="material-symbols-outlined text-[16px]">arrow_forward</span></a></div>
              <div className="grid grid-cols-1 gap-10 md:grid-cols-2 lg:grid-cols-3">
                {PROJECTS.map((project, idx) => (
                  <div key={idx} onClick={() => onOpenProject(project.id)} className={`group relative cursor-pointer overflow-hidden rounded-xl bg-[#0a0f14] border border-white/5 transition-all duration-300 hover:-translate-y-2 hover:border-${project.color === 'primary' ? 'primary' : 'secondary'}/50 hover:shadow-neon${project.color !== 'primary' ? '-purple' : ''}`}>
                    <div className="aspect-[4/3] w-full overflow-hidden relative"><div className="h-full w-full bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style={{ backgroundImage: `url('${project.image}')`, filter: 'brightness(0.8) contrast(1.2)' }}><div className="absolute inset-0 bg-gradient-to-t from-[#0a0f14] via-transparent to-transparent opacity-90"></div></div><div className={`absolute top-4 right-4 bg-${project.color === 'primary' ? 'primary' : 'purple-500'}/20 backdrop-blur-md border border-${project.color === 'primary' ? 'primary' : 'purple-500'}/30 text-${project.color === 'primary' ? 'primary' : 'purple-300'} text-xs font-bold px-3 py-1 rounded-full`}>{project.category}</div></div>
                    <div className="absolute bottom-0 left-0 w-full p-6"><h3 className={`text-xl font-bold text-white group-hover:text-${project.color} transition-colors`}>{project.title}</h3><p className="mt-2 text-sm text-slate-400 line-clamp-2">{project.description}</p><div className="mt-4 flex gap-2">{project.tags.map(tag => (<span key={tag} className="text-[10px] uppercase tracking-wider text-slate-500 font-mono">{tag}</span>))}</div></div>
                  </div>
                ))}
              </div>
            </div>
          </section>
        );
      };

      const About = () => {
        return (
          <section id="about" className="py-24 px-4 sm:px-6 lg:px-8 bg-[#050505] relative overflow-hidden">
            <div className="absolute top-0 right-0 w-[400px] h-[400px] bg-primary/10 blur-[100px] rounded-full pointer-events-none"></div>
            <div className="absolute bottom-0 left-0 w-[400px] h-[400px] bg-secondary/10 blur-[100px] rounded-full pointer-events-none"></div>
            <div className="mx-auto max-w-4xl relative z-10">
              <div className="mb-16 text-center"><h2 className="text-3xl font-bold text-white sm:text-4xl"><span className="text-primary">Tech</span> & <span className="text-secondary">Science</span> Stack</h2></div>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-16 items-center">
                <div className="space-y-6 order-2 md:order-1"><h3 className="text-xl font-bold text-white flex items-center gap-2"><span className="material-symbols-outlined text-secondary">science</span> Scientific Methodology</h3><p className="text-slate-400 leading-relaxed">I am driven by an unyielding curiosity to understand the mechanisms of our universe. I treat every project with extreme patience and carefulness, ensuring that every detail is accounted for.</p><div className="pt-4"><a href="#" className="inline-flex items-center text-white border-b border-primary pb-1 hover:text-primary transition-colors font-medium">Analyze Resume <span className="material-symbols-outlined ml-2 text-lg">download</span></a></div></div>
                <div className="grid grid-cols-2 gap-4 order-1 md:order-2">{TECH_STACK.map((tech) => (<div key={tech.title} className={`bg-surface-dark/50 backdrop-blur-sm p-5 rounded-lg border border-slate-800 hover:border-${tech.color.includes('primary') ? 'primary' : 'secondary'} transition-all group`}><span className={`material-symbols-outlined ${tech.color} mb-3 text-3xl group-hover:scale-110 transition-transform`}>{tech.icon}</span><h4 className="text-white font-bold text-sm uppercase tracking-wider">{tech.title}</h4><p className="text-xs text-slate-500 mt-1 font-mono">{tech.desc}</p></div>))}</div>
              </div>
            </div>
          </section>
        );
      };

      const Footer = () => {
        return (
          <footer className="border-t border-white/5 bg-void py-10 px-6 text-center">
            <p className="text-slate-600 text-sm font-mono">&copy; 2024 Thanh Huy. <span className="text-slate-700 mx-2">|</span> Built in the void with <span className="text-secondary">♥</span> and Tailwind CSS.</p>
          </footer>
        );
      };

      const App = () => {
        const [activeProject, setActiveProject] = useState(null);

        return (
          <main className="relative flex min-h-screen w-full flex-col">
            <Navbar />
            <Hero />
            <Projects onOpenProject={setActiveProject} />
            <About />
            <Contact />
            <Footer />

            {/* Overlays */}
            {activeProject === 'decay' && (
                <DecayChallenge onClose={() => setActiveProject(null)} />
            )}

            {activeProject === 'molecular' && (
                <MolecularViewer onClose={() => setActiveProject(null)} />
            )}
            
            {activeProject === 'eclipse' && (
                <EclipseSimulation onClose={() => setActiveProject(null)} />
            )}
          </main>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>